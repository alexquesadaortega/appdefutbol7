<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="theme-color" content="#0f172a">
<title>F√∫tbol 7 Pro - Ultimate Edition</title>

<link rel="icon" href="icono.png" sizes="32x32">
<link rel="apple-touch-icon" href="icono.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="/manifest.json">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;800&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* --- ESTILOS GENERALES --- */
:root { 
  --bg-dark: #0f172a;
  --bg-card: rgba(30, 41, 59, 0.7);
  --primary: #06b6d4;
  --accent: #a3e635;
  --text-main: #f8fafc;
  --text-muted: #94a3b8;
  --whatsapp: #25D366;
  --glass-border: 1px solid rgba(255, 255, 255, 0.1);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {  
  font-family: 'Inter', sans-serif;
  background-color: var(--bg-dark);
  background-image: radial-gradient(circle at top right, #1e293b 0%, #0f172a 100%);
  color: var(--text-main);
  margin: 0; 
  padding: 20px 15px 120px 15px;
  min-height: 10vh;
}
 
h1, h2, h3 { font-family: 'Kanit', sans-serif; margin-top: 0; letter-spacing: 0.5px; }
 
h1 { 
  font-weight: 800; font-size: 2rem; text-align: center; margin-bottom: 25px; 
  text-transform: uppercase;
  background: linear-gradient(to right, #22d3ee, #a3e635);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
}

h2 { font-size: 1.4rem; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
 
/* ESTILO CRISTAL */
.box { 
  background: var(--bg-card);
  backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
  border: var(--glass-border);
  padding: 20px; border-radius: 20px; margin-bottom: 24px; 
  box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
  animation: fadeIn 0.5s ease-out forwards;
}
 
/* INPUTS */
input, select { 
  padding: 14px; margin-bottom: 12px; border-radius: 12px; 
  border: 1px solid #334155; width: 100%; font-size: 16px; 
  background: #1e293b; color: #fff; transition: all 0.3s ease;
  font-family: 'Inter', sans-serif;
}
input:focus, select:focus { 
  border-color: var(--primary); box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.2); 
  outline: none; background: #0f172a;
}

.row-inputs { display: flex; gap: 10px; }
 
/* BOTONES */
button { 
  padding: 16px; border-radius: 12px; border: none; cursor: pointer; 
  font-family: 'Kanit', sans-serif; font-weight: 600; font-size: 1rem; 
  text-transform: uppercase; letter-spacing: 1px; width: 100%; margin-top: 10px; 
  transition: transform 0.1s;
}
button:active { transform: scale(0.97); }
button:disabled { opacity: 0.5; cursor: not-allowed; }

button.primary { 
  background: linear-gradient(135deg, var(--primary) 0%, #3b82f6 100%); 
  color: #fff; box-shadow: 0 4px 15px rgba(6, 182, 212, 0.4);
}
button.secondary { background: #334155; color: var(--accent); border: 1px solid rgba(163, 230, 53, 0.2); }
button.whatsapp { 
  background: var(--whatsapp); color: #fff; display: flex; align-items: center; justify-content: center; gap: 10px; 
  box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
}
button.outline { 
  background: transparent; border: 1px solid var(--primary); color: var(--primary); 
  font-size: 0.8rem; padding: 6px 12px; width: auto; margin: 0;
}
button.select-btn.selected { background: var(--accent); color: #000; border: 1px solid var(--accent); }

/* LISTAS Y TARJETAS */
.player-row { 
  display: flex; justify-content: space-between; align-items: center; 
  padding: 12px; margin-bottom: 8px; background: rgba(255,255,255,0.03); 
  border-radius: 10px; border: 1px solid transparent;
}
.p-select { width: 22px; height: 22px; margin-right: 12px; accent-color: var(--accent); }
.tag { padding: 4px 8px; border-radius: 4px; font-size: 10px; text-transform: uppercase; font-weight: 800; margin-left: 5px; }
.tag.portero { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
.tag.defensa { background: rgba(16, 185, 129, 0.2); color: #34d399; }
.tag.delantero { background: rgba(239, 68, 68, 0.2); color: #f87171; }
.rating-badge { background: #0f172a; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-weight: bold; color: var(--accent); border: 2px solid #334155; font-size: 0.9rem; }

.option-card { 
  background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.05);
  border-radius: 16px; padding: 20px; margin-bottom: 20px; 
  transition: border 0.3s ease;
}
.team-columns { display: flex; flex-direction: column; gap: 20px; margin-top: 15px; } 
@media (min-width: 768px) { .team-columns { flex-direction: row; } }
.team-col ul { padding: 0; list-style: none; }
.team-col li { padding: 8px 0; border-bottom: 1px dashed #334155; display:flex; justify-content:space-between; font-size: 0.9rem; color: #cbd5e1; }

/* CAMPO DE F√öTBOL */
.field-container { display: flex; flex-direction: column; align-items: center; gap: 25px; background: #e2e8f0; padding: 20px; border-radius: 12px; margin-top: 10px; }
.full-field {
  position: relative; width: 320px; height: 600px; background-color: #369a43;
  background-image: linear-gradient(0deg, transparent 24%, rgba(255,255,255,.1) 25%, rgba(255,255,255,.1) 26%, transparent 27%, transparent 74%, rgba(255,255,255,.1) 75%, rgba(255,255,255,.1) 76%, transparent 77%, transparent), repeating-linear-gradient(0deg, rgba(0,0,0,0.05) 0px, rgba(0,0,0,0.05) 50px, transparent 50px, transparent 100px);
  border: 6px solid #fff; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); overflow: hidden; user-select: none;
}
.field-line-center { position: absolute; top: 50%; left: 0; width: 100%; height: 3px; background: rgba(255,255,255,0.8); }
.field-circle { position: absolute; top: 50%; left: 50%; width: 70px; height: 70px; border: 3px solid rgba(255,255,255,0.8); border-radius: 50%; transform: translate(-50%, -50%); }
.area-A { position: absolute; bottom: 0; left: 50%; width: 140px; height: 60px; border: 3px solid rgba(255,255,255,0.8); border-bottom: none; transform: translateX(-50%); background: rgba(255,255,255,0.1); }
.area-B { position: absolute; top: 0; left: 50%; width: 140px; height: 60px; border: 3px solid rgba(255,255,255,0.8); border-top: none; transform: translateX(-50%); background: rgba(255,255,255,0.1); }

.player-token {
  position: absolute; width: 42px; height: 42px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
  font-family: 'Kanit', sans-serif; font-size: 13px; font-weight: 800; z-index: 10; touch-action: none; 
  box-shadow: 0 4px 6px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255,255,255,0.3); transition: transform 0.1s, left 0.15s, top 0.15s;
}
/* Solo el m√≠ster puede arrastrar */
.player-token.draggable { cursor: grab; }
.player-token.draggable:active { cursor: grabbing; transform: scale(1.2); z-index: 100; }

.token-black { background: radial-gradient(circle at 30% 30%, #374151, #111827); color: #fff; border: 2px solid #fff; }
.token-white { background: radial-gradient(circle at 30% 30%, #fff, #e5e7eb); color: #111827; border: 2px solid #111827; }
.player-label { position: absolute; bottom: -22px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); color: #fff; padding: 2px 8px; border-radius: 8px; font-size: 10px; white-space: nowrap; font-weight: 600; pointer-events: none; }

/* MODAL DE CONFIRMACI√ìN */
.modal-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px);
  display: flex; justify-content: center; align-items: center; z-index: 2000;
}
.modal-content {
  background: #1e293b; border: 1px solid var(--accent);
  padding: 30px; border-radius: 20px; max-width: 90%; width: 350px; text-align: center;
  box-shadow: 0 0 30px rgba(163, 230, 53, 0.2); animation: fadeIn 0.2s ease-out;
}

.hidden { display: none !important; }
.error-msg { background: rgba(239,68,68,0.2); color: #fca5a5; padding: 12px; border-radius: 8px; border: 1px solid rgba(239,68,68,0.4); margin-top: 10px; display: none; text-align: center; }
.sticky-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
.btn-group { display: flex; gap: 8px; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<h1>F√∫tbol 7 <span style="color:#fff; -webkit-text-fill-color: initial;">Pro</span></h1>

<div class="box" id="authBox" style="text-align: center;">
  <h2>Bienvenido M√≠ster</h2>
  <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:20px;">Gestiona tu equipo como un profesional.</p>
  <input id="authEmail" type="email" placeholder="Correo electr√≥nico">
  <input id="authPassword" type="password" placeholder="Contrase√±a">
  <button id="btnLogin" class="primary">Iniciar Sesi√≥n</button>
  <button id="btnRegister" class="secondary" style="margin-top:15px; background:transparent;">Registrarse</button>
  <div id="authMsg" style="margin-top:15px; font-size:0.8rem; min-height:20px;"></div>
</div>

<div class="box hidden" id="playerLobby" style="text-align: center; border: 1px solid var(--accent);">
  <h2 style="color: var(--accent);">üó≥Ô∏è Votaci√≥n de Equipos</h2>
  <p id="lobbyStatus" style="font-size:0.9rem;">Introduce tu c√≥digo y vota por el mejor equilibrio.</p>
  
  <div id="playerAuthForm">
    <input id="playerCodeInput" placeholder="Tu C√≥digo (Ej. ALEX91)" style="text-align:center;">
    <button id="btnAuthPlayer" class="secondary" style="margin-top:5px;">üîç Buscar Ficha</button>

    <div id="playerFound" class="hidden" style="margin-top:15px; background:rgba(163, 230, 53, 0.1); padding:15px; border-radius:12px;">
      <p style="color:#0f172a;">üëã ¬°Hola, <strong id="foundPlayerName" style="color:#1e293b;">Jugador</strong>!</p>
      <button id="btnEnterVoting" class="primary" style="background: var(--accent); color: #000; font-size:1.1rem; margin-top:10px;">‚û°Ô∏è Entrar a Votar</button>
    </div>
  </div>

  <div id="votingView" class.="hidden">
    <h3 style="color: var(--primary);">Opciones del M√≠ster</h3>
    <p id="votingHeader" style="font-size:0.85rem; color:var(--text-muted);">Mira como van los votos y elige tu favorita.</p>
    <div id="votingOptionsContainer"></div>
  </div>
</div>

<div id="voteConfirmModal" class="modal-overlay hidden">
  <div class="modal-content">
    <h3 style="color: var(--accent); margin-top:0;">‚ö†Ô∏è Confirmar Voto</h3>
    <p style="color: #cbd5e1;">Vas a votar por la <strong id="confirmOptionName" style="color: #fff;">Opci√≥n X</strong>.</p>
    <p style="font-size:0.85rem; color: #94a3b8;">¬øEst√°s seguro? No podr√°s cambiarlo.</p>
    
    <div class="btn-group" style="margin-top:20px;">
      <button id="btnCancelVote" class="secondary" style="background: transparent; border: 1px solid #64748b; color: #cbd5e1;">Cancelar</button>
      <button id="btnDoVote" class="primary" style="background: var(--accent); color: #000;">S√≠, Votar</button>
    </div>
  </div>
</div>


<div id="appContent" class="hidden">
  
  <div class="box" id="addPlayerBox">
    <h2>üë§ Nuevo Fichaje</h2>
    <p style="font-size:0.85rem; color:var(--text-muted);">El c√≥digo se genera autom√°ticamente.</p>
    <div class="row-inputs">
      <input id="playerName" placeholder="Nombre (ej. Lamine)" style="flex: 2;">
      <input id="playerSkill" type="number" placeholder="Nota" inputmode="decimal" step="0.1" style="flex: 1; text-align:center;">
    </div>
    <select id="playerPosition">
        <option value="portero">üß§ Portero</option>
        <option value="defensa">üõ°Ô∏è Defensa</option>
        <option value="delantero">‚ö° Delantero</option>
    </select>
    <button id="btnAddPlayer" class="secondary">‚ûï A√±adir a plantilla</button>
  </div>

  <div class="box" id="playerListBox">
    <div class="sticky-header">
        <h3 style="margin:0; color:var(--primary);">Convocatoria <span id="playerCount" style="color:var(--text-muted); font-size:0.9rem;"></span></h3>
        <div class="btn-group">
            <button id="btnSelectAll" class="outline" style="border-color:var(--accent); color:var(--accent);">Marcar Todos</button>
            <button id="btnDeselectAll" class="outline" style="border-color:#f1f5f9; color:#f1f5f9;">Desmarcar Todos</button> 
        </div>
    </div>
    <div id="playersList"></div>
  </div>

  <div class="box" id="matchControlBox" style="border: 1px solid var(--primary);">
    <h2 style="color: var(--primary);" id="matchControlTitle">‚ö° Generar Partido</h2>
    <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:15px;" id="matchControlSubtitle">
        Genera 5 opciones para seleccionar las 3 mejores para la votaci√≥n.
    </p>
    
    <button id="btnGenerateTeams" class="primary" style="font-size: 1.1rem; box-shadow: 0 0 20px rgba(6,182,212,0.3);">üé≤ Generar 5 Opciones de Equipo</button>
    <div id="generateError" class="error-msg"></div>

    <div id="teamsResult" style="margin-top:20px;"></div>
  </div>

  <div id="fieldSection" class="box hidden" style="background: #f1f5f9; color: #1e293b;">
    <h2 style="text-align:center; color:#1e293b;">Pizarra T√°ctica (Campo Unificado)</h2>
    <p style="text-align:center; font-size:0.8rem; color:#64748b; margin-bottom:15px;" id="fieldStatusMessage">Mueve las fichas y comparte la imagen.</p>
    
    <div class="field-container" id="captureArea">
      <div id="fullField" class="full-field">
          <div class="field-line-center"></div>
          <div class="field-circle"></div>
          <div class="area-A"></div> <div class="area-B"></div> </div>
      <div style="width: 100%; display: flex; justify-content: space-between; padding: 0 10px;">
          <div style="background:#111827; color:white; padding:6px 15px; border-radius:20px; font-weight:bold; font-family:'Kanit'; font-size:0.8rem;">EQUIPO NEGRO</div>
          <div style="background:#fff; color:#111827; border:2px solid #111827; padding:6px 15px; border-radius:20px; font-weight:bold; font-family:'Kanit'; font-size:0.8rem;">EQUIPO BLANCO</div>
      </div>
    </div>

    <div style="position:sticky; bottom:0; background:transparent; padding:15px 0; z-index:100;">
        <button id="btnShareWhatsapp" class="whatsapp">üì≤ Enviar Alineaci√≥n</button>
    </div>
  </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // --- CONFIGURACI√ìN SUPABASE ---
  // ! CAMBIA ESTOS DATOS POR LOS TUYOS DE SUPABASE
  const SUPABASE_URL = 'https://vayholflhqoyflbvuusa.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZayhvbGZsaHFveWZsYnZ1dXNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNzc5NjcsImV4cCI6MjA3ODY1Mzk2N30.QxD4_XbYlQarPRUcmoQQclw8cCnnzRiHZcYzSsUXGDA';
  let supabase;
  try { supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch (e) { console.error("Error Supabase", e); }

  // Variables de Estado
  let allPlayers = [];
  let currentUser = null;
  let currentMatchId = null; 
  let activePlayerId = null; 
  let activePlayerData = null; 
  let allVotes = []; // Guardar votos en vivo
  
  let generatedOptions = []; 
  let selectedVotingOptions = []; 
  let pendingVoteIndex = null; // Para la confirmaci√≥n

  // Para el debounce de la pizarra
  let saveFormationTimeout = null; 
  const SAVE_DEBOUNCE_TIME = 500; 

  const urlParams = new URLSearchParams(window.location.search);
  const matchLinkID = urlParams.get('match_id'); 

  // --- ELEMENTOS DOM ---
  const authBox = document.getElementById('authBox');
  const appContent = document.getElementById('appContent');
  const addPlayerBox = document.getElementById('addPlayerBox'); 
  const playerListBox = document.getElementById('playerListBox'); 
  const matchControlBox = document.getElementById('matchControlBox'); 
  const authMsg = document.getElementById('authMsg');
  const playersListEl = document.getElementById('playersList');
  const generateError = document.getElementById('generateError');
  const btnShare = document.getElementById('btnShareWhatsapp');
  const fullField = document.getElementById('fullField'); 

  // DOM Jugador y Modales
  const playerLobby = document.getElementById('playerLobby');
  const playerCodeInput = document.getElementById('playerCodeInput');
  const btnAuthPlayer = document.getElementById('btnAuthPlayer');
  const btnEnterVoting = document.getElementById('btnEnterVoting'); 
  
  // Modal Confirmaci√≥n
  const voteConfirmModal = document.getElementById('voteConfirmModal');
  const btnCancelVote = document.getElementById('btnCancelVote');
  const btnDoVote = document.getElementById('btnDoVote');
  
  // Contenedor de Opciones de Votaci√≥n (para jugador y m√≠ster)
  const votingOptionsContainer = document.getElementById('votingOptionsContainer');

  // --- EVENTOS ---
  document.getElementById('btnRegister').addEventListener('click', () => handleAuth('signup'));
  document.getElementById('btnLogin').addEventListener('click', () => handleAuth('signin'));
  document.getElementById('btnAddPlayer').addEventListener('click', addPlayer);
  document.getElementById('btnGenerateTeams').addEventListener('click', generateTeamOptions);
  document.getElementById('btnSelectAll').addEventListener('click', selectAllPlayers);
  document.getElementById('btnDeselectAll').addEventListener('click', deselectAllPlayers);
  btnShare.addEventListener('click', shareFieldsImage);

  if(btnAuthPlayer) btnAuthPlayer.addEventListener('click', searchPlayerByCode);
  if(btnEnterVoting) btnEnterVoting.addEventListener('click', enterVoting); 
  
  // Eventos Modal Voto
  btnCancelVote.addEventListener('click', () => { voteConfirmModal.classList.add('hidden'); pendingVoteIndex = null; });
  btnDoVote.addEventListener('click', executeVote);

  // --- INICIALIZACI√ìN ---
  supabase.auth.getSession().then(({ data: { session } }) => {
      currentUser = session ? session.user : null;

      if (matchLinkID) {
          if (session) {
              initCoachControlRoom(matchLinkID);
          } else {
              authBox.style.display = 'none';
              appContent.style.display = 'none';
              playerLobby.classList.remove('hidden');
              currentMatchId = matchLinkID;
          }
      } else {
          if (session) initApp();
      }
  });

  // --- FUNCIONES UTILIDAD ---
  function selectAllPlayers() { document.querySelectorAll('.p-select').forEach(c => c.checked = true); }
  function deselectAllPlayers() { document.querySelectorAll('.p-select').forEach(c => c.checked = false); } 
  function showMsg(txt) { authMsg.textContent = txt; }
  function generatePlayerCode(name) {
      const cleanName = name.trim().toUpperCase().replace(/[^A-Z0-9]/g, '');
      const shortName = cleanName.substring(0, Math.min(cleanName.length, 4));
      const randomNum = Math.floor(10 + Math.random() * 89);
      return `${shortName}${randomNum}`;
  }
  function renderListSimple(t) { return [...t].map(p=>`<li><span>${p.name}</span></li>`).join(''); }
  
  // --- AUTH (COACH) ---
  async function handleAuth(type) { 
    const email = document.getElementById('authEmail').value.trim();
    const password = document.getElementById('authPassword').value;
    
    authMsg.style.color = '#94a3b8';
    if (!email || !password) return showMsg('‚ö†Ô∏è Rellena los datos');
    
    showMsg('‚è≥ Conectando...');
    let res = type === 'signup' ? await supabase.auth.signUp({ email, password }) : await supabase.auth.signInWithPassword({ email, password });

    if (res.error) {
        authMsg.style.color = '#ef4444';
        showMsg(res.error.message);
    } else { 
        currentUser = res.data.user; 
        showMsg('‚úÖ ¬°Vamos!'); 
        setTimeout(initApp, 500);
    }
  }
  
  async function initApp() { 
      authBox.style.display = 'none'; 
      appContent.classList.remove('hidden'); 
      appContent.style.display = 'block'; 
      if(addPlayerBox) addPlayerBox.style.display = 'block';
      if(playerListBox) playerListBox.style.display = 'block';
      document.getElementById('matchControlTitle').textContent = '‚ö° Generar Partido';
      document.getElementById('matchControlSubtitle').textContent = 'Genera 5 opciones para seleccionar las 3 mejores para la votaci√≥n.';
      document.getElementById('btnGenerateTeams').style.display = 'block';
      document.getElementById('teamsResult').innerHTML = ''; 
      await loadPlayers(); 
  }

  // --- SALA DE CONTROL DEL M√çSTER ---
  async function initCoachControlRoom(matchId) {
    currentMatchId = matchId;
    authBox.style.display = 'none';
    playerLobby.style.display = 'none';
    appContent.classList.remove('hidden');
    appContent.style.display = 'block'; 

    if(addPlayerBox) addPlayerBox.style.display = 'none';
    if(playerListBox) playerListBox.style.display = 'none';
    document.getElementById('btnGenerateTeams').style.display = 'none';
    
    const { data: match, error } = await supabase
        .from('matches')
        .select('teams_options, status, final_teams_result, current_formation')
        .eq('id', currentMatchId)
        .eq('coach_id', currentUser.id)
        .single();
        
    if (error || !match) {
        alert("Error cargando la sala de control. Redirigiendo.");
        initApp(); 
        window.history.replaceState(null, null, window.location.pathname); 
        return;
    }
    
    document.getElementById('matchControlTitle').textContent = 'üìä Sala de Control';
    document.getElementById('matchControlSubtitle').textContent = 'Votaci√≥n en curso. Revisa los resultados en tiempo real.';

    if (match.status === 'final' && match.final_teams_result) {
        // Pizarra para el M√≠ster
        showPlayerResult(match.final_teams_result, true, match.current_formation); 
        listenToFieldChanges(); // El m√≠ster tambi√©n escucha para reactivar la sincronizaci√≥n
        return;
    }

    if (match.status === 'voting' && match.teams_options && match.teams_options.length === 3) {
        generatedOptions = match.teams_options.concat(new Array(2).fill(null));
        selectedVotingOptions = [0, 1, 2]; 
        displayControlRoomOptions(match.teams_options); 
        listenToVotes(); 
    }
  }

  // --- FUNCIONES DE LA PIZARRA EN TIEMPO REAL ---

  // 1. EL M√çSTER GUARDA LA POSICI√ìN (PUBLISHER)
  async function saveFormation() {
      const tokens = document.querySelectorAll('.player-token');
      const formationData = Array.from(tokens).map(token => ({
          playerId: token.dataset.playerId,
          x: parseFloat(token.style.left.replace('px', '')),
          y: parseFloat(token.style.top.replace('px', ''))
      }));
      
      const { error } = await supabase
          .from('matches')
          .update({ current_formation: formationData })
          .eq('id', currentMatchId);
      
      if (error) console.error("Error al guardar formaci√≥n:", error);
  }

  // 2. ESCUCHA DE CAMBIOS DE POSICI√ìN (SUBSCRIBER)
  function listenToFieldChanges() {
      supabase.removeChannel(supabase.channel('field-sync'));
      supabase.channel('field-sync')
      .on('postgres_changes', { 
          event: 'UPDATE', 
          schema: 'public', 
          table: 'matches', 
          filter: `id=eq.${currentMatchId}` 
      }, payload => {
          if (payload.new.current_formation) {
              updateFieldDisplay(payload.new.current_formation);
          }
      }).subscribe();
  }

  // 3. ACTUALIZAR POSICI√ìN EN PANTALLA
  function updateFieldDisplay(formationData) {
      if (!formationData || !Array.isArray(formationData)) return;

      formationData.forEach(data => {
          const token = document.querySelector(`.player-token[data-player-id="${data.playerId}"]`);
          if (token) {
              // Aplicar posici√≥n con una peque√±a transici√≥n CSS
              token.style.left = data.x + 'px';
              token.style.top = data.y + 'px';
          }
      });
  }

  // --- DRAG AND DROP ACTUALIZADO ---
  let activeItem = null; 
  let isDragging = false;

  function startDrag(e) {
    if (!currentUser) return; // Solo el m√≠ster puede arrastrar

    const evt = e.type === 'touchstart' ? e.touches[0] : e;
    activeItem = e.currentTarget;
    isDragging = true;
    const rect = activeItem.getBoundingClientRect();
    const offsetX = evt.clientX - rect.left;
    const offsetY = evt.clientY - rect.top;
    
    const moveHandler = (ev) => {
        ev.preventDefault(); 
        const mv = ev.type === 'touchmove' ? ev.touches[0] : ev;
        const parentRect = activeItem.parentElement.getBoundingClientRect();
        let newLeft = mv.clientX - parentRect.left - offsetX;
        let newTop = mv.clientY - parentRect.top - offsetY;

        // Limitar movimiento dentro del campo (320x600, token 42x42)
        newLeft = Math.max(0, Math.min(newLeft, 320 - 42));
        newTop = Math.max(0, Math.min(newTop, 600 - 42));

        activeItem.style.left = newLeft + 'px'; activeItem.style.top = newTop + 'px';
        
        // Debounce para guardar la posici√≥n mientras se arrastra (opcional, menos writes)
        // clearTimeout(saveFormationTimeout);
        // saveFormationTimeout = setTimeout(saveFormation, 100); 
    };
    
    const upHandler = () => {
        document.removeEventListener('mousemove', moveHandler); document.removeEventListener('mouseup', upHandler);
        document.removeEventListener('touchmove', moveHandler); document.removeEventListener('touchend', upHandler);
        activeItem = null;
        isDragging = false;
        
        // **GUARDA LA POSICI√ìN FINAL AL SOLTAR**
        clearTimeout(saveFormationTimeout);
        saveFormationTimeout = setTimeout(saveFormation, SAVE_DEBOUNCE_TIME);
    };
    
    document.addEventListener('mousemove', moveHandler); document.addEventListener('mouseup', upHandler);
    document.addEventListener('touchmove', moveHandler, {passive:false}); document.addEventListener('touchend', upHandler);
  }


  // --- RESTO DE FUNCIONES (Jugador, Voto, Listas) ---
  
  // ... (Funciones de Listas, Generaci√≥n de Equipos, etc. - Sin cambios)
  async function loadPlayers() { /* ... */ }
  async function addPlayer() { /* ... */ }
  async function deletePlayer(playerId) { /* ... */ }
  function renderList() { /* ... */ }
  function generateTeamOptions() { /* ... */ }
  function showError(msg) { /* ... */ }
  function shuffle(arr) { /* ... */ }
  function createStrictMatch(originalPool) { /* ... */ }
  function displayOptionsForSelection(options) { /* ... */ }
  function handleOptionSelection(e) { /* ... */ }
  function updatePublishButtonState() { /* ... */ }
  async function publishVotingOptions() { /* ... */ }
  function showShareModal(link) { /* ... */ }
  function showAdvancedAlert(link) { /* ... */ }
  function displayControlRoomOptions(options) { /* ... */ }

  // --- VOTOS EN TIEMPO REAL ---
  function listenToVotes() { /* ... */ }
  function updateVoteDisplay() { /* ... */ }
  function showFinalizeModal(voteCounts) { /* ... */ }
  
  window.finalizeTeam = async function (winningIndex) { 
      const winningOption = generatedOptions[winningIndex];
      // Aqu√≠ se inicializa la formaci√≥n al finalizar
      const initialFormation = createInitialFormationData(winningOption); 
      
      const { error } = await supabase.from('matches').update({ status: 'final', final_teams_result: winningOption, current_formation: initialFormation }).eq('id', currentMatchId);
      if (error) return alert("Error finalizando.");
      document.getElementById('teamsResult').innerHTML = ''; 
      showPlayerResult(winningOption, true, initialFormation); 
  }

  // --- MODO JUGADOR: B√öSQUEDA Y VOTO ---
  async function searchPlayerByCode() { /* ... */ }

  async function enterVoting() {
      document.getElementById('playerAuthForm').classList.add('hidden');
      document.getElementById('votingView').classList.remove('hidden');
      document.getElementById('lobbyStatus').textContent = "Vota tu favorita.";
      await fetchVotingOptions();
      listenToMatchStatus(true); 
      listenToVotes(); 
  }

  async function fetchVotingOptions() {
      const { data, error } = await supabase.from('matches').select('teams_options, status, final_teams_result, current_formation').eq('id', currentMatchId).single();
      
      if (data && data.status === 'final') { 
          // Si finaliz√≥, redirigir a la pizarra y empezar a escuchar
          showPlayerResult(data.final_teams_result, false, data.current_formation); 
          return; 
      }
      if (!data || !data.teams_options) {
          votingOptionsContainer.innerHTML = '<p>Esperando opciones...</p>';
          return;
      }
      
      const { data: voteData } = await supabase.from('match_votes').select('id').eq('match_id', currentMatchId).eq('player_id', activePlayerId).single();
      
      if (voteData) {
          renderReadOnlyVotingOptions(data.teams_options);
          document.getElementById('votingHeader').textContent = '‚úÖ VOTO REGISTRADO. Observa la tendencia en vivo.';
          return;
      }
      
      document.getElementById('votingHeader').textContent = 'Mira como van los votos y elige tu favorita.';
      renderVotingOptions(data.teams_options);
  }

  function renderVotingOptions(options) { /* ... */ }
  function renderReadOnlyVotingOptions(options) { /* ... */ }
  function initiateVote(e) { /* ... */ }
  async function executeVote() { /* ... */ }

  function listenToMatchStatus(initial) {
      supabase.channel('match-updates').on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'matches', filter: `id=eq.${currentMatchId}` }, payload => {
          if (payload.new.status === 'final') {
             // Redirigir a pizarra y pasarle la formaci√≥n inicial (o la √∫ltima guardada)
             showPlayerResult(payload.new.final_teams_result, !activePlayerId, payload.new.current_formation);
          }
          else if (initial && payload.new.status === 'voting') fetchVotingOptions();
      }).subscribe();
  }

  // --- DIBUJO Y DRAG (ACTUALIZADO PARA SINCRONIZACI√ìN) ---
  
  function createInitialFormationData(result) {
      const formationData = [];
      const teamA = result.teamA;
      const teamB = result.teamB;
      
      const coordsA = getInitialCoords('bottom', teamA);
      const coordsB = getInitialCoords('top', teamB);
      
      teamA.forEach((p, i) => formationData.push({ playerId: String(p.id), x: coordsA[i].x, y: coordsA[i].y }));
      teamB.forEach((p, i) => formationData.push({ playerId: String(p.id), x: coordsB[i].x, y: coordsB[i].y }));
      
      return formationData;
  }

  function getInitialCoords(half, team) {
    const isBottom = half === 'bottom';
    const coords = {
        portero: [{x:140, y: isBottom?520:40}], 
        defensa: [{x:50, y: isBottom?450:100}, {x:140, y: isBottom?450:100}, {x:230, y: isBottom?450:100}], 
        delantero: [{x:140, y: isBottom?350:200}] 
    };
    const playerCoords = [];
    
    team.forEach(p => {
       let pos = {x: 140, y: isBottom?300:250}; // Default/Substitute position
       if(coords[p.position] && coords[p.position].length) pos = coords[p.position].shift();
       playerCoords.push(pos);
    });
    return playerCoords;
  }
  
  function showPlayerResult(result, isCoach, initialFormation) {
      document.getElementById('playerLobby').style.display = 'none';
      appContent.classList.remove('hidden');
      appContent.style.display = 'block';
      
      if(!isCoach) {
          if(addPlayerBox) addPlayerBox.style.display = 'none';
          if(playerListBox) playerListBox.style.display = 'none';
      }
      if(matchControlBox) matchControlBox.style.display = 'none';

      const field = document.getElementById('fieldSection');
      field.classList.remove('hidden');
      field.style.display = 'block';
      
      const ph = document.getElementById('fullField');
      ph.querySelectorAll('.player-token').forEach(e=>e.remove());
      
      // Dibujar las fichas en la posici√≥n inicial (si no hay formaci√≥n guardada) o en la √∫ltima guardada
      const formation = initialFormation || createInitialFormationData(result);
      
      drawTeamOnUnifiedField(result.teamA, 'token-black', 'bottom', ph, isCoach, formation);
      drawTeamOnUnifiedField(result.teamB, 'token-white', 'top', ph, isCoach, formation);
      
      listenToFieldChanges(); // **EMPEZAR A ESCUCHAR CAMBIOS DE LA PIZARRA**
      
      if (!isCoach) {
          // L√≥gica para jugador (saber su equipo)
          document.getElementById('fieldStatusMessage').textContent = 'Observa la pizarra en tiempo real.';
          const isInTeamA = result.teamA.some(p => String(p.id) === String(activePlayerId));
          const isInTeamB = result.teamB.some(p => String(p.id) === String(activePlayerId));
          let teamColor = 'SUPLENTE';
          if (isInTeamA) teamColor = 'NEGRO';
          else if (isInTeamB) teamColor = 'BLANCO';
          
          let resultMessage = document.querySelector('#fieldSection h3.result-msg');
          if (!resultMessage) {
              resultMessage = document.createElement('h3');
              resultMessage.className = 'result-msg';
              resultMessage.style.textAlign = 'center';
              ph.before(resultMessage);
          }
          resultMessage.textContent = `¬°Est√°s en el EQUIPO ${teamColor}!`;
          document.getElementById('btnShareWhatsapp').style.display = 'none'; 
      } else {
          document.getElementById('fieldStatusMessage').textContent = 'Mueve las fichas y comparte la imagen.';
          document.getElementById('btnShareWhatsapp').style.display = 'flex'; 
      }
      
      field.scrollIntoView({behavior: "smooth"});
  }

  // Ahora usa la formaci√≥n guardada o inicial para posicionar las fichas
  function drawTeamOnUnifiedField(team, cls, half, target, isCoach, formation) { 
      team.forEach((p) => {
          const playerId = String(p.id);
          const pos = formation.find(f => f.playerId === playerId);
          
          if(pos) {
              createToken(p, target, cls, pos.x, pos.y, isCoach);
          }
      });
  }

  // Se a√±adi√≥ 'data-player-id' y la clase 'draggable'
  function createToken(p, div, cls, x, y, isCoach) {
    const el = document.createElement('div');
    el.className = `player-token ${cls} ${isCoach ? 'draggable' : ''}`;
    el.dataset.playerId = String(p.id); // **IMPORTANTE: ID del jugador**
    el.textContent = p.name.substring(0,2).toUpperCase();
    el.style.left = x+'px'; el.style.top = y+'px';
    const l = document.createElement('div'); l.className='player-label'; l.textContent=p.name;
    el.appendChild(l);
    
    // Solo el m√≠ster tiene los eventos de drag
    if(isCoach) { 
        el.addEventListener('mousedown', startDrag); 
        el.addEventListener('touchstart', startDrag, {passive:false}); 
    }
    div.appendChild(el);
  }

  async function shareFieldsImage() { /* ... */ }
});
</script>
</body>
</html>
