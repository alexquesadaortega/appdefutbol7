<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="theme-color" content="#0f172a">
<title>FÃºtbol 7 Pro - Ultimate Edition</title>

<link rel="icon" href="icono.png" sizes="32x32">
<link rel="apple-touch-icon" href="icono.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="/manifest.json">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;800&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* --- ESTILOS GENERALES --- */
:root {Â 
Â  --bg-dark: #0f172a;
Â  --bg-card: rgba(30, 41, 59, 0.7);
Â  --primary: #06b6d4;
Â  --accent: #a3e635;
Â  --text-main: #f8fafc;
Â  --text-muted: #94a3b8;
Â  --whatsapp: #25D366;
Â  --glass-border: 1px solid rgba(255, 255, 255, 0.1);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {Â Â 
Â  font-family: 'Inter', sans-serif;
Â  background-color: var(--bg-dark);
Â  background-image: radial-gradient(circle at top right, #1e293b 0%, #0f172a 100%);
Â  color: var(--text-main);
Â  margin: 0;Â 
Â  padding: 20px 15px 120px 15px;Â 
Â  min-height: 10vh;
}
body.final-match-view { padding-bottom: 20px; } /* Ajuste estÃ©tico para la vista final */
Â 
h1, h2, h3 { font-family: 'Kanit', sans-serif; margin-top: 0; letter-spacing: 0.5px; }
Â 
h1 {Â 
Â  font-weight: 800; font-size: 2rem; text-align: center; margin-bottom: 25px;Â 
Â  text-transform: uppercase;
Â  background: linear-gradient(to right, #22d3ee, #a3e635);
Â  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
Â  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
}

h2 { font-size: 1.4rem; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
Â 
/* ESTILO CRISTAL */
.box {Â 
Â  background: var(--bg-card);
Â  backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
Â  border: var(--glass-border);
Â  padding: 20px; border-radius: 20px; margin-bottom: 24px;Â 
Â  box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
Â  animation: fadeIn 0.5s ease-out forwards;
}
Â 
/* INPUTS */
input, select {Â 
Â  padding: 14px; margin-bottom: 12px; border-radius: 12px;Â 
Â  border: 1px solid #334155; width: 100%; font-size: 16px;Â 
Â  background: #1e293b; color: #fff; transition: all 0.3s ease;
Â  font-family: 'Inter', sans-serif;
}
input:focus, select:focus {Â 
Â  border-color: var(--primary); box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.2);Â 
Â  outline: none; background: #0f172a;
}

.row-inputs { display: flex; gap: 10px; }
Â 
/* BOTONES */
button {Â 
Â  padding: 16px; border-radius: 12px; border: none; cursor: pointer;Â 
Â  font-family: 'Kanit', sans-serif; font-weight: 600; font-size: 1rem;Â 
Â  text-transform: uppercase; letter-spacing: 1px; width: 100%; margin-top: 10px;Â 
Â  transition: transform 0.1s;
}
button:active { transform: scale(0.97); }
button:disabled { opacity: 0.5; cursor: not-allowed; }

button.primary {Â 
Â  background: linear-gradient(135deg, var(--primary) 0%, #3b82f6 100%);Â 
Â  color: #fff; box-shadow: 0 4px 15px rgba(6, 182, 212, 0.4);
}
button.secondary { background: #334155; color: var(--accent); border: 1px solid rgba(163, 230, 53, 0.2); }
button.whatsapp {Â 
Â  background: var(--whatsapp); color: #fff; display: flex; align-items: center; justify-content: center; gap: 10px;Â 
Â  box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
}
button.outline {Â 
Â  background: transparent; border: 1px solid var(--primary); color: var(--primary);Â 
Â  font-size: 0.8rem; padding: 6px 12px; width: auto; margin: 0;
}
button.select-btn.selected { background: var(--accent); color: #000; border: 1px solid var(--accent); }

/* LISTAS Y TARJETAS */
.player-row {Â 
Â  display: flex; justify-content: space-between; align-items: center;Â 
Â  padding: 12px; margin-bottom: 8px; background: rgba(255,255,255,0.03);Â 
Â  border-radius: 10px; border: 1px solid transparent;
}
.p-select { width: 22px; height: 22px; margin-right: 12px; accent-color: var(--accent); }
.tag { padding: 4px 8px; border-radius: 4px; font-size: 10px; text-transform: uppercase; font-weight: 800; margin-left: 5px; }
.tag.portero { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
.tag.defensa { background: rgba(16, 185, 129, 0.2); color: #34d399; }
.tag.delantero { background: rgba(239, 68, 68, 0.2); color: #f87171; }
.rating-badge { background: #0f172a; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-weight: bold; color: var(--accent); border: 2px solid #334155; font-size: 0.9rem; }

.option-card {Â 
Â  background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.05);
Â  border-radius: 16px; padding: 20px; margin-bottom: 20px;Â 
Â  transition: border 0.3s ease;
}
.team-columns { display: flex; flex-direction: column; gap: 20px; margin-top: 15px; }Â 
@media (min-width: 768px) { .team-columns { flex-direction: row; } }
.team-col { flex: 1; }
.team-col ul { padding: 0; list-style: none; margin-top: 5px; margin-bottom: 0; }
.team-col li { padding: 8px 0; border-bottom: 1px dashed #334155; display:flex; justify-content:space-between; font-size: 0.9rem; color: #cbd5e1; }
.team-col li:last-child { border-bottom: none; }

/* CAMPO DE FÃšTBOL */
.field-container { display: flex; flex-direction: column; align-items: center; gap: 25px; background: #e2e8f0; padding: 20px; border-radius: 12px; margin-top: 10px; }
.full-field {
Â  position: relative; width: 320px; height: 600px; background-color: #369a43;
Â  background-image: linear-gradient(0deg, transparent 24%, rgba(255,255,255,.1) 25%, rgba(255,255,255,.1) 26%, transparent 27%, transparent 74%, rgba(255,255,255,.1) 75%, rgba(255,255,255,.1) 76%, transparent 77%, transparent), repeating-linear-gradient(0deg, rgba(0,0,0,0.05) 0px, rgba(0,0,0,0.05) 50px, transparent 50px, transparent 100px);
Â  border: 6px solid #fff; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); overflow: hidden; user-select: none;
}
.field-line-center { position: absolute; top: 50%; left: 0; width: 100%; height: 3px; background: rgba(255,255,255,0.8); }
.field-circle { position: absolute; top: 50%; left: 50%; width: 70px; height: 70px; border: 3px solid rgba(255,255,255,0.8); border-radius: 50%; transform: translate(-50%, -50%); }
.area-A { position: absolute; bottom: 0; left: 50%; width: 140px; height: 60px; border: 3px solid rgba(255,255,255,0.8); border-bottom: none; transform: translateX(-50%); background: rgba(255,255,255,0.1); }
.area-B { position: absolute; top: 0; left: 50%; width: 140px; height: 60px; border: 3px solid rgba(255,255,255,0.8); border-top: none; transform: translateX(-50%); background: rgba(255,255,255,0.1); }

.player-token {
Â  position: absolute; width: 42px; height: 42px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
Â  font-family: 'Kanit', sans-serif; font-size: 13px; font-weight: 800; cursor: grab; z-index: 10; touch-action: none;Â 
Â  box-shadow: 0 4px 6px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255,255,255,0.3); transition: transform 0.1s, top 0.3s, left 0.3s;
}
.player-token:active { cursor: grabbing; transform: scale(1.2); z-index: 100; }
.player-token[style*="cursor: default"] { cursor: default !important; } /* Sobrescribir cursor para el jugador */
.token-black { background: radial-gradient(circle at 30% 30%, #374151, #111827); color: #fff; border: 2px solid #fff; }
.token-white { background: radial-gradient(circle at 30% 30%, #fff, #e5e7eb); color: #111827; border: 2px solid #111827; }
.player-label { position: absolute; bottom: -22px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); color: #fff; padding: 2px 8px; border-radius: 8px; font-size: 10px; white-space: nowrap; font-weight: 600; pointer-events: none; }

/* MODAL DE CONFIRMACIÃ“N */
.modal-overlay {
Â  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
Â  background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px);
Â  display: flex; justify-content: center; align-items: center; z-index: 2000;
}
.modal-content {
Â  background: #1e293b; border: 1px solid var(--accent);
Â  padding: 30px; border-radius: 20px; max-width: 90%; width: 350px; text-align: center;
Â  box-shadow: 0 0 30px rgba(163, 230, 53, 0.2); animation: fadeIn 0.2s ease-out;
}

.hidden { display: none !important; }
.error-msg { background: rgba(239,68,68,0.2); color: #fca5a5; padding: 12px; border-radius: 8px; border: 1px solid rgba(239,68,68,0.4); margin-top: 10px; display: none; text-align: center; }
.sticky-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
.btn-group { display: flex; gap: 8px; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<h1>FÃºtbol 7 <span style="color:#fff; -webkit-text-fill-color: initial;">Pro</span></h1>

<div class="box" id="authBox" style="text-align: center;">
Â  <h2>Bienvenido MÃ­ster</h2>
Â  <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:20px;">Gestiona tu equipo como un profesional.</p>
Â  <input id="authEmail" type="email" placeholder="Correo electrÃ³nico">
Â  <input id="authPassword" type="password" placeholder="ContraseÃ±a">
Â  <button id="btnLogin" class="primary">Iniciar SesiÃ³n</button>
Â  <button id="btnRegister" class="secondary" style="margin-top:15px; background:transparent;">Registrarse</button>
Â  <div id="authMsg" style="margin-top:15px; font-size:0.8rem; min-height:20px;"></div>
</div>

<div class="box hidden" id="playerLobby" style="text-align: center; border: 1px solid var(--accent);">
Â  <h2 style="color: var(--accent);">ğŸ—³ï¸ VotaciÃ³n de Equipos</h2>
Â  <p id="lobbyStatus" style="font-size:0.9rem;">Introduce tu cÃ³digo y vota por el mejor equilibrio.</p>
Â Â 
Â  <div id="playerAuthForm">
Â  Â  <input id="playerCodeInput" placeholder="Tu CÃ³digo (Ej. ALEX91)" style="text-align:center;">
Â  Â  <button id="btnAuthPlayer" class="secondary" style="margin-top:5px;">ğŸ” Buscar Ficha</button>

Â  Â  <div id="playerFound" class="hidden" style="margin-top:15px; background:rgba(163, 230, 53, 0.1); padding:15px; border-radius:12px;">
Â  Â  Â  <p style="color:#0f172a;">ğŸ‘‹ Â¡Hola, <strong id="foundPlayerName" style="color:#1e293b;">Jugador</strong>!</p>
Â  Â  Â  <button id="btnEnterVoting" class="primary" style="background: var(--accent); color: #000; font-size:1.1rem; margin-top:10px;">â¡ï¸ Entrar a Votar</button>
Â  Â  </div>
Â  </div>

Â  <div id="votingView" class="hidden">
Â  Â  <h3 style="color: var(--primary);">Opciones del MÃ­ster</h3>
Â  Â  <p id="votingHeader" style="font-size:0.85rem; color:var(--text-muted);">Mira como van los votos y elige tu favorita.</p>
Â  Â  <div id="votingOptionsContainer"></div>
Â  </div>
</div>

<div id="playerFinalView" class="hidden">
Â  <div class="box" id="finalResultBox" style="border: 1px solid var(--accent);">
Â  Â  Â  <h2 style="color: var(--accent);">ğŸ† AlineaciÃ³n Final</h2>
Â  Â  Â  <p style="font-size:0.9rem; color:var(--text-muted);">El MÃ­ster ha publicado los equipos y estÃ¡ ajustando la tÃ¡ctica en tiempo real.</p>
Â  Â  Â  <div id="finalTeamsResult"></div>
Â  </div>
</div>

<div id="appContent" class="hidden">
Â  <div class="box" id="addPlayerBox">
Â  Â  <h2>ğŸ‘¤ Nuevo Fichaje</h2>
Â  Â  <p style="font-size:0.85rem; color:var(--text-muted);">El cÃ³digo se genera automÃ¡ticamente.</p>
Â  Â  <div class="row-inputs">
Â  Â  Â  <input id="playerName" placeholder="Nombre (ej. Lamine)" style="flex: 2;">
Â  Â  Â  <input id="playerSkill" type="number" placeholder="Nota" inputmode="decimal" step="0.1" style="flex: 1; text-align:center;">
Â  Â  </div>
Â  Â  <select id="playerPosition">
Â  Â  Â  Â  <option value="portero">ğŸ§¤ Portero</option>
Â  Â  Â  Â  <option value="defensa">ğŸ›¡ï¸ Defensa</option>
Â  Â  Â  Â  <option value="delantero">âš¡ Delantero</option>
Â  Â  </select>
Â  Â  <button id="btnAddPlayer" class="secondary">â• AÃ±adir a plantilla</button>
Â  </div>

Â  <div class="box" id="playerListBox">
Â  Â  <div class="sticky-header">
Â  Â  Â  Â  <h3 style="margin:0; color:var(--primary);">Convocatoria <span id="playerCount" style="color:var(--text-muted); font-size:0.9rem;"></span></h3>
Â  Â  Â  Â  <div class="btn-group">
Â  Â  Â  Â  Â  Â  <button id="btnSelectAll" class="outline" style="border-color:var(--accent); color:var(--accent);">Marcar Todos</button>
Â  Â  Â  Â  Â  Â  <button id="btnDeselectAll" class="outline" style="border-color:#f1f5f9; color:#f1f5f9;">Desmarcar Todos</button>Â 
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div id="playersList"></div>
Â  </div>

Â  <div class="box" id="matchControlBox" style="border: 1px solid var(--primary);">
Â  Â  <h2 style="color: var(--primary);" id="matchControlTitle">âš¡ Generar Partido</h2>
Â  Â  <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:15px;" id="matchControlSubtitle">
Â  Â  Â  Â  Genera 5 opciones para seleccionar las 3 mejores para la votaciÃ³n.
Â  Â  </p>
Â  Â Â 
Â  Â  <button id="btnGenerateTeams" class="primary" style="font-size: 1.1rem; box-shadow: 0 0 20px rgba(6,182,212,0.3);">ğŸ² Generar 5 Opciones de Equipo</button>
Â  Â  <div id="generateError" class="error-msg"></div>

Â  Â  <div id="teamsResult" style="margin-top:20px;"></div>
Â  </div>
</div>

<div id="fieldSection" class="box hidden" style="background: #f1f5f9; color: #1e293b;">
Â  <h2 style="text-align:center; color:#1e293b;">Pizarra TÃ¡ctica <span id="fieldHeaderStatus"> (MÃ­ster)</span></h2>
Â  <p style="text-align:center; font-size:0.8rem; color:#64748b; margin-bottom:15px;" id="fieldSubtitle">Mueve las fichas y comparte la imagen.</p>
Â Â 
Â  <div class="field-container" id="captureArea">
Â  Â  <div id="fullField" class="full-field">
Â  Â  Â  Â  <div class="field-line-center"></div>
Â  Â  Â  Â  <div class="field-circle"></div>
Â  Â  Â  Â  <div class="area-A"></div> <div class="area-B"></div> </div>
Â  Â  <div style="width: 100%; display: flex; justify-content: space-between; padding: 0 10px;">
Â  Â  Â  Â  <div style="background:#111827; color:white; padding:6px 15px; border-radius:20px; font-weight:bold; font-family:'Kanit'; font-size:0.8rem;">EQUIPO NEGRO</div>
Â  Â  Â  Â  <div style="background:#fff; color:#111827; border:2px solid #111827; padding:6px 15px; border-radius:20px; font-weight:bold; font-family:'Kanit'; font-size:0.8rem;">EQUIPO BLANCO</div>
Â  Â  </div>
Â  </div>

Â  <div style="position:sticky; bottom:0; background:transparent; padding:15px 0; z-index:100;" id="shareContainer">
Â  Â  Â  <button id="btnShareWhatsapp" class="whatsapp">ğŸ“² Enviar AlineaciÃ³n</button>
Â  </div>
</div>

<div id="voteConfirmModal" class="modal-overlay hidden">
Â  <div class="modal-content">
Â  Â  <h3 style="color: var(--accent); margin-top:0;">âš ï¸ Confirmar Voto</h3>
Â  Â  <p style="color: #cbd5e1;">Vas a votar por la <strong id="confirmOptionName" style="color: #fff;">OpciÃ³n X</strong>.</p>
Â  Â  <p style="font-size:0.85rem; color: #94a3b8;">Â¿EstÃ¡s seguro? No podrÃ¡s cambiarlo.</p>
Â  Â Â 
Â  Â  <div class="btn-group" style="margin-top:20px;">
Â  Â  Â  <button id="btnCancelVote" class="secondary" style="background: transparent; border: 1px solid #64748b; color: #cbd5e1;">Cancelar</button>
Â  Â  Â  <button id="btnDoVote" class="primary" style="background: var(--accent); color: #000;">SÃ­, Votar</button>
Â  Â  </div>
Â  </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', () => {
Â  // --- CONFIGURACIÃ“N SUPABASE ---
Â  // ! CAMBIA ESTOS DATOS POR LOS TUYOS DE SUPABASE
Â  const SUPABASE_URL = 'https://vayholflhqoyflbvuusa.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZheWhvbGZsaHFveWZsYnZ1dXNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNzc5NjcsImV4cCI6MjA3ODY1Mzk2N30.QxD4_XbYlQarPRUcmoQQclw8cCnnzRiHZcYzSsUXGDA' ;
Â  let supabase;
Â  try { supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch (e) { console.error("Error Supabase", e); }

Â  // Variables de Estado
Â  let allPlayers = [];
Â  let currentUser = null;
Â  let currentMatchId = null;Â 
Â  let activePlayerId = null;Â 
Â  let activePlayerData = null;Â 
Â  let generatedOptions = [];Â 
Â  let selectedVotingOptions = [];Â 
Â  let pendingVoteIndex = null;
Â  let fieldSubscription = null;

Â  // Drag and Drop Variables
Â  let dragTarget = null;
Â  let fieldRect = null;

Â  const urlParams = new URLSearchParams(window.location.search);
Â  const matchLinkID = urlParams.get('match_id');Â 

Â  // --- ELEMENTOS DOM ---
Â  const body = document.body;
Â  const authBox = document.getElementById('authBox');
Â  const appContent = document.getElementById('appContent');
Â  const addPlayerBox = document.getElementById('addPlayerBox');Â 
Â  const playerListBox = document.getElementById('playerListBox');Â 
Â  const matchControlBox = document.getElementById('matchControlBox');Â 
Â  const playersListEl = document.getElementById('playersList');
Â  const fullField = document.getElementById('fullField');Â 
Â  const fieldSection = document.getElementById('fieldSection');

Â  // DOM Jugador
Â  const playerLobby = document.getElementById('playerLobby');
Â  const playerFinalView = document.getElementById('playerFinalView');
Â  const finalResultBox = document.getElementById('finalResultBox');
Â  const finalTeamsResultContainer = document.getElementById('finalTeamsResult');
Â  const shareContainer = document.getElementById('shareContainer');
Â  const btnShare = document.getElementById('btnShareWhatsapp');
Â  const playerCodeInput = document.getElementById('playerCodeInput');
Â  const btnAuthPlayer = document.getElementById('btnAuthPlayer');
Â  const btnEnterVoting = document.getElementById('btnEnterVoting');Â 
Â  const voteConfirmModal = document.getElementById('voteConfirmModal');
Â  const btnCancelVote = document.getElementById('btnCancelVote');
Â  const btnDoVote = document.getElementById('btnDoVote');
Â  const votingOptionsContainer = document.getElementById('votingOptionsContainer');
Â  const generateError = document.getElementById('generateError');


Â  // --- EVENTOS ---
Â  document.getElementById('btnRegister').addEventListener('click', () => handleAuth('signup'));
Â  document.getElementById('btnLogin').addEventListener('click', () => handleAuth('signin'));
Â  document.getElementById('btnAddPlayer').addEventListener('click', addPlayer);
Â  document.getElementById('btnGenerateTeams').addEventListener('click', generateTeamOptions);
Â  document.getElementById('btnSelectAll').addEventListener('click', selectAllPlayers);
Â  document.getElementById('btnDeselectAll').addEventListener('click', deselectAllPlayers);
Â  btnShare.addEventListener('click', shareFieldsImage);

Â  if(btnAuthPlayer) btnAuthPlayer.addEventListener('click', searchPlayerByCode);
Â  if(btnEnterVoting) btnEnterVoting.addEventListener('click', enterVoting);Â 
Â Â 
Â  // Eventos Modal Voto
Â  btnCancelVote.addEventListener('click', () => { voteConfirmModal.classList.add('hidden'); pendingVoteIndex = null; });
Â  btnDoVote.addEventListener('click', executeVote);

Â  // Eventos Drag (Pointer/Touch)
Â  fullField.addEventListener('pointerdown', handleDragStart);
Â  document.addEventListener('pointermove', handleDragMove);
Â  document.addEventListener('pointerup', handleDragEnd);

Â  // --- INICIALIZACIÃ“N ---
Â  supabase.auth.getSession().then(({ data: { session } }) => {
Â  Â  Â  currentUser = session ? session.user : null;

Â  Â  Â  if (matchLinkID) {
Â  Â  Â  Â  Â  if (session) {
Â  Â  Â  Â  Â  Â  Â  initCoachControlRoom(matchLinkID);
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  authBox.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  appContent.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  playerLobby.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  currentMatchId = matchLinkID;
Â  Â  Â  Â  Â  Â  Â  loadVotingStatus(); // Iniciar carga para el jugador (si ya estÃ¡ en final, mostrarÃ¡ la pizarra)
Â  Â  Â  Â  Â  }
Â  Â  Â  } else {
Â  Â  Â  Â  Â  if (session) initApp();
Â  Â  Â  }
Â  });

Â  // --- FUNCIONES UTILIDAD ---
Â  function selectAllPlayers() { document.querySelectorAll('.p-select').forEach(c => c.checked = true); }
Â  function deselectAllPlayers() { document.querySelectorAll('.p-select').forEach(c => c.checked = false); }Â 
Â  function showMsg(txt) { document.getElementById('authMsg').textContent = txt; }
Â  function generatePlayerCode(name) {
Â  Â  Â  const cleanName = name.trim().toUpperCase().replace(/[^A-Z0-9]/g, '');
Â  Â  Â  const shortName = cleanName.substring(0, Math.min(cleanName.length, 4));
Â  Â  Â  const randomNum = Math.floor(10 + Math.random() * 89);
Â  Â  Â  return `${shortName}${randomNum}`;
Â  }
Â  function renderListSimple(t) { return [...t].map(p=>`<li><span>${p.name}</span><span style="color:${p.team === 'black' ? '#94a3b8' : '#f1f5f9'};">${p.rating}</span></li>`).join(''); }
Â  function clearField() { document.querySelectorAll('.player-token').forEach(el => el.remove()); }
Â  function showError(msg) { generateError.textContent = msg; generateError.style.display = 'block'; }
Â  function shuffle(arr) { return [...arr].sort(() => Math.random() - 0.5); }
Â Â 
Â  // --- AUTH (COACH) ---
Â  async function handleAuth(type) {Â 
Â  Â  const email = document.getElementById('authEmail').value.trim();
Â  Â  const password = document.getElementById('authPassword').value;
Â  Â Â 
Â  Â  document.getElementById('authMsg').style.color = '#94a3b8';
Â  Â  if (!email || !password) return showMsg('âš ï¸ Rellena los datos');
Â  Â Â 
Â  Â  showMsg('â³ Conectando...');
Â  Â  let res = type === 'signup' ? await supabase.auth.signUp({ email, password }) : await supabase.auth.signInWithPassword({ email, password });

Â  Â  if (res.error) {
Â  Â  Â  Â  document.getElementById('authMsg').style.color = '#ef4444';
Â  Â  Â  Â  showMsg(res.error.message);
Â  Â  } else {Â 
Â  Â  Â  Â  currentUser = res.data.user;Â 
Â  Â  Â  Â  showMsg('âœ… Â¡Vamos!');Â 
Â  Â  Â  Â  setTimeout(initApp, 500);
Â  Â  }
Â  }
Â Â 
Â  async function initApp() {Â 
Â  Â  Â  authBox.style.display = 'none';Â 
Â  Â  Â  appContent.classList.remove('hidden');Â 
Â  Â  Â  appContent.style.display = 'block';Â 
Â  Â  Â  if(addPlayerBox) addPlayerBox.style.display = 'block';
Â  Â  Â  if(playerListBox) playerListBox.style.display = 'block';
Â  Â  Â  document.getElementById('matchControlTitle').textContent = 'âš¡ Generar Partido';
Â  Â  Â  document.getElementById('matchControlSubtitle').textContent = 'Genera 5 opciones para seleccionar las 3 mejores para la votaciÃ³n.';
Â  Â  Â  document.getElementById('btnGenerateTeams').style.display = 'block';
Â  Â  Â  document.getElementById('teamsResult').innerHTML = '';Â 
Â  Â  Â  fieldSection.classList.add('hidden');
Â  Â  Â  if(shareContainer) shareContainer.style.display = 'block'; // Asegurar visible para mÃ­ster

Â  Â  Â  await loadPlayers();Â 
Â  Â  Â  if(fieldSubscription) supabase.removeChannel(fieldSubscription);
Â  }

Â  // --- SALA DE CONTROL DEL MÃSTER ---
Â  async function initCoachControlRoom(matchId) {
Â  Â  currentMatchId = matchId;
Â  Â  authBox.style.display = 'none';
Â  Â  playerLobby.style.display = 'none';
Â  Â  playerFinalView.style.display = 'none'; // Asegurar que la vista del jugador estÃ¡ oculta
Â  Â  appContent.classList.remove('hidden');
Â  Â  appContent.style.display = 'block';Â 

Â  Â  if(addPlayerBox) addPlayerBox.style.display = 'none';
Â  Â  if(playerListBox) playerListBox.style.display = 'none';
Â  Â  document.getElementById('btnGenerateTeams').style.display = 'none';
Â  Â Â 
Â  Â  const { data: match, error } = await supabase
Â  Â  Â  Â  .from('matches')
Â  Â  Â  Â  .select('teams_options, status, final_teams_result, field_positions')
Â  Â  Â  Â  .eq('id', currentMatchId)
Â  Â  Â  Â  .eq('coach_id', currentUser.id)
Â  Â  Â  Â  .single();
Â  Â  Â  Â Â 
Â  Â  if (error || !match) {
Â  Â  Â  Â  alert("Error cargando la sala de control. Redirigiendo.");
Â  Â  Â  Â  initApp();Â 
Â  Â  Â  Â  window.history.replaceState(null, null, window.location.pathname);Â 
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  document.getElementById('matchControlTitle').textContent = 'ğŸ“Š Sala de Control';
Â  Â  document.getElementById('matchControlSubtitle').textContent = 'VotaciÃ³n en curso. Revisa los resultados en tiempo real.';

Â  Â  if (match.status === 'final' && match.final_teams_result) {
Â  Â  Â  Â  showPlayerResult(match.final_teams_result, true);Â  // Muestra la alineaciÃ³n final
Â  Â  Â  Â  loadFieldFromFinalTeams(match.final_teams_result.teamA, match.final_teams_result.teamB, true);
Â  Â  Â  Â  if (match.field_positions) applyFieldPositions(match.field_positions, true);
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  if (match.status === 'voting' && match.teams_options && match.teams_options.length === 3) {
Â  Â  Â  Â  generatedOptions = match.teams_options.concat(new Array(2).fill(null));
Â  Â  Â  Â  selectedVotingOptions = [0, 1, 2];Â 
Â  Â  Â  Â  displayControlRoomOptions(match.teams_options);Â 
Â  Â  Â  Â  // AquÃ­ podrÃ­as escuchar los votos, pero por simplicidad de este cÃ³digo, se omite.
Â  Â  }
Â  }

Â  // --- GESTIÃ“N DE JUGADORES (COACH) ---
Â  async function loadPlayers() {Â 
Â  Â  if (!currentUser) return;
Â  Â  const { data } = await supabase.from('players').select('*').eq('user_id', currentUser.id);
Â  Â  allPlayers = data || [];
Â  Â  renderList();
Â  }

Â  async function addPlayer() {Â 
Â  Â  const nameIn = document.getElementById('playerName');
Â  Â  const skillIn = document.getElementById('playerSkill');
Â  Â  const posIn = document.getElementById('playerPosition');
Â  Â  const name = nameIn.value.trim();
Â  Â  const rating = parseFloat(skillIn.value);
Â  Â  const position = posIn.value;

Â  Â  if (!name || !rating) return alert('Datos incompletos');
Â  Â  const playerCode = generatePlayerCode(name);Â 
Â  Â  const newPlayer = { user_id: currentUser.id, name, position, rating, player_code: playerCode };
Â  Â  const { data, error } = await supabase.from('players').insert([newPlayer]).select();
Â  Â Â 
Â  Â  if (error) { console.error(error); return alert('Error al guardar.'); }
Â  Â  if(data && data.length) { allPlayers.push(data[0]); nameIn.value = ''; skillIn.value = ''; renderList(); }
Â  }

Â  async function deletePlayer(playerId) {
Â  Â  Â  if (!playerId || !confirm("Â¿Eliminar jugador?")) return;
Â  Â  Â  const { error } = await supabase.from('players').delete().eq('id', String(playerId));
Â  Â  Â  if (error) return alert('Error al eliminar.');
Â  Â  Â  allPlayers = allPlayers.filter(p => String(p.id) !== String(playerId));
Â  Â  Â  renderList();
Â  }

Â  function renderList() {Â 
Â  Â  playersListEl.innerHTML = '';
Â  Â  document.getElementById('playerCount').textContent = `(${allPlayers.length})`;
Â  Â  const order = { portero: 1, defensa: 2, delantero: 3 };
Â  Â Â 
Â  Â  [...allPlayers].sort((a,b) => order[a.position] - order[b.position] || b.rating - a.rating).forEach(p => {
Â  Â  Â  const playerId = p.id;Â 
Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  div.className = 'player-row';
Â  Â  Â  div.innerHTML = `
Â  Â  Â  Â  <div style="display:flex; align-items:center;">
Â  Â  Â  Â  Â  <input type="checkbox" class="p-select" checked value="${p.id}">
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <span style="font-weight:600; font-size:1rem; color:#f1f5f9;">${p.name}</span>
Â  Â  Â  Â  Â  Â  Â  <span class="tag ${p.position}">${p.position}</span>
Â  Â  Â  Â  Â  Â  Â  <span class="tag" style="background:#334155; color:var(--accent); margin-left:10px; font-size:11px;">CÃ“DIGO: ${p.player_code || 'N/A'}</span>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="display:flex; align-items:center; gap: 10px;">
Â  Â  Â  Â  Â  Â  <div class="rating-badge">${p.rating}</div>
Â  Â  Â  Â  Â  Â  <button class="outline delete-btn" data-id="${playerId}" style="border-color:#ef4444; color:#ef4444; padding: 4px 8px; font-size:0.7rem; width: auto; margin:0;">ğŸ—‘ï¸</button>
Â  Â  Â  Â  </div>
Â  Â  Â  `;
Â  Â  Â  playersListEl.appendChild(div);
Â  Â  });
Â  Â  document.querySelectorAll('.delete-btn').forEach(button => button.addEventListener('click', (e) => deletePlayer(e.currentTarget.dataset.id)));
Â  }

Â  // --- GENERACIÃ“N Y SELECCIÃ“N (COACH) ---
Â  function createStrictMatch(originalPool) {
Â  Â  // ImplementaciÃ³n de la generaciÃ³n de equipos (omito el cuerpo por brevedad, asumo que es correcto)
Â  Â  const gks = shuffle(originalPool.filter(p => p.position === 'portero'));
Â  Â  const defs = shuffle(originalPool.filter(p => p.position === 'defensa'));
Â  Â  const fwds = shuffle(originalPool.filter(p => p.position === 'delantero'));
Â  Â  if(gks.length < 2 || defs.length < 6 || fwds.length < 2) return null;

Â  Â  const teamA = []; const teamB = [];
Â  Â  teamA.push(gks.pop()); teamB.push(gks.pop());Â  Â  Â  Â  Â  Â Â 
Â  Â  for(let k=0;k<3;k++) { teamA.push(defs.pop()); teamB.push(defs.pop()); }Â 
Â  Â  teamA.push(fwds.pop()); teamB.push(fwds.pop());Â  Â  Â  Â  Â  Â  Â 

Â  Â  let leftovers = [...gks, ...defs, ...fwds];Â 
Â  Â  leftovers = shuffle(leftovers);
Â  Â  while(leftovers.length > 0) {
Â  Â  Â  Â  if(teamA.length <= teamB.length) teamA.push(leftovers.pop());
Â  Â  Â  Â  else teamB.push(leftovers.pop());
Â  Â  }
Â  Â  const getAvg = t => t.reduce((a,c)=>a+c.rating,0) / t.length;
Â  Â  const avgA = getAvg(teamA); const avgB = getAvg(teamB);
Â  Â  return { teamA, teamB, avgA: avgA.toFixed(2), avgB: avgB.toFixed(2), diff: Math.abs(avgA - avgB) };
Â  }

Â  function generateTeamOptions() {Â 
Â  Â  generateError.style.display = 'none';
Â  Â  const checks = document.querySelectorAll('.p-select:checked');
Â  Â  const selectedIds = Array.from(checks).map(c => c.value);
Â  Â  const pool = allPlayers.filter(p => selectedIds.includes(String(p.id)));

Â  Â  if (pool.length < 14) { showError('Selecciona al menos 14 jugadores.'); return; }
Â  Â Â 
Â  Â  let variations = [];
Â  Â  for(let i=0; i<500; i++) {Â 
Â  Â  Â  Â  const attempt = createStrictMatch(pool);
Â  Â  Â  Â  if(attempt) variations.push(attempt);
Â  Â  }
Â  Â  variations.sort((a, b) => a.diff - b.diff);Â 
Â  Â  generatedOptions = variations.slice(0, 5);Â 

Â  Â  if (generatedOptions.length === 0) { showError("Error generando."); return; }
Â  Â Â 
Â  Â  selectedVotingOptions = [];Â 
Â  Â  displayOptionsForSelection(generatedOptions);Â 
Â  Â  updatePublishButtonState();
Â  }

Â  function displayOptionsForSelection(options) {
Â  Â  Â  const container = document.getElementById('teamsResult');
Â  Â  Â  container.innerHTML = `
Â  Â  Â  Â  Â  <h3 style="color:var(--accent); margin-top:20px;">Elige 3 Opciones</h3>
Â  Â  Â  Â  Â  <p id="selectionStatus" style="color:var(--text-muted); font-size:0.85rem;">Seleccionadas: 0/3</p>
Â  Â  Â  Â  Â  <div id="selectionOptionsContainer"></div>
Â  Â  Â  Â  Â  <button id="btnPublishOptions" class="secondary" style="margin-top:20px; font-size: 1.1rem;" disabled>ğŸš€ Publicar Opciones</button>
Â  Â  Â  `;
Â  Â  Â  const selectionContainer = document.getElementById('selectionOptionsContainer');
Â  Â  Â  options.forEach((opt, index) => {
Â  Â  Â  Â  Â  if (!opt) return;Â 
Â  Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  Â  div.className = 'option-card';
Â  Â  Â  Â  Â  div.id = `option-card-${index}`;Â 
Â  Â  Â  Â  Â  div.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 style="margin:0; color:var(--primary);">OpciÃ³n ${index + 1}</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="tag" style="background:#334155; color:#fff;">Dif: ${opt.diff}</span>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div class="team-columns">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="team-col"><strong style="color:#94a3b8">Negro (${opt.avgA})</strong><ul>${renderListSimple(opt.teamA)}</ul></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="team-col"><strong style="color:#f1f5f9">Blanco (${opt.avgB})</strong><ul>${renderListSimple(opt.teamB)}</ul></div>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <button class="select-btn secondary" data-index="${index}" style="margin-top:15px; width:100%;">â• Seleccionar</button>
Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  selectionContainer.appendChild(div);
Â  Â  Â  });
Â  Â  Â  document.querySelectorAll('.select-btn').forEach(btn => btn.addEventListener('click', handleOptionSelection));
Â  Â  Â  document.getElementById('btnPublishOptions').addEventListener('click', publishVotingOptions);
Â  }

Â  function handleOptionSelection(e) {
Â  Â  Â  const btn = e.currentTarget;
Â  Â  Â  const index = parseInt(btn.dataset.index);
Â  Â  Â  const card = document.getElementById(`option-card-${index}`);

Â  Â  Â  if (selectedVotingOptions.includes(index)) {
Â  Â  Â  Â  Â  selectedVotingOptions = selectedVotingOptions.filter(i => i !== index);
Â  Â  Â  Â  Â  btn.classList.remove('selected', 'primary'); btn.classList.add('secondary');
Â  Â  Â  Â  Â  btn.innerHTML = 'â• Seleccionar';
Â  Â  Â  Â  Â  card.style.border = '1px solid rgba(255,255,255,0.05)';
Â  Â  Â  } else {
Â  Â  Â  Â  Â  if (selectedVotingOptions.length >= 3) return alert("MÃ¡ximo 3 opciones.");
Â  Â  Â  Â  Â  selectedVotingOptions.push(index);
Â  Â  Â  Â  Â  btn.classList.add('selected', 'primary'); btn.classList.remove('secondary');
Â  Â  Â  Â  Â  btn.innerHTML = 'âœ… Seleccionada';
Â  Â  Â  Â  Â  card.style.border = '1px solid var(--accent)';
Â  Â  Â  }
Â  Â  Â  updatePublishButtonState();
Â  }

Â  function updatePublishButtonState() {
Â  Â  Â  const statusEl = document.getElementById('selectionStatus');
Â  Â  Â  const publishBtn = document.getElementById('btnPublishOptions');
Â  Â  Â  statusEl.textContent = `Seleccionadas: ${selectedVotingOptions.length}/3`;
Â  Â  Â Â 
Â  Â  Â  if (selectedVotingOptions.length === 3) {
Â  Â  Â  Â  Â  publishBtn.disabled = false; publishBtn.classList.add('primary'); publishBtn.classList.remove('secondary');
Â  Â  Â  } else {
Â  Â  Â  Â  Â  publishBtn.disabled = true; publishBtn.classList.remove('primary'); publishBtn.classList.add('secondary');
Â  Â  Â  }
Â  }
Â Â 
Â  async function publishVotingOptions() {
Â  Â  Â  if (selectedVotingOptions.length !== 3) return alert("Elige 3 opciones.");
Â  Â  Â  const publishBtn = document.getElementById('btnPublishOptions');
Â  Â  Â  publishBtn.innerHTML = 'â³ Publicando...'; publishBtn.disabled = true;
Â  Â  Â Â 
Â  Â  Â  const finalOptionsToPublish = selectedVotingOptions.map(index => generatedOptions[index]);

Â  Â  Â  if (!currentMatchId) {
Â  Â  Â  Â  Â  const { data, error } = await supabase.from('matches').insert([{ coach_id: currentUser.id, status: 'created' }]).select().single();
Â  Â  Â  Â  Â  if (error) { alert("Error creando sala."); return; }
Â  Â  Â  Â  Â  currentMatchId = data.id;
Â  Â  Â  }

Â  Â  Â  const { error } = await supabase.from('matches').update({ status: 'voting', teams_options: finalOptionsToPublish, final_teams_result: null }).eq('id', currentMatchId);
Â  Â  Â  if (error) { alert("Error publicando."); return; }

Â  Â  Â  const controlLink = `${window.location.origin}${window.location.pathname}?match_id=${currentMatchId}`;
Â  Â  Â  showShareModal(controlLink);
Â  Â  Â  setTimeout(() => { window.location.href = controlLink; }, 200);Â 
Â  }

Â  function showShareModal(link) {
Â  Â  Â  const msg = `âš½ Â¡A VOTAR! El MÃ­ster ha publicado los equipos: ${link}`;
Â  Â  Â  alert(`Enlace de votaciÃ³n: ${link}\n\nCompÃ¡rtelo por WhatsApp: ${msg}`);
Â  }

Â  // --- GESTIÃ“N DE VOTOS (MÃSTER Y JUGADOR) ---
Â  async function searchPlayerByCode() {
Â  Â  Â  const code = playerCodeInput.value.trim().toUpperCase();
Â  Â  Â  if (!code) return alert("Introduce tu cÃ³digo.");
Â  Â  Â Â 
Â  Â  Â  const { data, error } = await supabase.from('players').select('id, name, user_id').eq('player_code', code).single();
Â  Â  Â  if (error || !data) { return alert("CÃ³digo no encontrado."); }

Â  Â  Â  activePlayerId = data.id;
Â  Â  Â  activePlayerData = data;
Â  Â  Â  document.getElementById('foundPlayerName').textContent = data.name;
Â  Â  Â  document.getElementById('playerAuthForm').classList.add('hidden');
Â  Â  Â  document.getElementById('playerFound').classList.remove('hidden');
Â  }

Â  async function enterVoting() {
Â  Â  Â  document.getElementById('playerFound').classList.add('hidden');
Â  Â  Â  document.getElementById('votingView').classList.remove('hidden');
Â  Â  Â  loadVotingStatus();
Â  }

Â  async function loadVotingStatus() {
Â  Â  Â  const { data: match, error } = await supabase
Â  Â  Â  Â  Â  .from('matches')
Â  Â  Â  Â  Â  .select('teams_options, status, final_teams_result, field_positions, coach_id')
Â  Â  Â  Â  Â  .eq('id', currentMatchId)
Â  Â  Â  Â  Â  .single();

Â  Â  Â  if (error || !match) return alert("Partido no encontrado o error de carga.");

Â  Â  Â  // 1. MODO FINAL (JUGADOR): Muestra la pizarra y los resultados finales
Â  Â  Â  if (match.status === 'final' && match.final_teams_result) {
Â  Â  Â  Â  Â  playerLobby.style.display = 'none';
Â  Â  Â  Â  Â  playerFinalView.classList.remove('hidden');
Â  Â  Â  Â  Â  body.classList.add('final-match-view');

Â  Â  Â  Â  Â  showPlayerResult(match.final_teams_result, false);

Â  Â  Â  Â  Â  // Mover la pizarra dentro de la vista final del jugador
Â  Â  Â  Â  Â  finalResultBox.insertAdjacentElement('afterend', fieldSection);
Â  Â  Â  Â  Â  fieldSection.classList.remove('hidden');

Â  Â  Â  Â  Â  document.getElementById('fieldHeaderStatus').textContent = ' (AlineaciÃ³n Final)';
Â  Â  Â  Â  Â  document.getElementById('fieldSubtitle').textContent = 'El MÃ­ster estÃ¡ ajustando la tÃ¡ctica.';
Â  Â  Â  Â  Â  shareContainer.style.display = 'none'; // Ocultar el botÃ³n de compartir al jugador

Â  Â  Â  Â  Â  // Cargar y aplicar posiciones
Â  Â  Â  Â  Â  loadFieldFromFinalTeams(match.final_teams_result.teamA, match.final_teams_result.teamB, false);
Â  Â  Â  Â  Â  if (match.field_positions) applyFieldPositions(match.field_positions, false);
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  listenToFieldUpdates(); // Escucha los movimientos del mÃ­ster
Â  Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  // 2. MODO VOTACIÃ“N (JUGADOR)
Â  Â  Â  if (match.status === 'voting' && activePlayerId) {
Â  Â  Â  Â  Â  const { data: vote } = await supabase.from('votes').select('option_index').eq('match_id', currentMatchId).eq('player_id', activePlayerId).single();
Â  Â  Â  Â  Â  renderVotingOptions(match.teams_options, vote ? vote.option_index : null);
Â  Â  Â  }
Â  }

Â  async function executeVote() {
Â  Â  Â  voteConfirmModal.classList.add('hidden');
Â  Â  Â  if (pendingVoteIndex === null) return;
Â  Â  Â Â 
Â  Â  Â  const { error } = await supabase.from('votes').upsert({
Â  Â  Â  Â  Â  match_id: currentMatchId,
Â  Â  Â  Â  Â  player_id: activePlayerId,
Â  Â  Â  Â  Â  option_index: pendingVoteIndex
Â  Â  Â  });

Â  Â  Â  if (error) { alert("Error al registrar voto: " + error.message); }
Â  Â  Â  else { alert("âœ… Â¡Voto registrado!"); loadVotingStatus(); }
Â  Â  Â  pendingVoteIndex = null;
Â  }
Â  
Â  function renderVotingOptions(options, votedIndex) {
Â  Â  Â  votingOptionsContainer.innerHTML = '';
Â  Â  Â  options.forEach((opt, index) => {
Â  Â  Â  Â  Â  const isVoted = votedIndex !== null && votedIndex === index;
Â  Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  Â  div.className = 'option-card';
Â  Â  Â  Â  Â  if (isVoted) div.style.border = '1px solid var(--accent)';
Â  Â  Â  Â  Â  div.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 style="margin:0; color:var(--primary);">OpciÃ³n ${index + 1} ${isVoted ? ' (TÃº Voto)' : ''}</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="tag" style="background:#334155; color:#fff;">Dif: ${opt.diff}</span>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div class="team-columns">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="team-col"><strong style="color:#94a3b8">Negro (${opt.avgA})</strong><ul>${renderListSimple(opt.teamA)}</ul></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="team-col"><strong style="color:#f1f5f9">Blanco (${opt.avgB})</strong><ul>${renderListSimple(opt.teamB)}</ul></div>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <button class="${isVoted ? 'primary' : 'secondary'} select-vote-btn" data-index="${index}" ${isVoted ? 'disabled' : ''} style="margin-top:15px; width:100%;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isVoted ? 'ğŸ—³ï¸ YA HAS VOTADO' : 'VOTAR POR ESTA OPCIÃ“N'}
Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  votingOptionsContainer.appendChild(div);
Â  Â  Â  });
Â  Â  Â  document.querySelectorAll('.select-vote-btn').forEach(btn => btn.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  pendingVoteIndex = parseInt(e.currentTarget.dataset.index);
Â  Â  Â  Â  Â  document.getElementById('confirmOptionName').textContent = `OpciÃ³n ${pendingVoteIndex + 1}`;
Â  Â  Â  Â  Â  voteConfirmModal.classList.remove('hidden');
Â  Â  Â  }));
Â  }

Â  // FunciÃ³n MÃ­ster para mostrar el resultado final y el control
Â  function displayControlRoomOptions(options) {
Â  Â  Â  const container = document.getElementById('teamsResult');
Â  Â  Â  container.innerHTML = `
Â  Â  Â  Â  Â  <h3 style="color:var(--accent); margin-top:20px;">Opciones de VotaciÃ³n</h3>
Â  Â  Â  Â  Â  <p id="controlStatus" style="color:var(--text-muted); font-size:0.85rem;">Resultados en tiempo real (Recargar para ver).</p>
Â  Â  Â  Â  Â  <div id="controlOptionsContainer"></div>
Â  Â  Â  Â  Â  <button id="btnFinalizeMatch" class="primary" style="margin-top:20px; font-size: 1.1rem;">ğŸ† Cerrar VotaciÃ³n y Elegir Ganador</button>
Â  Â  Â  `;
Â  Â  Â  const controlContainer = document.getElementById('controlOptionsContainer');
Â  Â  Â  options.forEach((opt, index) => {
Â  Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  Â  div.className = 'option-card';
Â  Â  Â  Â  Â  div.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 style="margin:0; color:var(--primary);">OpciÃ³n ${index + 1}</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="tag" style="background:#334155; color:#fff;">Dif: ${opt.diff}</span>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div class="team-columns">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="team-col"><strong style="color:#94a3b8">Negro (${opt.avgA})</strong><ul>${renderListSimple(opt.teamA)}</ul></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="team-col"><strong style="color:#f1f5f9">Blanco (${opt.avgB})</strong><ul>${renderListSimple(opt.teamB)}</ul></div>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <button class="select-final-btn secondary" data-index="${index}" style="margin-top:15px; width:100%;">Elegir esta como Ganadora</button>
Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  controlContainer.appendChild(div);
Â  Â  Â  });

Â  Â  Â  document.querySelectorAll('.select-final-btn').forEach(btn => btn.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  const index = parseInt(e.currentTarget.dataset.index);
Â  Â  Â  Â  Â  if (confirm(`Â¿EstÃ¡s seguro de elegir la OpciÃ³n ${index + 1} como ganadora final? Esto cerrarÃ¡ la votaciÃ³n.`)) {
Â  Â  Â  Â  Â  Â  Â  publishFinalTeams(options[index]);
Â  Â  Â  Â  Â  }
Â  Â  Â  }));
Â  }

Â  // FunciÃ³n MÃ­ster/Jugador para mostrar el resultado final
Â  function showPlayerResult(result, isCoach) {
Â  Â  Â  const container = isCoach ? document.getElementById('teamsResult') : finalTeamsResultContainer;
Â  Â  Â  if (!isCoach) container.innerHTML = ''; 

Â  Â  Â  container.innerHTML = `
Â  Â  Â  Â  Â  <div class="option-card" style="border: none; background: transparent; padding:0;">
Â  Â  Â  Â  Â  Â  Â  <h4 style="margin:0; color:${isCoach ? 'var(--primary)' : 'var(--text-main)'}; font-size:1.1rem;">AlineaciÃ³n Seleccionada:</h4>
Â  Â  Â  Â  Â  Â  Â  <div class="team-columns">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="team-col"><strong style="color:#94a3b8">Negro (${result.avgA})</strong><ul>${renderListSimple(result.teamA)}</ul></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="team-col"><strong style="color:#f1f5f9">Blanco (${result.avgB})</strong><ul>${renderListSimple(result.teamB)}</ul></div>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  `;
Â  Â  Â  
Â  Â  Â  if (isCoach) {
Â  Â  Â  Â  Â  document.getElementById('matchControlBox').insertAdjacentElement('afterend', fieldSection);
Â  Â  Â  Â  Â  fieldSection.classList.remove('hidden');
Â  Â  Â  Â  Â  shareContainer.style.display = 'block';
Â  Â  Â  Â  Â  document.getElementById('matchControlSubtitle').textContent = 'Partido Finalizado. Mueve las fichas para ajustar la tÃ¡ctica.';
Â  Â  Â  }
Â  }


Â  // --- PIZARRA TÃCTICA Y REALTIME (COACH & PLAYER) ---

Â  async function publishFinalTeams(winningOption) {
Â  Â  Â  if (!currentMatchId) return alert("Error: No hay ID de partido activo.");
Â  Â  Â Â 
Â  Â  Â  const { error: updateError } = await supabase.from('matches').update({ status: 'final', final_teams_result: winningOption }).eq('id', currentMatchId);
Â  Â  Â  if (updateError) { return alert("Error al finalizar el partido."); }

Â  Â  Â  loadFieldFromFinalTeams(winningOption.teamA, winningOption.teamB, true);
Â  Â  Â  await saveFieldPositions();

Â  Â  Â  // Actualizar vista del MÃ­ster
Â  Â  Â  showPlayerResult(winningOption, true);
Â  }


Â  function loadFieldFromFinalTeams(teamA, teamB, isCoach) {
Â  Â  Â  clearField();
Â  Â  Â  const players = teamA.map(p => ({ ...p, team: 'black' })).concat(teamB.map(p => ({ ...p, team: 'white' })));

Â  Â  Â  // Posiciones iniciales por defecto (ejemplo 1-3-2-1)
Â  Â  Â  const positionsA = { portero: { x: 50, y: 90 }, defensa: [{ x: 20, y: 70 }, { x: 50, y: 70 }, { x: 80, y: 70 }], delantero: [{ x: 30, y: 35 }, { x: 70, y: 35 }], 'restante': { x: 50, y: 50 } };
Â  Â  Â  const positionsB = { portero: { x: 50, y: 10 }, defensa: [{ x: 20, y: 30 }, { x: 50, y: 30 }, { x: 80, y: 30 }], delantero: [{ x: 30, y: 65 }, { x: 70, y: 65 }], 'restante': { x: 50, y: 50 } };
Â  Â  Â Â 
Â  Â  Â  const countsA = { portero: 0, defensa: 0, delantero: 0, restante: 0 };
Â  Â  Â  const countsB = { portero: 0, defensa: 0, delantero: 0, restante: 0 };

Â  Â  Â  players.forEach(p => {
Â  Â  Â  Â  Â  let positionKey = p.position;
Â  Â  Â  Â  Â  let teamPositions, teamCounts, tokenClass;
Â  Â  Â  Â  Â  let isA = p.team === 'black';

Â  Â  Â  Â  Â  if (isA) { teamPositions = positionsA; teamCounts = countsA; tokenClass = 'token-black'; }
Â  Â  Â  Â  Â  else { teamPositions = positionsB; teamCounts = countsB; tokenClass = 'token-white'; }

Â  Â  Â  Â  Â  if (teamCounts[positionKey] === undefined || (Array.isArray(teamPositions[positionKey]) && teamCounts[positionKey] >= teamPositions[positionKey].length)) { 
Â  Â  Â  Â  Â  Â  Â  positionKey = 'restante';
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  let x, y;
Â  Â  Â  Â  Â  if (Array.isArray(teamPositions[positionKey])) {
Â  Â  Â  Â  Â  Â  Â  const index = teamCounts[positionKey] % teamPositions[positionKey].length;
Â  Â  Â  Â  Â  Â  Â  x = teamPositions[positionKey][index].x;
Â  Â  Â  Â  Â  Â  Â  y = teamPositions[positionKey][index].y;
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  // PosiciÃ³n base para restantes
Â  Â  Â  Â  Â  Â  Â  const baseOffset = isA ? 5 : -5;
Â  Â  Â  Â  Â  Â  Â  const basePos = isA ? { x: 85, y: 95 } : { x: 15, y: 5 };
Â  Â  Â  Â  Â  Â  Â  x = basePos.x;
Â  Â  Â  Â  Â  Â  Â  y = basePos.y + (teamCounts[positionKey] * baseOffset);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  teamCounts[positionKey]++;

Â  Â  Â  Â  Â  const token = document.createElement('div');
Â  Â  Â  Â  Â  token.className = `player-token ${tokenClass}`;
Â  Â  Â  Â  Â  token.textContent = p.name.substring(0, 3).toUpperCase();
Â  Â  Â  Â  Â  token.style.left = `${x}%`;
Â  Â  Â  Â  Â  token.style.top = `${y}%`;
Â  Â  Â  Â  Â  token.dataset.playerId = p.id;
Â  Â  Â  Â  Â  token.dataset.team = p.team;
Â  Â  Â  Â  Â  token.dataset.position = p.position;

Â  Â  Â  Â  Â  if (!isCoach) {
Â  Â  Â  Â  Â  Â  Â  token.style.cursor = 'default';
Â  Â  Â  Â  Â  Â  Â  token.style.pointerEvents = 'none';
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  const label = document.createElement('div');
Â  Â  Â  Â  Â  label.className = 'player-label';
Â  Â  Â  Â  Â  label.textContent = p.name;
Â  Â  Â  Â  Â  token.appendChild(label);
Â  Â  Â  Â  Â  fullField.appendChild(token);
Â  Â  Â  });

Â  Â  Â  fieldSection.classList.remove('hidden');
Â  Â  Â  document.getElementById('fieldHeaderStatus').textContent = isCoach ? ' (MÃ­ster)' : ' (AlineaciÃ³n Final)';
Â  }

Â  // --- FUNCIONES DE DRAG & DROP (MÃSTER) ---
Â  function handleDragStart(e) {
Â  Â  Â  // Permitir arrastrar solo al MÃ­ster y solo si la ficha es un 'player-token'
Â  Â  Â  if (!e.target.classList.contains('player-token') || !currentUser || fieldSubscription) return; 
Â  Â  Â  dragTarget = e.target;
Â  Â  Â  dragTarget.setPointerCapture(e.pointerId);
Â  Â  Â  fieldRect = fullField.getBoundingClientRect();
Â  }

Â  function handleDragMove(e) {
Â  Â  Â  if (!dragTarget || !fieldRect) return;

Â  Â  Â  e.preventDefault();
Â  Â  Â Â 
Â  Â  Â  const x = e.clientX - fieldRect.left;
Â  Â  Â  const y = e.clientY - fieldRect.top;

Â  Â  Â  let x_percent = (x / fieldRect.width) * 100;
Â  Â  Â  let y_percent = (y / fieldRect.height) * 100;

Â  Â  Â  x_percent = Math.max(0, Math.min(100, x_percent));
Â  Â  Â  y_percent = Math.max(0, Math.min(100, y_percent));
Â  Â  Â Â 
Â  Â  Â  // Ajuste para centrar la ficha (42px de ancho en 320px de campo es aprox. 13% del ancho)
Â  Â  Â  const halfTokenWidthPercent = (dragTarget.offsetWidth / 2 / fieldRect.width) * 100;
Â  Â  Â  const halfTokenHeightPercent = (dragTarget.offsetHeight / 2 / fieldRect.height) * 100;
Â  Â  Â  
Â  Â  Â  dragTarget.style.left = `${x_percent - halfTokenWidthPercent}%`;
Â  Â  Â  dragTarget.style.top = `${y_percent - halfTokenHeightPercent}%`;
Â  }

Â  async function handleDragEnd(e) {
Â  Â  Â  if (!dragTarget) return;
Â  Â  Â  dragTarget.releasePointerCapture(e.pointerId);
Â  Â  Â  dragTarget = null;
Â  Â  Â  fieldRect = null;
Â  Â  Â Â 
Â  Â  Â  await saveFieldPositions();
Â  }

Â  async function saveFieldPositions() {
Â  Â  Â  if (!currentMatchId) return;

Â  Â  Â  const positions = [];
Â  Â  Â  document.querySelectorAll('.player-token').forEach(token => {
Â  Â  Â  Â  Â  const id = token.dataset.playerId;
Â  Â  Â  Â  Â  const team = token.dataset.team;
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  const x = parseFloat(token.style.left);
Â  Â  Â  Â  Â  const y = parseFloat(token.style.top);

Â  Â  Â  Â  Â  if (id && !isNaN(x) && !isNaN(y)) {
Â  Â  Â  Â  Â  Â  Â  positions.push({ player_id: id, team: team, x_percent: x, y_percent: y });
Â  Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  const { error } = await supabase.from('matches').update({ field_positions: positions }).eq('id', currentMatchId);
Â  Â  Â  if (error) console.error("Error guardando posiciones de pizarra:", error);
Â  }

Â  // --- FUNCIONES DE REALTIME (PLAYER) ---
Â  function listenToFieldUpdates() {
Â  Â  Â  if (fieldSubscription && fieldSubscription.state === 'joined') return; // Ya estÃ¡ suscrito

Â  Â  Â  if(fieldSubscription) supabase.removeChannel(fieldSubscription);

Â  Â  Â  fieldSubscription = supabase.channel(`match-${currentMatchId}`)
Â  Â  Â  Â  Â  .on('postgres_changes', { 
Â  Â  Â  Â  Â  Â  Â  event: 'UPDATE', 
Â  Â  Â  Â  Â  Â  Â  schema: 'public', 
Â  Â  Â  Â  Â  Â  Â  table: 'matches', 
Â  Â  Â  Â  Â  Â  Â  filter: `id=eq.${currentMatchId}` 
Â  Â  Â  Â  Â  }, (payload) => {
Â  Â  Â  Â  Â  Â  Â  if (payload.new.field_positions) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  applyFieldPositions(payload.new.field_positions, false);
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  // Esto es solo un ejemplo si el MÃ­ster cambia de modo durante la vista del jugador
Â  Â  Â  Â  Â  Â  Â  if (payload.new.status === 'final' && playerLobby.style.display !== 'none') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  loadVotingStatus();
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  .subscribe();
Â  }

Â  function applyFieldPositions(positions, isCoach) {
Â  Â  Â  positions.forEach(pos => {
Â  Â  Â  Â  Â  const token = document.querySelector(`.player-token[data-player-id="${pos.player_id}"]`);
Â  Â  Â  Â  Â  if (token) {
Â  Â  Â  Â  Â  Â  Â  // Asegurar que el cambio sea suave
Â  Â  Â  Â  Â  Â  Â  token.style.transition = 'top 0.3s, left 0.3s';
Â  Â  Â  Â  Â  Â  Â  token.style.left = `${pos.x_percent}%`;
Â  Â  Â  Â  Â  Â  Â  token.style.top = `${pos.y_percent}%`;
Â  Â  Â  Â  Â  Â  Â  // Para el jugador, asegurarse de que no pueda interactuar
Â  Â  Â  Â  Â  Â  Â  if (!isCoach) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  token.style.pointerEvents = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  token.style.cursor = 'default';
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  });
Â  }

Â  // FunciÃ³n para compartir la imagen del campo
Â  async function shareFieldsImage() {
Â  Â  Â  btnShare.innerHTML = 'â³ Generando imagen...';
Â  Â  Â  btnShare.disabled = true;

Â  Â  Â  html2canvas(document.getElementById('captureArea'), {
Â  Â  Â  Â  Â  allowTaint: true,
Â  Â  Â  Â  Â  useCORS: true,
Â  Â  Â  Â  Â  backgroundColor: null,
Â  Â  Â  Â  Â  scale: 2 // Alta resoluciÃ³n
Â  Â  Â  }).then(canvas => {
Â  Â  Â  Â  Â  const dataURL = canvas.toDataURL('image/png');
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  canvas.toBlob(async (blob) => {
Â  Â  Â  Â  Â  Â  Â  const file = new File([blob], "AlineacionFutbol7.png", { type: "image/png" });
Â  Â  Â  Â  Â  Â  Â  if (navigator.share) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await navigator.share({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  files: [file],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: 'AlineaciÃ³n de FÃºtbol 7 Pro',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text: 'TÃ¡ctica Final del MÃ­ster'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fallbackDownload(dataURL);
Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  fallbackDownload(dataURL);
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }, 'image/png');

Â  Â  Â  Â  Â  btnShare.innerHTML = 'ğŸ“² Enviar AlineaciÃ³n';
Â  Â  Â  Â  Â  btnShare.disabled = false;
Â  Â  Â  });
Â  }
Â  function fallbackDownload(dataURL) {
Â  Â  Â  const a = document.createElement('a');
Â  Â  Â  a.href = dataURL;
Â  Â  Â  a.download = 'alineacion-futbol7.png';
Â  Â  Â  document.body.appendChild(a);
Â  Â  Â  a.click();
Â  Â  Â  document.body.removeChild(a);
Â  Â  Â  alert("Imagen descargada. CompÃ¡rtela manualmente por WhatsApp.");
Â  }
});
</script>
</body>
</html>
