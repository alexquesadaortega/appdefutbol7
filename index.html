<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="theme-color" content="#0f172a">
<title>F√∫tbol 7 Pro - Ultimate Edition</title>

<link rel="icon" href="icono.png" sizes="32x32">
<link rel="apple-touch-icon" href="icono.png">
<meta name="apple-mobile-web-app-capable" content="yes">

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;800&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
  :root { 
    --bg-dark: #0f172a;
    --bg-card: rgba(30, 41, 59, 0.75);
    --primary: #06b6d4;      /* Cian */
    --accent: #a3e635;       /* Lima */
    --text-main: #f8fafc;
    --text-muted: #94a3b8;
    --whatsapp: #25D366;
    --glass-border: 1px solid rgba(255, 255, 255, 0.1);
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body { 
    font-family: 'Inter', sans-serif;
    background-color: var(--bg-dark);
    background-image: radial-gradient(circle at top right, #1e293b 0%, #0f172a 100%);
    color: var(--text-main);
    margin: 0; 
    padding: 20px 15px 120px 15px;
    min-height: 100vh;
  }
  
  h1, h2, h3, h4 { font-family: 'Kanit', sans-serif; margin-top: 0; letter-spacing: 0.5px; }
  
  h1 { 
    font-weight: 800; font-size: 2rem; text-align: center; margin-bottom: 25px; 
    text-transform: uppercase;
    background: linear-gradient(to right, #22d3ee, #a3e635);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    cursor: pointer;
  }

  h2 { font-size: 1.4rem; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
  
  /* ESTILO CRISTAL (Glassmorphism) */
  .box { 
    background: var(--bg-card);
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    border: var(--glass-border);
    padding: 20px; border-radius: 20px; margin-bottom: 24px; 
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
    animation: fadeIn 0.5s ease-out forwards;
  }
  
  /* INPUTS */
  input, select { 
    padding: 14px; margin-bottom: 12px; border-radius: 12px; 
    border: 1px solid #334155; width: 100%; font-size: 16px; 
    background: #1e293b; color: #fff; transition: all 0.3s ease;
    font-family: 'Inter', sans-serif;
  }
  input:focus, select:focus { 
    border-color: var(--primary); box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.2); 
    outline: none; background: #0f172a;
  }
  .row-inputs { display: flex; gap: 10px; }
  
  /* BOTONES */
  button { 
    padding: 16px; border-radius: 12px; border: none; cursor: pointer; 
    font-family: 'Kanit', sans-serif; font-weight: 600; font-size: 1rem; 
    text-transform: uppercase; letter-spacing: 1px; width: 100%; margin-top: 10px; 
    transition: transform 0.1s;
  }
  button:active { transform: scale(0.97); }
  button:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

  button.primary { 
    background: linear-gradient(135deg, var(--primary) 0%, #3b82f6 100%); 
    color: #fff; box-shadow: 0 4px 15px rgba(6, 182, 212, 0.4);
  }
  button.secondary { background: #334155; color: var(--accent); border: 1px solid rgba(163, 230, 53, 0.2); }
  button.whatsapp { 
    background: var(--whatsapp); color: #fff; display: flex; align-items: center; justify-content: center; gap: 10px; 
    box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
  }
  button.outline { 
    background: transparent; border: 1px solid var(--primary); color: var(--primary); 
    font-size: 0.8rem; padding: 6px 12px; width: auto; margin: 0;
  }
  button.vote-btn {
    background: linear-gradient(135deg, #a3e635 0%, #4ade80 100%);
    color: #064e3b; box-shadow: 0 4px 15px rgba(163, 230, 53, 0.4); margin-bottom: 15px;
  }

  /* LISTAS */
  .player-row { 
    display: flex; justify-content: space-between; align-items: center; 
    padding: 12px; margin-bottom: 8px; background: rgba(255,255,255,0.03); 
    border-radius: 10px; border: 1px solid transparent;
  }
  .p-select { width: 22px; height: 22px; margin-right: 12px; accent-color: var(--accent); }
  
  .tag { padding: 4px 8px; border-radius: 4px; font-size: 10px; text-transform: uppercase; font-weight: 800; margin-left: 5px; }
  .tag.portero { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
  .tag.defensa { background: rgba(16, 185, 129, 0.2); color: #34d399; }
  .tag.delantero { background: rgba(239, 68, 68, 0.2); color: #f87171; }

  .rating-badge {
    background: #0f172a; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
    border-radius: 50%; font-weight: bold; color: var(--accent); border: 2px solid #334155; font-size: 0.9rem;
  }

  /* RESULTADOS GENERADOR */
  .option-card { 
    background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.05);
    border-radius: 16px; padding: 20px; margin-bottom: 20px; 
    transition: all 0.3s;
  }
  .option-card.selected { border: 2px solid var(--primary); background: rgba(6, 182, 212, 0.1); }

  .team-columns { display: flex; flex-direction: column; gap: 20px; margin-top: 15px; } 
  @media (min-width: 768px) { .team-columns { flex-direction: row; } }

  .team-col ul { padding: 0; list-style: none; }
  .team-col li { 
    padding: 8px 0; border-bottom: 1px dashed #334155; display:flex; justify-content:space-between; 
    font-size: 0.9rem; color: #cbd5e1;
  }

  /* CHECKBOX PERSONALIZADO (ELECCI√ìN 3 DE 5) */
  .opt-checkbox { width: 25px; height: 25px; accent-color: var(--primary); margin-right:10px; cursor: pointer; }

  /* VOTACI√ìN */
  .vote-progress-container { height: 12px; background: #334155; border-radius: 6px; margin-top: 8px; overflow: hidden; }
  .vote-progress-bar { height: 100%; background: var(--accent); width: 0%; transition: width 0.5s ease-out; }
  .share-link-box { background: #1e293b; padding: 15px; border-radius: 10px; border: 1px dashed var(--primary); word-break: break-all; font-family: monospace; color: var(--primary); margin-top: 10px; text-align: center; font-size: 0.85rem; user-select: all; }

  /* CAMPO DE F√öTBOL GRANDE (UNIFICADO) */
  .field-container { 
    display: flex; flex-direction: column; align-items: center; gap: 25px; 
    background: #e2e8f0; padding: 20px; border-radius: 12px; margin-top: 10px;
  }
  
  .full-field {
    position: relative; width: 320px; height: 600px; 
    background-color: #369a43;
    /* Patr√≥n de c√©sped */
    background-image: 
      linear-gradient(0deg, transparent 24%, rgba(255,255,255,.1) 25%, rgba(255,255,255,.1) 26%, transparent 27%, transparent 74%, rgba(255,255,255,.1) 75%, rgba(255,255,255,.1) 76%, transparent 77%, transparent),
      repeating-linear-gradient(0deg, rgba(0,0,0,0.05) 0px, rgba(0,0,0,0.05) 50px, transparent 50px, transparent 100px);
    border: 6px solid #fff; border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.3); overflow: hidden; user-select: none;
  }

  /* L√çNEAS DEL CAMPO */
  .field-line-center { position: absolute; top: 50%; left: 0; width: 100%; height: 3px; background: rgba(255,255,255,0.8); }
  .field-circle { position: absolute; top: 50%; left: 50%; width: 70px; height: 70px; border: 3px solid rgba(255,255,255,0.8); border-radius: 50%; transform: translate(-50%, -50%); }
  .area-A { position: absolute; bottom: 0; left: 50%; width: 140px; height: 60px; border: 3px solid rgba(255,255,255,0.8); border-bottom: none; transform: translateX(-50%); background: rgba(255,255,255,0.1); }
  .area-B { position: absolute; top: 0; left: 50%; width: 140px; height: 60px; border: 3px solid rgba(255,255,255,0.8); border-top: none; transform: translateX(-50%); background: rgba(255,255,255,0.1); }


  /* FICHAS JUGADORES */
  .player-token {
    position: absolute; width: 42px; height: 42px; border-radius: 50%; 
    display: flex; align-items: center; justify-content: center;
    font-family: 'Kanit', sans-serif; font-size: 13px; font-weight: 800; 
    z-index: 10; touch-action: none; 
    box-shadow: 0 4px 6px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255,255,255,0.3);
    transition: transform 0.1s;
  }
  /* Solo si tiene esta clase se podr√° mover */
  .draggable-token { cursor: grab; }
  .draggable-token:active { cursor: grabbing; transform: scale(1.1); z-index: 100; }
  
  .token-black { background: radial-gradient(circle at 30% 30%, #374151, #111827); color: #fff; border: 2px solid #fff; }
  .token-white { background: radial-gradient(circle at 30% 30%, #fff, #e5e7eb); color: #111827; border: 2px solid #111827; }

  .player-label {
    position: absolute; bottom: -22px; left: 50%; transform: translateX(-50%);
    background: rgba(0,0,0,0.85); color: #fff; padding: 2px 8px; border-radius: 8px;
    font-size: 10px; white-space: nowrap; font-weight: 600; pointer-events: none;
  }

  .hidden { display: none !important; }
  .error-msg { background: rgba(239,68,68,0.2); color: #fca5a5; padding: 12px; border-radius: 8px; border: 1px solid rgba(239,68,68,0.4); margin-top: 10px; display: none; text-align: center; }
  .sticky-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
  .btn-group { display: flex; gap: 8px; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<h1 id="appTitle">F√∫tbol 7 <span style="color:#fff; -webkit-text-fill-color: initial;">Pro</span></h1>

<div id="misterView">
    <div class="box" id="authBox" style="text-align: center;">
      <h2>Bienvenido M√≠ster</h2>
      <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:20px;">Gestiona tu equipo como un profesional.</p>
      
      <input id="authEmail" type="email" placeholder="Correo electr√≥nico">
      <input id="authPassword" type="password" placeholder="Contrase√±a">
      
      <button id="btnLogin" class="primary">Iniciar Sesi√≥n</button>
      <button id="btnRegister" class="secondary" style="margin-top:15px; background:transparent;">Registrarse</button>
      <div id="authMsg" style="margin-top:15px; font-size:0.8rem; min-height:20px;"></div>
    </div>

    <div id="appContent" class="hidden">
      
      <div class="box">
        <h2>üë§ Nuevo Fichaje</h2>
        <div class="row-inputs">
          <input id="playerName" placeholder="Nombre (ej. Lamine)" style="flex: 2;">
          <input id="playerSkill" type="number" placeholder="Nota" inputmode="decimal" step="0.1" style="flex: 1; text-align:center;">
        </div>
        <select id="playerPosition">
            <option value="portero">üß§ Portero</option>
            <option value="defensa">üõ°Ô∏è Defensa</option>
            <option value="delantero">‚ö° Delantero</option>
        </select>
        <button id="btnAddPlayer" class="secondary">‚ûï A√±adir a plantilla</button>
      </div>

      <div class="box">
        <div class="sticky-header">
            <h3 style="margin:0; color:var(--primary);">Convocatoria <span id="playerCount" style="color:var(--text-muted); font-size:0.9rem;"></span></h3>
            <div class="btn-group">
                <button id="btnSelectAll" class="outline" style="border-color:var(--accent); color:var(--accent);">Todos</button>
                <button id="btnDeselectAll" class="outline" style="border-color:#f1f5f9; color:#f1f5f9;">Ninguno</button> 
            </div>
        </div>
        <div id="playersList"></div>
      </div>

      <div class="box" style="border: 1px solid var(--primary);">
        <h2 style="color: var(--primary);">‚ö° Generar Partido</h2>
        <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:15px;">
            Selecciona 14 jugadores. Generar√© 5 opciones. Elige 3 para la votaci√≥n.
        </p>
        
        <button id="btnGenerateTeams" class="primary" style="font-size: 1.1rem; box-shadow: 0 0 20px rgba(6,182,212,0.3);">üé≤ Crear Equipos</button>
        <div id="generateError" class="error-msg"></div>

        <div id="teamsResult" style="margin-top:20px;"></div>

        <div id="misterPollControls" class="hidden" style="margin-top: 25px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
             <h3 style="text-align:center; color: var(--accent);">üó≥Ô∏è Centro de Votaci√≥n</h3>
             
             <div id="prePublishStep">
                 <p style="text-align:center; font-size:0.9rem;">Selecciona 3 opciones arriba para habilitar el bot√≥n.</p>
                 <button id="btnPublishPoll" disabled class="primary" style="background: var(--accent); color: #064e3b;">üöÄ PUBLICAR VOTACI√ìN</button>
             </div>

             <div id="activePollInfo" class="hidden">
                 <p style="text-align:center; font-size:0.8rem; color:#fff;">Comparte este enlace. Los jugadores necesitan su C√ìDIGO.</p>
                 <div class="share-link-box" id="pollLinkDisplay">Generando enlace...</div>
                 
                 <div id="liveResults" style="margin-top:20px;"></div>
                 
                 <button id="btnClosePoll" class="primary" style="margin-top: 15px; background: #ef4444; box-shadow: 0 4px 15px rgba(239,68,68,0.4);">üõë CERRAR Y ELEGIR GANADOR</button>
             </div>
        </div>
      </div>
    </div>
</div>

<div id="playerAuthView" class="hidden">
    <div class="box" style="text-align:center; margin-top: 50px;">
        <h2 style="color:var(--primary);">üîê Zona de Jugadores</h2>
        <p style="color:var(--text-muted);">Introduce tu c√≥digo personal para acceder a la votaci√≥n.</p>
        
        <input id="playerCodeInput" placeholder="C√ìDIGO (ej. PE854)" style="text-align:center; letter-spacing: 3px; font-weight:bold; font-size: 1.2rem; text-transform:uppercase;">
        
        <button id="btnPlayerLogin" class="primary">Entrar</button>
        <p id="playerLoginMsg" style="color:#ef4444; font-size:0.8rem; margin-top:10px; min-height: 20px;"></p>
    </div>
</div>

<div id="playerVoteView" class="hidden">
    <div class="box">
        <h2 style="text-align:center; color: var(--accent);">üó≥Ô∏è Tu Opini√≥n Importa</h2>
        <p style="text-align:center; font-size:0.9rem; color:#cbd5e1; margin-bottom: 20px;">Analiza y vota la mejor opci√≥n.</p>
        
        <div id="playerVoteOptions"></div>
        
        <div id="waitingForMister" class="hidden" style="text-align:center; padding: 30px;">
            <div style="font-size:3rem; margin-bottom:10px;">‚úÖ</div>
            <h3>Voto Registrado</h3>
            <p style="color:var(--text-muted);">Esperando a que el M√≠ster cierre la votaci√≥n y ajuste la t√°ctica...</p>
        </div>
    </div>
</div>

<div id="fieldSection" class="box hidden" style="background: #f1f5f9; color: #1e293b;">
    <h2 style="text-align:center; color:#1e293b;">Pizarra T√°ctica <span id="tacticsBadge" class="tag" style="background:#000; color:#fff; vertical-align:middle;">LIVE</span></h2>
    <p id="fieldInstruction" style="text-align:center; font-size:0.8rem; color:#64748b; margin-bottom:15px;">Mueve las fichas y comparte la imagen.</p>
    
    <div class="field-container" id="captureArea">
      <div id="fullField" class="full-field">
          <div class="field-line-center"></div>
          <div class="field-circle"></div>
          <div class="area-A"></div> <div class="area-B"></div> 
      </div>
      <div style="width: 100%; display: flex; justify-content: space-between; padding: 0 10px;">
          <div style="background:#111827; color:white; padding:6px 15px; border-radius:20px; font-weight:bold; font-family:'Kanit'; font-size:0.8rem;">EQUIPO NEGRO</div>
          <div style="background:#fff; color:#111827; border:2px solid #111827; padding:6px 15px; border-radius:20px; font-weight:bold; font-family:'Kanit'; font-size:0.8rem;">EQUIPO BLANCO</div>
      </div>
    </div>

    <div id="misterFieldControls" class="hidden" style="position:sticky; bottom:0; background:transparent; padding:15px 0; z-index:100; display:flex; flex-direction:column; gap:10px;">
        <button id="btnSaveTactics" class="primary" style="background: #0f172a; border:1px solid var(--accent); color:var(--accent);">üíæ Guardar Pizarra Final</button>
        <button id="btnShareWhatsapp" class="whatsapp">üì≤ Enviar Alineaci√≥n</button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // --- CONFIGURACI√ìN SUPABASE ---
  const SUPABASE_URL = 'https://vayholflhqoyflbvuusa.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZheWhvbGZsaHFveWZsYnZ1dXNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNzc5NjcsImV4cCI6MjA3ODY1Mzk2N30.QxD4_XbYlQarPRUcmoQQclw8cCnnzRiHZcYzSsUXGDA' ;
  let supabase;
  try { supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch (e) { console.error("Error Supabase", e); }

  // ESTADO GLOBAL
  let allPlayers = [];
  let currentUser = null;
  let generatedOptions = []; // Las 5 generadas
  let selectedOptionsForPoll = []; // Las 3 elegidas
  let currentPollId = null;
  let playerInfo = null; // Info del jugador logueado

  // ELEMENTOS DOM
  const misterView = document.getElementById('misterView');
  const playerAuthView = document.getElementById('playerAuthView');
  const playerVoteView = document.getElementById('playerVoteView');
  const fieldSection = document.getElementById('fieldSection');
  const fullField = document.getElementById('fullField');

  // --- PERSISTENCIA (FIX 1) ---
  const MISTER_STATE_KEY = 'mister_poll_state';

  function saveMisterState() {
      if (currentUser) {
          const state = {
              pollId: currentPollId,
              options: generatedOptions,
              selected: selectedOptionsForPoll,
          };
          localStorage.setItem(MISTER_STATE_KEY + '_' + currentUser.id, JSON.stringify(state));
      }
  }

  function loadMisterState() {
      if (!currentUser) return;
      const stateJSON = localStorage.getItem(MISTER_STATE_KEY + '_' + currentUser.id);
      if (stateJSON) {
          const state = JSON.parse(stateJSON);
          generatedOptions = state.options || [];
          currentPollId = state.pollId;
          selectedOptionsForPoll = state.selected || [];
          
          if (currentPollId) {
              // Si hay encuesta activa, vamos directo a los resultados live
              document.getElementById('authBox').style.display = 'none';
              document.getElementById('appContent').classList.remove('hidden');
              displayMisterOptions(generatedOptions); // Necesario para re-renderizar la UI
              document.getElementById('prePublishStep').classList.add('hidden');
              document.getElementById('activePollInfo').classList.remove('hidden');
              const shareUrl = `${window.location.origin}${window.location.pathname}?poll=${currentPollId}`;
              document.getElementById('pollLinkDisplay').textContent = shareUrl;
              setupMisterLiveResults();
              return true;
          } else if (generatedOptions.length > 0) {
              // Si hay opciones generadas pero no publicada, mostrar las opciones
              document.getElementById('authBox').style.display = 'none';
              document.getElementById('appContent').classList.remove('hidden');
              displayMisterOptions(generatedOptions);
              return true;
          }
      }
      return false;
  }
  
  function clearMisterState() {
      if (currentUser) {
          localStorage.removeItem(MISTER_STATE_KEY + '_' + currentUser.id);
      }
      currentPollId = null;
      generatedOptions = [];
      selectedOptionsForPoll = [];
  }


  // --- ENRUTAMIENTO SIMPLE ---
  const urlParams = new URLSearchParams(window.location.search);
  const pollParam = urlParams.get('poll');

  if (pollParam) {
      initPlayerMode(pollParam);
  } else {
      initMisterMode();
  }

  // =========================================================
  // ===================== L√ìGICA MISTER =====================
  // =========================================================
  
  function initMisterMode() {
      // Auth Handlers
      document.getElementById('btnRegister').onclick = () => handleAuth('signup');
      document.getElementById('btnLogin').onclick = () => handleAuth('signin');
      
      // App Handlers
      document.getElementById('btnAddPlayer').onclick = addPlayer;
      document.getElementById('btnGenerateTeams').onclick = generateTeamOptions;
      document.getElementById('btnSelectAll').onclick = () => document.querySelectorAll('.p-select').forEach(c => c.checked = true);
      document.getElementById('btnDeselectAll').onclick = () => document.querySelectorAll('.p-select').forEach(c => c.checked = false);
      
      // Poll Handlers
      document.getElementById('btnPublishPoll').onclick = publishPoll;
      document.getElementById('btnClosePoll').onclick = closePollAndGoToField;
      
      // Field Handlers
      document.getElementById('btnSaveTactics').onclick = saveFinalTactics;
      document.getElementById('btnShareWhatsapp').onclick = shareFieldsImage;

      // Volver al inicio clicando t√≠tulo
      document.getElementById('appTitle').onclick = () => window.location.href = window.location.pathname;

      // Comprobar sesi√≥n al inicio
      supabase.auth.getSession().then(({ data: { session } }) => {
          if (session) {
              currentUser = session.user;
              document.getElementById('authBox').style.display = 'none';
              document.getElementById('appContent').classList.remove('hidden');
              loadPlayers().then(() => {
                  loadMisterState(); // Cargar estado DESPU√âS de cargar jugadores
              });
          }
      });
  }

  async function handleAuth(type) { 
    const email = document.getElementById('authEmail').value.trim();
    const password = document.getElementById('authPassword').value;
    const msg = document.getElementById('authMsg');
    
    if (!email || !password) return msg.textContent = '‚ö†Ô∏è Faltan datos';
    
    msg.textContent = '‚è≥ Conectando...';
    let res = type === 'signup' ? await supabase.auth.signUp({ email, password }) : await supabase.auth.signInWithPassword({ email, password });

    if (res.error) {
        msg.style.color = '#ef4444'; msg.textContent = res.error.message;
    } else { 
        currentUser = res.data.user; 
        msg.textContent = '‚úÖ Correcto'; 
        setTimeout(() => {
            document.getElementById('authBox').style.display = 'none';
            document.getElementById('appContent').classList.remove('hidden');
            loadPlayers().then(() => {
                loadMisterState(); // Cargar estado DESPU√âS de cargar jugadores
            });
        }, 500);
    }
  }

  async function loadPlayers() { 
    if (!currentUser) return;
    const { data } = await supabase.from('players').select('*').eq('user_id', currentUser.id);
    allPlayers = data || [];
    renderList();
  }

  async function addPlayer() { 
    const name = document.getElementById('playerName').value.trim();
    const rating = parseFloat(document.getElementById('playerSkill').value);
    const position = document.getElementById('playerPosition').value;
    
    if (!name || !rating) return alert('Datos incompletos');
    
    // GENERAR C√ìDIGO (Ej: LA832)
    const code = (name.substring(0,2).toUpperCase() + Math.floor(100 + Math.random() * 900)).replace(/\s/g, '');
    
    const newPlayer = { user_id: currentUser.id, name, position, rating, player_code: code };

    const { data, error } = await supabase.from('players').insert([newPlayer]).select();
    
    if (error) { console.error(error); alert("Error guardando. Revisa consola."); return; }
    
    if(data && data.length) {
        allPlayers.push(data[0]); 
        document.getElementById('playerName').value = ''; 
        document.getElementById('playerSkill').value = '';
        renderList();
    }
  }

  async function deletePlayer(id) {
      if(!confirm("¬øEliminar jugador?")) return;
      await supabase.from('players').delete().eq('id', String(id));
      allPlayers = allPlayers.filter(p => String(p.id) !== String(id));
      renderList();
  }

  function renderList() { 
    const list = document.getElementById('playersList'); list.innerHTML = '';
    document.getElementById('playerCount').textContent = `(${allPlayers.length})`;
    const order = { portero: 1, defensa: 2, delantero: 3 };
    
    [...allPlayers].sort((a,b) => order[a.position] - order[b.position] || b.rating - a.rating).forEach(p => {
      const div = document.createElement('div');
      div.className = 'player-row';
      div.innerHTML = `
        <div style="display:flex; align-items:center;">
          <input type="checkbox" class="p-select" checked value="${p.id}">
          <div>
             <span style="font-weight:600; font-size:1rem; color:#f1f5f9;">${p.name}</span>
             <span class="tag ${p.position}">${p.position}</span>
             <span style="font-size:0.75rem; color:#facc15; margin-left:5px; font-weight:bold;">üîë ${p.player_code || '---'}</span>
          </div>
        </div>
        <div style="display:flex; align-items:center; gap: 10px;">
            <div class="rating-badge">${p.rating}</div>
            <button class="outline delete-btn" style="border-color:#ef4444; color:#ef4444; padding: 4px 8px; width:auto; margin:0;">üóëÔ∏è</button>
        </div>
      `;
      div.querySelector('.delete-btn').addEventListener('click', () => deletePlayer(p.id));
      list.appendChild(div);
    });
  }

  // --- ALGORITMO GENERADOR ---
  function generateTeamOptions() { 
    document.getElementById('generateError').style.display = 'none';
    const checks = document.querySelectorAll('.p-select:checked');
    const selectedIds = Array.from(checks).map(c => c.value);
    const pool = allPlayers.filter(p => selectedIds.includes(String(p.id)));

    if (pool.length < 14) { showError('Selecciona al menos 14 jugadores.'); return; }
    
    // Validar minimos
    const count = (pos) => pool.filter(p => p.position === pos).length;
    if (count('portero') < 2) { showError('Faltan Porteros (m√≠n 2).'); return; }
    if (count('defensa') < 6) { showError('Faltan Defensas (m√≠n 6).'); return; }

    let variations = [];
    const seenHashes = new Set(); 

    for(let i=0; i<800; i++) { 
        const attempt = createStrictMatch(pool);
        if(!attempt) continue;
        
        const idsA = attempt.teamA.map(p => p.id).sort().join('-');
        const idsB = attempt.teamB.map(p => p.id).sort().join('-');
        const hash = [idsA, idsB].sort().join('::');

        if(seenHashes.has(hash)) continue; 
        seenHashes.add(hash);
        variations.push(attempt);
    }

    variations.sort((a, b) => a.diff - b.diff); // Ordenar por equilibrio
    generatedOptions = variations.slice(0, 5); // Coger top 5
    
    if (generatedOptions.length === 0) { showError("No se pudieron generar equipos v√°lidos."); return; }
    
    displayMisterOptions(generatedOptions);
    saveMisterState(); // Guardar opciones generadas
  }

  function createStrictMatch(originalPool) {
    const pool = JSON.parse(JSON.stringify(originalPool));
    
    const gks = shuffle(pool.filter(p => p.position === 'portero'));
    const defs = shuffle(pool.filter(p => p.position === 'defensa'));
    const fwds = shuffle(pool.filter(p => p.position === 'delantero'));

    const teamA = []; const teamB = [];

    if(gks.length < 2) return null;
    teamA.push(gks.pop()); teamB.push(gks.pop());            
    
    if(defs.length < 6) return null;
    for(let k=0;k<3;k++) { teamA.push(defs.pop()); teamB.push(defs.pop()); } 
    
    if(fwds.length >= 2) { 
        teamA.push(fwds.pop()); teamB.push(fwds.pop()); 
    }

    let leftovers = [...gks, ...defs, ...fwds]; 
    leftovers = shuffle(leftovers);

    while(leftovers.length > 0) {
        if(teamA.length <= teamB.length) teamA.push(leftovers.pop());
        else teamB.push(leftovers.pop());
    }
    
    const getAvg = t => t.reduce((a,c)=>a+c.rating,0) / t.length;
    const avgA = getAvg(teamA); const avgB = getAvg(teamB);
    
    return { teamA, teamB, avgA: avgA.toFixed(2), avgB: avgB.toFixed(2), diff: Math.abs(avgA - avgB) };
  }
  
  function shuffle(arr) { return [...arr].sort(() => Math.random() - 0.5); }
  function showError(msg) { const e = document.getElementById('generateError'); e.textContent = msg; e.style.display = 'block'; }

  // --- VISUALIZAR OPCIONES Y SELECCIONAR PARA VOTAR ---
  function displayMisterOptions(options) {
    const container = document.getElementById('teamsResult');
    container.innerHTML = '';
    // selectedOptionsForPoll = []; // No resetear si viene de loadState
    updatePublishButton();
    
    document.getElementById('misterPollControls').classList.remove('hidden');

    options.forEach((opt, index) => {
        const isSelected = selectedOptionsForPoll.includes(opt);
        const div = document.createElement('div');
        div.className = `option-card ${isSelected ? 'selected' : ''}`;
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px; margin-bottom:10px;">
                <div style="display:flex; align-items:center;">
                    <input type="checkbox" class="opt-checkbox" data-idx="${index}" ${isSelected ? 'checked' : ''}>
                    <h4 style="margin:0; color:var(--primary);">Opci√≥n ${index + 1}</h4>
                </div>
                <span class="tag" style="background:#334155; color:#fff;">Dif: ${opt.diff.toFixed(2)}</span>
            </div>
            <div class="team-columns">
                <div class="team-col"><strong style="color:#94a3b8">Negro (${opt.avgA})</strong><ul>${renderListSimple(opt.teamA)}</ul></div>
                <div class="team-col"><strong style="color:#f1f5f9">Blanco (${opt.avgB})</strong><ul>${renderListSimple(opt.teamB)}</ul></div>
            </div>
            <button class="outline btn-preview" style="margin-top:15px; width:100%; border-color:var(--accent); color:var(--accent);">üîç Ver en Pizarra</button>
        `;
        
        // Evento Checkbox
        div.querySelector('.opt-checkbox').addEventListener('change', (e) => {
            const idx = parseInt(e.target.dataset.idx);
            const option = generatedOptions[idx];

            if (e.target.checked) {
                if (selectedOptionsForPoll.length >= 3) {
                    e.target.checked = false; alert("Solo puedes seleccionar 3 opciones.");
                } else {
                    div.classList.add('selected'); 
                    if (!selectedOptionsForPoll.includes(option)) selectedOptionsForPoll.push(option);
                }
            } else {
                div.classList.remove('selected'); 
                selectedOptionsForPoll = selectedOptionsForPoll.filter(o => o !== option);
            }
            updatePublishButton();
            saveMisterState(); // Guardar selecci√≥n
        });

        // Evento Previsualizar
        div.querySelector('.btn-preview').addEventListener('click', () => {
            fieldSection.classList.remove('hidden');
            document.getElementById('misterFieldControls').classList.remove('hidden');
            renderField(generatedOptions[index], true); // TRUE = Editable por Mister
            fieldSection.scrollIntoView({behavior:"smooth"});
        });

        container.appendChild(div);
    });
  }

  function renderListSimple(t) {
    const order={portero:0,defensa:1,delantero:2};
    return [...t].sort((a,b)=>order[a.position]-order[b.position]).map(p=>`<li><span>${p.name}</span><span style="font-size:0.7rem;opacity:0.7;">${p.position.substring(0,3).toUpperCase()}</span></li>`).join('');
  }

  function updatePublishButton() {
      const btn = document.getElementById('btnPublishPoll');
      btn.disabled = selectedOptionsForPoll.length !== 3;
      btn.innerHTML = selectedOptionsForPoll.length === 3 ? "üöÄ PUBLICAR VOTACI√ìN" : `Selecciona 3 opciones (${selectedOptionsForPoll.length}/3)`;
  }

  // --- GESTI√ìN DE LA VOTACI√ìN ---
  async function publishPoll() {
      if(!currentUser || currentPollId) return;
      document.getElementById('btnPublishPoll').disabled = true;
      document.getElementById('btnPublishPoll').innerText = "Creando...";

      const { data, error } = await supabase.from('polls').insert([{ 
            user_id: currentUser.id, 
            options: selectedOptionsForPoll,
            status: 'open'
      }]).select();

      if (error) { alert('Error creando encuesta'); return; }
      
      currentPollId = data[0].id;
      
      // FIX 1: Persistencia
      saveMisterState();
      
      // Cambiar UI
      document.getElementById('prePublishStep').classList.add('hidden');
      document.getElementById('activePollInfo').classList.remove('hidden');
      
      const shareUrl = `${window.location.origin}${window.location.pathname}?poll=${currentPollId}`;
      document.getElementById('pollLinkDisplay').textContent = shareUrl;

      setupMisterLiveResults();
  }

  function setupMisterLiveResults() {
      const container = document.getElementById('liveResults');
      
      const render = async () => {
          const { data: votes } = await supabase.from('votes').select('choice_index').eq('poll_id', currentPollId);
          container.innerHTML = '';
          selectedOptionsForPoll.forEach((_, idx) => {
              const count = votes.filter(v => v.choice_index === idx).length;
              const pct = votes.length ? Math.round((count/votes.length)*100) : 0;
              container.innerHTML += `
                <div style="font-size:0.85rem; margin-top:10px; display:flex; justify-content:space-between;">
                    <span>Opci√≥n ${idx+1}</span> <span>${count} votos (${pct}%)</span>
                </div>
                <div class="vote-progress-container"><div class="vote-progress-bar" style="width:${pct}%"></div></div>
              `;
          });
      };

      // Realtime Listener
      supabase.channel('votes_channel').on('postgres_changes', { event: '*', schema: 'public', table: 'votes', filter: `poll_id=eq.${currentPollId}` }, render).subscribe();
      render(); // Initial call
  }

  async function closePollAndGoToField() {
      if(!confirm("¬øCerrar votaci√≥n y decidir ganador?")) return;
      
      const { data: votes } = await supabase.from('votes').select('choice_index').eq('poll_id', currentPollId);
      let counts = [0,0,0];
      votes.forEach(v => counts[v.choice_index]++);
      
      // Ganador por mayor√≠a simple
      let maxVotes = Math.max(...counts);
      let winnerIdx = counts.indexOf(maxVotes);
      const winnerOption = selectedOptionsForPoll[winnerIdx];
      
      // Actualizar DB
      await supabase.from('polls').update({ status: 'closed' }).eq('id', currentPollId);
      clearMisterState(); // Limpiar estado local

      // Mostrar Pizarra al Mister
      misterView.classList.add('hidden');
      fieldSection.classList.remove('hidden');
      document.getElementById('misterFieldControls').classList.remove('hidden'); 
      document.getElementById('tacticsBadge').textContent = "EDITANDO";

      renderField(winnerOption, true); // MISTER MUEVE FICHAS
      alert(`Gan√≥ la Opci√≥n ${winnerIdx+1} con ${maxVotes} votos.`);
  }

  // =========================================================
  // ===================== L√ìGICA JUGADOR ====================
  // =========================================================
  
  // FIX 2: Funci√≥n auxiliar para mostrar la lista completa en el lado del jugador
  function renderPlayerListForPlayerView(team, color) {
      const names = team.map(p => p.name.split(' ')[0]).join(', '); // Solo el primer nombre
      return `<p style="font-size:0.8rem; margin:5px 0 10px 0; color:${color}; line-height:1.4;">
          ${names}
      </p>`;
  }

  function initPlayerMode(pollId) {
      currentPollId = pollId;
      misterView.classList.add('hidden');
      playerAuthView.classList.remove('hidden');

      document.getElementById('btnPlayerLogin').onclick = async () => {
          const code = document.getElementById('playerCodeInput').value.trim().toUpperCase();
          const msg = document.getElementById('playerLoginMsg');
          
          if (!code) return msg.textContent = "Introduce tu c√≥digo";
          msg.textContent = "Verificando...";
          
          const { data, error } = await supabase.from('players').select('*').eq('player_code', code).maybeSingle();
          
          if (error || !data) {
              msg.textContent = "‚ùå C√≥digo no encontrado.";
              return;
          }
          
          playerInfo = data;
          playerAuthView.classList.add('hidden');
          setupPlayerPollView();
      };
  }

  async function setupPlayerPollView() {
      const { data: poll } = await supabase.from('polls').select('*').eq('id', currentPollId).single();
      if (!poll) { alert("Error de encuesta"); return; }

      if (poll.status === 'closed') {
          showFinalField(poll.final_tactics);
          return;
      }
      
      const { data: vote } = await supabase.from('votes').select('*').eq('poll_id', currentPollId).eq('player_code', playerInfo.player_code).maybeSingle();

      if (vote) {
          showWaitingScreen();
      } else {
          renderPlayerOptions(poll.options);
      }
      
      supabase.channel('poll_status').on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'polls', filter: `id=eq.${currentPollId}` }, 
          payload => {
             if (payload.new.status === 'closed' && payload.new.final_tactics) {
                 showFinalField(payload.new.final_tactics);
             }
          }
      ).subscribe();
  }

  function renderPlayerOptions(options) {
      playerVoteView.classList.remove('hidden');
      const container = document.getElementById('playerVoteOptions');
      container.innerHTML = '';
      
      options.forEach((opt, idx) => {
          const card = document.createElement('div');
          card.className = 'box';
          card.style.background = 'rgba(255,255,255,0.05)';
          card.style.marginBottom = '20px';
          card.innerHTML = `
              <h4 style="color:var(--primary); text-align:center; margin-bottom:15px;">OPCI√ìN ${idx+1}</h4>
              <div style="display:flex; justify-content:space-around; text-align:center;">
                  <div>
                      <strong style="color:#94a3b8;">Negro (${opt.avgA})</strong>
                      ${renderPlayerListForPlayerView(opt.teamA, '#94a3b8')}
                  </div>
                  <div style="border-left:1px dashed #334155; padding-left:10px;">
                      <strong style="color:#f1f5f9;">Blanco (${opt.avgB})</strong>
                      ${renderPlayerListForPlayerView(opt.teamB, '#f1f5f9')}
                  </div>
              </div>
              <button class="vote-btn" data-idx="${idx}" style="margin-top:20px;">VOTAR ESTA OPCI√ìN</button>
          `;
          
          card.querySelector('.vote-btn').onclick = async (e) => {
              const selectedIdx = parseInt(e.target.dataset.idx);
              const { error } = await supabase.from('votes').insert([{
                  poll_id: currentPollId,
                  player_code: playerInfo.player_code,
                  choice_index: selectedIdx
              }]);
              if (!error) showWaitingScreen();
              else alert("Error al votar. ¬øYa has votado?");
          };

          container.appendChild(card);
      });
  }

  function showWaitingScreen() {
      playerVoteView.classList.remove('hidden');
      document.getElementById('playerVoteOptions').classList.add('hidden');
      document.getElementById('waitingForMister').classList.remove('hidden');
  }

  function showFinalField(tactics) {
      if(!tactics) return;
      playerVoteView.classList.add('hidden');
      fieldSection.classList.remove('hidden');
      document.getElementById('misterFieldControls').classList.add('hidden');
      document.getElementById('tacticsBadge').textContent = "OFICIAL";
      document.getElementById('tacticsBadge').style.background = "var(--primary)";
      
      renderFieldFromState(tactics);
  }

  // =========================================================
  // ===================== PIZARRA T√ÅCTICA ===================
  // =========================================================

  function renderField(option, isInteractive) {
      fullField.querySelectorAll('.player-token').forEach(e => e.remove());
      drawTeam(option.teamA, 'token-black', 'bottom', isInteractive); 
      drawTeam(option.teamB, 'token-white', 'top', isInteractive); 
  }

  function renderFieldFromState(savedState) {
      fullField.querySelectorAll('.player-token').forEach(e => e.remove());
      savedState.forEach(t => {
          createToken(t.name, t.cls, t.x, t.y, false);
      });
  }

  function drawTeam(team, colorClass, half, isInteractive) {
    const isBot = half === 'bottom';
    const coordsFixed = {
        portero:   [{x:140, y: isBot ? 520 : 40}], 
        defensa:   [{x:50, y: isBot ? 450 : 100}, {x:140, y: isBot ? 450 : 100}, {x:230, y: isBot ? 450 : 100}], 
        delantero: [{x:140, y: isBot ? 350 : 200}] 
    };
    
    const slots = JSON.parse(JSON.stringify(coordsFixed));
    
    team.forEach(p => {
        let pos = {x: 100, y: 300};
        if (slots[p.position] && slots[p.position].length > 0) {
            pos = slots[p.position].shift();
        } else {
            const yBase = isBot ? 400 : 150;
            pos = { x: Math.random() * 250 + 20, y: yBase + (Math.random()*40) };
        }
        createToken(p.name, colorClass, pos.x + 'px', pos.y + 'px', isInteractive);
    });
  }

  function createToken(name, cls, x, y, isInteractive) {
    const el = document.createElement('div');
    el.className = `player-token ${cls}`;
    if(isInteractive) el.classList.add('draggable-token');
    
    el.textContent = name.substring(0,2).toUpperCase();
    el.style.left = x; el.style.top = y;
    
    const l = document.createElement('div'); l.className='player-label'; l.textContent=name;
    el.appendChild(l);
    
    if (isInteractive) {
        el.addEventListener('mousedown', dragStart);
        el.addEventListener('touchstart', dragStart, {passive: false});
    }
    fullField.appendChild(el);
  }

  // --- DRAG AND DROP MANUAL ROBUSTO ---
  let activeItem = null;
  let startX, startY, initialLeft, initialTop;

  function dragStart(e) {
    e.preventDefault();
    activeItem = e.currentTarget;
    
    const evt = e.type === 'touchstart' ? e.touches[0] : e;
    startX = evt.clientX;
    startY = evt.clientY;
    
    initialLeft = parseFloat(activeItem.style.left || 0);
    initialTop = parseFloat(activeItem.style.top || 0);

    document.addEventListener('mousemove', dragMove);
    document.addEventListener('mouseup', dragEnd);
    document.addEventListener('touchmove', dragMove, {passive: false});
    document.addEventListener('touchend', dragEnd);
  }

  function dragMove(e) {
    if (!activeItem) return;
    e.preventDefault();
    
    const evt = e.type === 'touchmove' ? e.touches[0] : e;
    const dx = evt.clientX - startX;
    const dy = evt.clientY - startY;

    let newX = initialLeft + dx;
    let newY = initialTop + dy;
    
    if(newX < 0) newX = 0; if(newX > 280) newX = 280;
    if(newY < 0) newY = 0; if(newY > 560) newY = 560;

    activeItem.style.left = `${newX}px`;
    activeItem.style.top = `${newY}px`;
  }

  function dragEnd() {
    activeItem = null;
    document.removeEventListener('mousemove', dragMove);
    document.removeEventListener('mouseup', dragEnd);
    document.removeEventListener('touchmove', dragMove);
    document.removeEventListener('touchend', dragEnd);
  }

  // --- GUARDAR Y COMPARTIR ---
  async function saveFinalTactics() {
      const btn = document.getElementById('btnSaveTactics');
      btn.textContent = "Guardando...";
      
      const finalState = [];
      document.querySelectorAll('.player-token').forEach(token => {
          finalState.push({
              name: token.querySelector('.player-label').textContent,
              x: token.style.left,
              y: token.style.top,
              cls: token.classList.contains('token-black') ? 'token-black' : 'token-white'
          });
      });

      const { error } = await supabase.from('polls').update({ final_tactics: finalState }).eq('id', currentPollId);
      
      if(!error) {
          btn.textContent = "‚úÖ Guardado";
          setTimeout(() => btn.textContent = "üíæ Actualizar", 2000);
      } else {
          alert("Error guardando"); btn.textContent = "Error";
      }
  }

  async function shareFieldsImage() {
    const btn = document.getElementById('btnShareWhatsapp');
    const old = btn.innerHTML; btn.innerHTML = "Generando..."; btn.disabled = true;
    try {
        const canvas = await html2canvas(document.getElementById('captureArea'), { backgroundColor: '#e2e8f0', scale: 2, useCORS: true });
        canvas.toBlob(blob => {
            const file = new File([blob], 'alineacion.png', { type: 'image/png' });
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                navigator.share({ files: [file], title: 'Alineaci√≥n F7' });
            } else {
                const link = document.createElement('a'); link.download = 'alineacion.png'; link.href = canvas.toDataURL(); link.click();
            }
            btn.innerHTML = old; btn.disabled = false;
        });
    } catch (e) { console.error(e); btn.innerHTML = old; btn.disabled = false; }
  }
});
</script>
</body>
</html>
