<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="theme-color" content="#0f172a">
<title>F√∫tbol 7 Pro - Ultimate Edition</title>

<link rel="icon" href="icono.png" sizes="32x32">
<link rel="apple-touch-icon" href="icono.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" sizes="180x180" href="icono.png">
<link rel="icon" sizes="192x192" href="icono.png">
<link rel="manifest" href="/manifest.json">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;800&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* --- ESTILOS (Mantener estilos anteriores) --- */
:root { 
  --bg-dark: #0f172a;
  --bg-card: rgba(30, 41, 59, 0.7);
  --primary: #06b6d4;
  --accent: #a3e635;
  --text-main: #f8fafc;
  --text-muted: #94a3b8;
  --whatsapp: #25D366;
  --glass-border: 1px solid rgba(255, 255, 255, 0.1);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {  
  font-family: 'Inter', sans-serif;
  background-color: var(--bg-dark);
  background-image: radial-gradient(circle at top right, #1e293b 0%, #0f172a 100%);
  color: var(--text-main);
  margin: 0; 
  padding: 20px 15px 120px 15px;
  min-height: 10vh;
}
 
h1, h2, h3 { font-family: 'Kanit', sans-serif; margin-top: 0; letter-spacing: 0.5px; }
 
h1 { 
  font-weight: 800; font-size: 2rem; text-align: center; margin-bottom: 25px; 
  text-transform: uppercase;
  background: linear-gradient(to right, #22d3ee, #a3e635);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
}

h2 { font-size: 1.4rem; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
 
/* ESTILO CRISTAL (Glassmorphism) */
.box { 
  background: var(--bg-card);
  backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
  border: var(--glass-border);
  padding: 20px; border-radius: 20px; margin-bottom: 24px; 
  box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
  animation: fadeIn 0.5s ease-out forwards;
}
 
/* INPUTS */
input, select { 
  padding: 14px; margin-bottom: 12px; border-radius: 12px; 
  border: 1px solid #334155; width: 100%; font-size: 16px; 
  background: #1e293b; color: #fff; transition: all 0.3s ease;
  font-family: 'Inter', sans-serif;
}
input:focus, select:focus { 
  border-color: var(--primary); box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.2); 
  outline: none; background: #0f172a;
}

.row-inputs { display: flex; gap: 10px; }
 
/* BOTONES */
button { 
  padding: 16px; border-radius: 12px; border: none; cursor: pointer; 
  font-family: 'Kanit', sans-serif; font-weight: 600; font-size: 1rem; 
  text-transform: uppercase; letter-spacing: 1px; width: 100%; margin-top: 10px; 
  transition: transform 0.1s;
}
button:active { transform: scale(0.97); }
button:disabled { opacity: 0.5; cursor: not-allowed; }

button.primary { 
  background: linear-gradient(135deg, var(--primary) 0%, #3b82f6 100%); 
  color: #fff; box-shadow: 0 4px 15px rgba(6, 182, 212, 0.4);
}
button.secondary { background: #334155; color: var(--accent); border: 1px solid rgba(163, 230, 53, 0.2); }
button.whatsapp { 
  background: var(--whatsapp); color: #fff; display: flex; align-items: center; justify-content: center; gap: 10px; 
  box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
}
button.outline { 
  background: transparent; border: 1px solid var(--primary); color: var(--primary); 
  font-size: 0.8rem; padding: 6px 12px; width: auto; margin: 0;
}
/* Estilo para el bot√≥n de selecci√≥n de opciones */
button.select-btn.selected { 
    background: var(--accent); 
    color: #000; 
    border: 1px solid var(--accent);
}

/* LISTAS */
.player-row { 
  display: flex; justify-content: space-between; align-items: center; 
  padding: 12px; margin-bottom: 8px; background: rgba(255,255,255,0.03); 
  border-radius: 10px; border: 1px solid transparent;
}
.p-select { width: 22px; height: 22px; margin-right: 12px; accent-color: var(--accent); }
 
.tag { padding: 4px 8px; border-radius: 4px; font-size: 10px; text-transform: uppercase; font-weight: 800; margin-left: 5px; }
.tag.portero { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
.tag.defensa { background: rgba(16, 185, 129, 0.2); color: #34d399; }
.tag.delantero { background: rgba(239, 68, 68, 0.2); color: #f87171; }

.rating-badge {
  background: #0f172a; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
  border-radius: 50%; font-weight: bold; color: var(--accent); border: 2px solid #334155; font-size: 0.9rem;
}

/* RESULTADOS */
.option-card { 
  background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.05);
  border-radius: 16px; padding: 20px; margin-bottom: 20px; 
  transition: border 0.3s ease;
}
.team-columns { display: flex; flex-direction: column; gap: 20px; margin-top: 15px; } 
@media (min-width: 768px) { .team-columns { flex-direction: row; } }

.team-col ul { padding: 0; list-style: none; }
.team-col li { 
  padding: 8px 0; border-bottom: 1px dashed #334155; display:flex; justify-content:space-between; 
  font-size: 0.9rem; color: #cbd5e1;
}

/* CAMPO DE F√öTBOL GRANDE (UNIFICADO) */
.field-container { 
  display: flex; flex-direction: column; align-items: center; gap: 25px; 
  background: #e2e8f0; padding: 20px; border-radius: 12px; margin-top: 10px;
}
 
.full-field {
  position: relative; width: 320px; height: 600px; 
  background-color: #369a43;
  /* Patr√≥n de c√©sped */
  background-image: 
    linear-gradient(0deg, transparent 24%, rgba(255,255,255,.1) 25%, rgba(255,255,255,.1) 26%, transparent 27%, transparent 74%, rgba(255,255,255,.1) 75%, rgba(255,255,255,.1) 76%, transparent 77%, transparent),
    repeating-linear-gradient(0deg, rgba(0,0,0,0.05) 0px, rgba(0,0,0,0.05) 50px, transparent 50px, transparent 100px);
  border: 6px solid #fff; border-radius: 12px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.3); overflow: hidden; user-select: none;
}

/* L√çNEAS DEL CAMPO GRANDE */
.field-line-center { position: absolute; top: 50%; left: 0; width: 100%; height: 3px; background: rgba(255,255,255,0.8); }
.field-circle { position: absolute; top: 50%; left: 50%; width: 70px; height: 70px; border: 3px solid rgba(255,255,255,0.8); border-radius: 50%; transform: translate(-50%, -50%); }
 
/* √Åreas de 7v7 */
.area-A { position: absolute; bottom: 0; left: 50%; width: 140px; height: 60px; border: 3px solid rgba(255,255,255,0.8); border-bottom: none; transform: translateX(-50%); background: rgba(255,255,255,0.1); }
.area-B { position: absolute; top: 0; left: 50%; width: 140px; height: 60px; border: 3px solid rgba(255,255,255,0.8); border-top: none; transform: translateX(-50%); background: rgba(255,255,255,0.1); }


/* FICHAS JUGADORES */
.player-token {
  position: absolute; width: 42px; height: 42px; border-radius: 50%; 
  display: flex; align-items: center; justify-content: center;
  font-family: 'Kanit', sans-serif; font-size: 13px; font-weight: 800; 
  cursor: grab; z-index: 10; touch-action: none; 
  box-shadow: 0 4px 6px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255,255,255,0.3);
  transition: transform 0.1s;
}
.player-token:active { cursor: grabbing; transform: scale(1.2); z-index: 100; }
 
.token-black { background: radial-gradient(circle at 30% 30%, #374151, #111827); color: #fff; border: 2px solid #fff; }
.token-white { background: radial-gradient(circle at 30% 30%, #fff, #e5e7eb); color: #111827; border: 2px solid #111827; }

.player-label {
  position: absolute; bottom: -22px; left: 50%; transform: translateX(-50%);
  background: rgba(0,0,0,0.85); color: #fff; padding: 2px 8px; border-radius: 8px;
  font-size: 10px; white-space: nowrap; font-weight: 600; pointer-events: none;
}

.hidden { display: none !important; }
.error-msg { background: rgba(239,68,68,0.2); color: #fca5a5; padding: 12px; border-radius: 8px; border: 1px solid rgba(239,68,68,0.4); margin-top: 10px; display: none; text-align: center; }
.sticky-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
.btn-group { display: flex; gap: 8px; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<h1>F√∫tbol 7 <span style="color:#fff; -webkit-text-fill-color: initial;">Pro</span></h1>

<div class="box" id="authBox" style="text-align: center;">
  <h2>Bienvenido M√≠ster</h2>
  <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:20px;">Gestiona tu equipo como un profesional.</p>
  
  <input id="authEmail" type="email" placeholder="Correo electr√≥nico">
  <input id="authPassword" type="password" placeholder="Contrase√±a">
  
  <button id="btnLogin" class="primary">Iniciar Sesi√≥n</button>
  <button id="btnRegister" class="secondary" style="margin-top:15px; background:transparent;">Registrarse</button>
  <div id="authMsg" style="margin-top:15px; font-size:0.8rem; min-height:20px;"></div>
</div>

<div class="box hidden" id="playerLobby" style="text-align: center; border: 1px solid var(--accent);">
  <h2 style="color: var(--accent);">üó≥Ô∏è Votaci√≥n de Equipos</h2>
  <p id="lobbyStatus" style="font-size:0.9rem;">Introduce tu c√≥digo y vota por el mejor equilibrio.</p>
  
  <div id="playerAuthForm">
    <input id="playerCodeInput" placeholder="Tu C√≥digo (Ej. LAMN87)" style="text-align:center;">
    <button id="btnAuthPlayer" class="secondary" style="margin-top:5px;">üîç Buscar Ficha</button>

    <div id="playerFound" class="hidden" style="margin-top:15px; background:rgba(163, 230, 53, 0.1); padding:15px; border-radius:12px;">
      <p style="color:#0f172a;">üëã ¬°Hola, <strong id="foundPlayerName" style="color:#1e293b;">Jugador</strong>!</p>
      <button id="btnEnterVoting" class="primary" style="background: var(--accent); color: #000; font-size:1.1rem; margin-top:10px;">‚û°Ô∏è Entrar a Votar</button>
    </div>
  </div>

  <div id="votingView" class.="hidden">
    <h3 style="color: var(--primary);">Opciones del M√≠ster</h3>
    <p id="votingHeader" style="font-size:0.85rem; color:var(--text-muted);">¬øCu√°l crees que es la alineaci√≥n m√°s justa?</p>
    <div id="votingOptionsContainer"></div>
  </div>

  <div id="waitingScreen" class="hidden">
    <h3>‚úÖ Voto Registrado</h3>
    <p>Gracias. Esperando que el M√≠ster publique la alineaci√≥n final...</p>
    <div class="field-container" style="height: 200px; justify-content:center;">
       <div class="rating-badge" style="width:60px; height:60px; font-size:1.5rem; border-color:var(--accent);">üó≥Ô∏è</div>
    </div>
  </div>
</div>


<div id="appContent" class="hidden">
  
  <div class="box" id="addPlayerBox">
    <h2>üë§ Nuevo Fichaje</h2>
    <p style="font-size:0.85rem; color:var(--text-muted);">El c√≥digo se genera autom√°ticamente.</p>
    <div class="row-inputs">
      <input id="playerName" placeholder="Nombre (ej. Lamine)" style="flex: 2;">
      <input id="playerSkill" type="number" placeholder="Nota" inputmode="decimal" step="0.1" style="flex: 1; text-align:center;">
    </div>
    <select id="playerPosition">
        <option value="portero">üß§ Portero</option>
        <option value="defensa">üõ°Ô∏è Defensa</option>
        <option value="delantero">‚ö° Delantero</option>
    </select>
    <button id="btnAddPlayer" class="secondary">‚ûï A√±adir a plantilla</button>
  </div>

  <div class="box" id="playerListBox">
    <div class="sticky-header">
        <h3 style="margin:0; color:var(--primary);">Convocatoria <span id="playerCount" style="color:var(--text-muted); font-size:0.9rem;"></span></h3>
        <div class="btn-group">
            <button id="btnSelectAll" class="outline" style="border-color:var(--accent); color:var(--accent);">Marcar Todos</button>
            <button id="btnDeselectAll" class="outline" style="border-color:#f1f5f9; color:#f1f5f9;">Desmarcar Todos</button> 
        </div>
    </div>
    <div id="playersList"></div>
  </div>

  <div class="box" id="matchControlBox" style="border: 1px solid var(--primary);">
    <h2 style="color: var(--primary);" id="matchControlTitle">‚ö° Generar Partido</h2>
    <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:15px;" id="matchControlSubtitle">
        Genera 5 opciones para seleccionar las 3 mejores para la votaci√≥n.
    </p>
    
    <button id="btnGenerateTeams" class="primary" style="font-size: 1.1rem; box-shadow: 0 0 20px rgba(6,182,212,0.3);">üé≤ Generar 5 Opciones de Equipo</button>
    <div id="generateError" class="error-msg"></div>

    <div id="teamsResult" style="margin-top:20px;">
        </div>
  </div>

  <div id="fieldSection" class="box hidden" style="background: #f1f5f9; color: #1e293b;">
    <h2 style="text-align:center; color:#1e293b;">Pizarra T√°ctica (Campo Unificado)</h2>
    <p style="text-align:center; font-size:0.8rem; color:#64748b; margin-bottom:15px;">Mueve las fichas y comparte la imagen.</p>
    
    <div class="field-container" id="captureArea">
      <div id="fullField" class="full-field">
          <div class="field-line-center"></div>
          <div class="field-circle"></div>
          <div class="area-A"></div> <div class="area-B"></div> </div>
      <div style="width: 100%; display: flex; justify-content: space-between; padding: 0 10px;">
          <div style="background:#111827; color:white; padding:6px 15px; border-radius:20px; font-weight:bold; font-family:'Kanit'; font-size:0.8rem;">EQUIPO NEGRO</div>
          <div style="background:#fff; color:#111827; border:2px solid #111827; padding:6px 15px; border-radius:20px; font-weight:bold; font-family:'Kanit'; font-size:0.8rem;">EQUIPO BLANCO</div>
      </div>
    </div>

    <div style="position:sticky; bottom:0; background:transparent; padding:15px 0; z-index:100;">
        <button id="btnShareWhatsapp" class="whatsapp">üì≤ Enviar Alineaci√≥n</button>
    </div>
  </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // --- CONFIG ---
  // ! CAMBIA ESTOS DATOS POR LOS TUYOS DE SUPABASE
  const SUPABASE_URL = 'https://vayholflhqoyflbvuusa.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZheWhvbGZsaHFveWZsYnZ1dXNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNzc5NjcsImV4cCI6MjA3ODY1Mzk2N30.QxD4_XbYlQarPRUcmoQQclw8cCnnzRiHZcYzSsUXGDA' ; 
  let supabase;
  try { supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch (e) { console.error("Error Supabase", e); }

  let allPlayers = [];
  let currentUser = null;
  let currentMatchId = null; 
  let activePlayerId = null; 
  let activePlayerData = null; 
  
  // --- NUEVAS VARIABLES DE ESTADO PARA EL M√çSTER ---
  let generatedOptions = []; 
  let selectedVotingOptions = []; 


  const urlParams = new URLSearchParams(window.location.search);
  const matchLinkID = urlParams.get('match_id'); 

  // --- ELEMENTOS ---
  const authBox = document.getElementById('authBox');
  const appContent = document.getElementById('appContent');
  const addPlayerBox = document.getElementById('addPlayerBox'); // Nuevo ID
  const playerListBox = document.getElementById('playerListBox'); // Nuevo ID
  const matchControlBox = document.getElementById('matchControlBox'); // Nuevo ID
  const authMsg = document.getElementById('authMsg');
  const playersListEl = document.getElementById('playersList');
  const generateError = document.getElementById('generateError');
  const btnShare = document.getElementById('btnShareWhatsapp');
  const fullField = document.getElementById('fullField'); 

  // ELEMENTOS JUGADOR
  const playerLobby = document.getElementById('playerLobby');
  const playerCodeInput = document.getElementById('playerCodeInput');
  const btnAuthPlayer = document.getElementById('btnAuthPlayer');
  const btnEnterVoting = document.getElementById('btnEnterVoting'); 

  
  // --- EVENTOS ---
  document.getElementById('btnRegister').addEventListener('click', () => handleAuth('signup'));
  document.getElementById('btnLogin').addEventListener('click', () => handleAuth('signin'));
  document.getElementById('btnAddPlayer').addEventListener('click', addPlayer);
  document.getElementById('btnGenerateTeams').addEventListener('click', generateTeamOptions);
  document.getElementById('btnSelectAll').addEventListener('click', selectAllPlayers);
  document.getElementById('btnDeselectAll').addEventListener('click', deselectAllPlayers);
  btnShare.addEventListener('click', shareFieldsImage);

  // EVENTOS JUGADOR
  if(btnAuthPlayer) btnAuthPlayer.addEventListener('click', searchPlayerByCode);
  if(btnEnterVoting) btnEnterVoting.addEventListener('click', enterVoting); 

  
  // --- INICIALIZACI√ìN: MODO COACH o MODO JUGADOR ---
  // Este bloque decide qu√© vista cargar al abrir la p√°gina.
  supabase.auth.getSession().then(({ data: { session } }) => {
      currentUser = session ? session.user : null;

      if (matchLinkID) {
          if (session) {
              // M√çSTER: Cargar Sala de Control con match_id
              initCoachControlRoom(matchLinkID);
          } else {
              // JUGADOR: Cargar lobby de votaci√≥n con match_id
              authBox.style.display = 'none';
              appContent.style.display = 'none';
              playerLobby.classList.remove('hidden');
              currentMatchId = matchLinkID;
          }
      } else {
          if (session) {
              // M√çSTER: Cargar Dashboard Normal (Sin match_id)
              initApp();
          }
          // Si no hay sesi√≥n y no hay match_id, por defecto se muestra authBox
      }
  });


  // --- FUNCIONES UTILIDAD ---
  function selectAllPlayers() { document.querySelectorAll('.p-select').forEach(c => c.checked = true); }
  function deselectAllPlayers() { document.querySelectorAll('.p-select').forEach(c => c.checked = false); } 
  function showMsg(txt) { authMsg.textContent = txt; }
  
  function generatePlayerCode(name) {
      const cleanName = name.trim().toUpperCase().replace(/[^A-Z0-9]/g, '');
      const shortName = cleanName.substring(0, Math.min(cleanName.length, 4));
      const randomNum = Math.floor(10 + Math.random() * 89);
      return `${shortName}${randomNum}`;
  }
  
  // --- AUTH (COACH) ---
  async function handleAuth(type) { 
    const email = document.getElementById('authEmail').value.trim();
    const password = document.getElementById('authPassword').value;
    
    authMsg.style.color = '#94a3b8';
    if (!email || !password) return showMsg('‚ö†Ô∏è Rellena los datos');
    
    showMsg('‚è≥ Conectando...');
    let res = type === 'signup' ? await supabase.auth.signUp({ email, password }) : await supabase.auth.signInWithPassword({ email, password });

    if (res.error) {
        authMsg.style.color = '#ef4444';
        showMsg(res.error.message);
    } else { 
        currentUser = res.data.user; 
        showMsg('‚úÖ ¬°Vamos!'); 
        setTimeout(initApp, 500); // Llama a initApp despu√©s de iniciar sesi√≥n
    }
  }
  
  // Inicializa la vista normal del M√≠ster
  async function initApp() { 
      authBox.style.display = 'none'; 
      appContent.classList.remove('hidden'); 
      appContent.style.display = 'block'; // <--- CORRECCI√ìN CLAVE
      
      // Asegurarse de que todos los bloques del dashboard normal est√©n visibles
      if(addPlayerBox) addPlayerBox.style.display = 'block';
      if(playerListBox) playerListBox.style.display = 'block';
      
      // Reiniciar t√≠tulo del Control Box (por si viene de una Sala de Control)
      document.getElementById('matchControlTitle').textContent = '‚ö° Generar Partido';
      document.getElementById('matchControlSubtitle').textContent = 'Genera 5 opciones para seleccionar las 3 mejores para la votaci√≥n.';
      document.getElementById('btnGenerateTeams').style.display = 'block';
      document.getElementById('teamsResult').innerHTML = ''; // Limpiar resultados de Sala de Control

      await loadPlayers(); 
  }

  // --- SALA DE CONTROL DEL M√çSTER (NUEVA) ---
  async function initCoachControlRoom(matchId) {
    currentMatchId = matchId;
    authBox.style.display = 'none';
    playerLobby.style.display = 'none';
    appContent.classList.remove('hidden');
    appContent.style.display = 'block'; // CORRECCI√ìN: Asegurar visibilidad

    // Ocultar las secciones de gesti√≥n de plantilla
    if(addPlayerBox) addPlayerBox.style.display = 'none';
    if(playerListBox) playerListBox.style.display = 'none';
    document.getElementById('btnGenerateTeams').style.display = 'none';
    
    // 1. Obtener los datos del partido
    const { data: match, error } = await supabase
        .from('matches')
        .select('teams_options, status, final_teams_result')
        .eq('id', currentMatchId)
        .eq('coach_id', currentUser.id)
        .single();
        
    if (error || !match) {
        alert("Error cargando la sala de control o no tienes permisos. Redirigiendo al dashboard.");
        // Redirigir al dashboard normal si hay error o no tiene permisos
        initApp(); 
        window.history.replaceState(null, null, window.location.pathname); // Limpiar URL
        return;
    }
    
    // Actualizar t√≠tulos
    document.getElementById('matchControlTitle').textContent = 'üìä Sala de Control';
    document.getElementById('matchControlSubtitle').textContent = 'Votaci√≥n en curso. Revisa los resultados en tiempo real.';

    if (match.status === 'final' && match.final_teams_result) {
        // Ya finaliz√≥, mostrar pizarra
        showPlayerResult(match.final_teams_result, true); 
        return;
    }

    if (match.status === 'voting' && match.teams_options && match.teams_options.length === 3) {
        // 2. M√≠ster en el modo Votaci√≥n 
        generatedOptions = match.teams_options.concat(new Array(2).fill(null));
        selectedVotingOptions = [0, 1, 2]; 

        // 3. Renderizar las 3 opciones con botones de finalizar
        displayControlRoomOptions(match.teams_options); 
        
        // 4. Empezar a escuchar votos en tiempo real
        listenToVotes(); 
    }
  }

  // --- JUGADORES Y LISTA (COACH) ---
  async function loadPlayers() { 
    if (!currentUser) return;
    const { data } = await supabase.from('players').select('*').eq('user_id', currentUser.id);
    allPlayers = data || [];
    renderList();
  }

  // A√ëADIR JUGADOR (CON C√ìDIGO)
  async function addPlayer() { 
    const nameIn = document.getElementById('playerName');
    const skillIn = document.getElementById('playerSkill');
    const posIn = document.getElementById('playerPosition');
    
    const name = nameIn.value.trim();
    const rating = parseFloat(skillIn.value);
    const position = posIn.value;

    if (!name || !rating) return alert('Datos incompletos');
    
    const playerCode = generatePlayerCode(name); 
    const newPlayer = { user_id: currentUser.id, name, position, rating, player_code: playerCode };

    const { data, error } = await supabase.from('players').insert([newPlayer]).select();
    
    if (error) {
        console.error('Error insertando en Supabase:', error);
        alert('Error al guardar el jugador. Comprueba la consola.');
        return;
    }
    
    if(data && data.length) {
        allPlayers.push(data[0]); 
        nameIn.value = ''; 
        skillIn.value = '';
        renderList();
    }
  }

  // ELIMINAR JUGADOR
  async function deletePlayer(playerId) {
      if (!playerId) return;

      if (!confirm("¬øEliminar jugador de la plantilla?")) return;

      const { error } = await supabase.from('players').delete().eq('id', String(playerId));

      if (error) {
          console.error("Error al eliminar:", error);
          alert('Error al eliminar. ' + error.message);
          return;
      }

      allPlayers = allPlayers.filter(p => String(p.id) !== String(playerId));
      renderList();
  }

  // RENDERIZAR LISTA (MOSTRANDO C√ìDIGO)
  function renderList() { 
    playersListEl.innerHTML = '';
    document.getElementById('playerCount').textContent = `(${allPlayers.length})`;
    const order = { portero: 1, defensa: 2, delantero: 3 };
    
    [...allPlayers].sort((a,b) => order[a.position] - order[b.position] || b.rating - a.rating).forEach(p => {
      const playerId = p.id; 
      const isDisabled = !playerId;
      
      const div = document.createElement('div');
      div.className = 'player-row';
      div.innerHTML = `
        <div style="display:flex; align-items:center;">
          <input type="checkbox" class="p-select" checked value="${p.id}" ${isDisabled ? 'disabled' : ''}>
          <div>
              <span style="font-weight:600; font-size:1rem; color:#f1f5f9;">${p.name}</span>
              <span class="tag ${p.position}">${p.position}</span>
              <span class="tag" style="background:#334155; color:var(--accent); margin-left:10px; font-size:11px;">C√ìDIGO: ${p.player_code || 'N/A'}</span>
          </div>
        </div>
        <div style="display:flex; align-items:center; gap: 10px;">
            <div class="rating-badge">${p.rating}</div>
            <button class="outline delete-btn" data-id="${playerId}" style="border-color:#ef4444; color:#ef4444; padding: 4px 8px; font-size:0.7rem; width: auto; margin:0;" ${isDisabled ? 'disabled' : ''}>
                üóëÔ∏è
            </button>
        </div>
      `;
      playersListEl.appendChild(div);
    });

    document.querySelectorAll('.delete-btn').forEach(button => {
        if (!button.disabled) {
            button.addEventListener('click', (e) => {
                const idToDelete = e.currentTarget.dataset.id;
                if (idToDelete) deletePlayer(idToDelete);
            });
        }
    });
  }

  // --- GENERACI√ìN DE EQUIPOS (COACH) Y SELECCI√ìN DE 5 OPCIONES ---
  function generateTeamOptions() { 
    generateError.style.display = 'none';
    const checks = document.querySelectorAll('.p-select:checked');
    
    const selectedIds = Array.from(checks).map(c => c.value);
    
    const pool = allPlayers.filter(p => selectedIds.includes(String(p.id)));

    if (pool.length < 14) { showError('Selecciona al menos 14 jugadores para 7vs7.'); return; }
    
    const count = (pos) => pool.filter(p => p.position === pos).length;
    if (count('portero') < 2) { showError('Faltan Porteros. M√≠nimo 2.'); return; }
    if (count('defensa') < 6) { showError('Faltan Defensas. M√≠nimo 6 (3 por equipo).'); return; }
    if (count('delantero') < 2) { showError('Faltan Delanteros. M√≠nimo 2 (1 por equipo).'); return; }

    let variations = [];
    const seenHashes = new Set(); 

    for(let i=0; i<500; i++) { 
        const attempt = createStrictMatch(pool);
        if(!attempt) continue;
        
        const idsA = attempt.teamA.map(p => String(p.id)).sort().join('-');
        const idsB = attempt.teamB.map(p => String(p.id)).sort().join('-');
        const hash = [idsA, idsB].sort().join('::');

        if(seenHashes.has(hash)) continue; 
        seenHashes.add(hash);
        variations.push(attempt);
    }

    variations.sort((a, b) => a.diff - b.diff); 
    // AHORA SELECCIONAMOS LAS TOP 5
    generatedOptions = variations.slice(0, 5); 

    if (generatedOptions.length === 0) { showError("Error generando combinaciones."); return; }
    
    selectedVotingOptions = []; // Resetear selecci√≥n
    displayOptionsForSelection(generatedOptions); 
    updatePublishButtonState();
  }

  function showError(msg) { generateError.textContent = msg; generateError.style.display = 'block'; }
  function shuffle(arr) { return [...arr].sort(() => Math.random() - 0.5); }
  
  function createStrictMatch(originalPool) {
    const gks = shuffle(originalPool.filter(p => p.position === 'portero'));
    const defs = shuffle(originalPool.filter(p => p.position === 'defensa'));
    const fwds = shuffle(originalPool.filter(p => p.position === 'delantero'));

    const teamA = []; const teamB = [];

    teamA.push(gks.pop()); teamB.push(gks.pop());            
    for(let k=0;k<3;k++) { teamA.push(defs.pop()); teamB.push(defs.pop()); } 
    teamA.push(fwds.pop()); teamB.push(fwds.pop());             

    let leftovers = [...gks, ...defs, ...fwds]; 
    leftovers = shuffle(leftovers);

    while(leftovers.length > 0) {
        if(teamA.length <= teamB.length) teamA.push(leftovers.pop());
        else teamB.push(leftovers.pop());
    }
    
    const getAvg = t => t.reduce((a,c)=>a+c.rating,0) / t.length;
    const avgA = getAvg(teamA); const avgB = getAvg(teamB);

    return { teamA, teamB, avgA: avgA.toFixed(2), avgB: avgB.toFixed(2), diff: Math.abs(avgA - avgB) };
  }


  // --- MANEJO DE SELECCI√ìN DE OPCIONES (COACH) ---
  
  // RENDERIZAR OPCIONES PARA SELECCI√ìN
  function displayOptionsForSelection(options) {
      const container = document.getElementById('teamsResult');
      container.innerHTML = `
          <h3 style="color:var(--accent); margin-top:20px;">Elige 3 Opciones para Votar</h3>
          <p id="selectionStatus" style="color:var(--text-muted); font-size:0.85rem;">Seleccionadas: 0/3</p>
          <div id="selectionOptionsContainer"></div>
          <button id="btnPublishOptions" class="secondary" style="margin-top:20px; font-size: 1.1rem;" disabled>
              üöÄ Publicar Opciones y Obtener Link
          </button>
      `;
      
      const selectionContainer = document.getElementById('selectionOptionsContainer');
      
      options.forEach((opt, index) => {
          if (!opt) return; 
          
          const isSelected = selectedVotingOptions.includes(index);
          const btnClass = isSelected ? 'selected primary' : 'secondary';
          
          const div = document.createElement('div');
          div.className = 'option-card';
          div.id = `option-card-${index}`; 
          div.innerHTML = `
              <div style="display:flex; justify-content:space-between; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px; margin-bottom:10px;">
                  <h4 style="margin:0; color:var(--primary);">Opci√≥n ${index + 1}</h4>
                  <span class="tag" style="background:#334155; color:#fff;">Dif: ${opt.diff.toFixed(2)}</span>
              </div>
              
              <p class="vote-status" style="margin:10px 0 0 0; font-weight:bold; color:var(--accent); font-size:0.9rem;"></p>

              <div class="team-columns">
                  <div class="team-col"><strong style="color:#94a3b8">Negro (${opt.avgA})</strong><ul>${renderListSimple(opt.teamA)}</ul></div>
                  <div class="team-col"><strong style="color:#f1f5f9">Blanco (${opt.avgB})</strong><ul>${renderListSimple(opt.teamB)}</ul></div>
              </div>
              <button class="select-btn ${btnClass}" data-index="${index}" style="margin-top:15px; width:100%; font-size:0.9rem;">
                  ${isSelected ? '‚úÖ Opci√≥n Seleccionada' : '‚ûï Seleccionar para Votaci√≥n'}
              </button>
          `;
          selectionContainer.appendChild(div);
      });

      document.querySelectorAll('.select-btn').forEach(btn => {
          btn.addEventListener('click', handleOptionSelection);
      });
      
      document.getElementById('btnPublishOptions').addEventListener('click', publishVotingOptions);
  }

  // MANEJO DE SELECCI√ìN DE OPCIONES
  function handleOptionSelection(e) {
      const btn = e.currentTarget;
      const index = parseInt(btn.dataset.index);
      const card = document.getElementById(`option-card-${index}`);

      if (selectedVotingOptions.includes(index)) {
          // Deseleccionar
          selectedVotingOptions = selectedVotingOptions.filter(i => i !== index);
          btn.classList.remove('selected', 'primary');
          btn.classList.add('secondary');
          btn.innerHTML = '‚ûï Seleccionar para Votaci√≥n';
          btn.style.background = '#334155';
          card.style.border = '1px solid rgba(255,255,255,0.05)';
      } else {
          // Seleccionar
          if (selectedVotingOptions.length >= 3) {
              alert("Solo puedes seleccionar hasta 3 opciones para la votaci√≥n.");
              return;
          }
          selectedVotingOptions.push(index);
          btn.classList.add('selected', 'primary');
          btn.classList.remove('secondary');
          btn.innerHTML = '‚úÖ Opci√≥n Seleccionada';
          btn.style.background = 'var(--accent)';
          btn.style.color = '#000';
          card.style.border = '1px solid var(--accent)';
      }

      updatePublishButtonState();
  }

  // ACTUALIZAR ESTADO DEL BOT√ìN PUBLICAR
  function updatePublishButtonState() {
      const statusEl = document.getElementById('selectionStatus');
      const publishBtn = document.getElementById('btnPublishOptions');
      
      statusEl.textContent = `Seleccionadas: ${selectedVotingOptions.length}/3`;
      
      if (selectedVotingOptions.length === 3) {
          publishBtn.disabled = false;
          publishBtn.classList.add('primary');
          publishBtn.classList.remove('secondary');
          statusEl.style.color = 'var(--accent)';
      } else {
          publishBtn.disabled = true;
          publishBtn.classList.remove('primary');
          publishBtn.classList.add('secondary');
          statusEl.style.color = '#f87171'; // Rojo si falta
      }
  }
  
  // PUBLICAR OPCIONES Y OBTENER LINK (ACTUALIZADA con Redirecci√≥n a Sala de Control)
  async function publishVotingOptions() {
      if (selectedVotingOptions.length !== 3) {
          return alert("Debes seleccionar exactamente 3 opciones antes de publicar.");
      }
      
      const publishBtn = document.getElementById('btnPublishOptions');
      publishBtn.innerHTML = '‚è≥ Publicando...';
      publishBtn.disabled = true;
      
      const finalOptionsToPublish = selectedVotingOptions.map(index => generatedOptions[index]);

      // 1. Crear el ID del partido si no existe
      if (!currentMatchId) {
          const { data, error } = await supabase
              .from('matches')
              .insert([{ coach_id: currentUser.id, status: 'created' }])
              .select()
              .single();

          if (error) { 
              alert("Error creando la sala del partido.");
              publishBtn.innerHTML = 'Error'; 
              return; 
          }
          currentMatchId = data.id;
      }

      // 2. Subir las opciones y cambiar el estado a 'voting'
      const { error: updateError } = await supabase
          .from('matches')
          .update({ 
              status: 'voting', 
              teams_options: finalOptionsToPublish, 
              final_teams_result: null 
          })
          .eq('id', currentMatchId);

      if (updateError) {
          alert("Error al subir las opciones de voto.");
          publishBtn.innerHTML = 'Error';
          return;
      }

      // 3. Generar Enlace y Mostrar Modal de Compartir
      const controlLink = `${window.location.origin}${window.location.pathname}?match_id=${currentMatchId}`;
      
      showShareModal(controlLink);
      
      // 4. Redireccionamos al M√≠ster a la Sala de Control
      setTimeout(() => {
          window.location.href = controlLink;
      }, 100); 
  }
  
  // FUNCI√ìN PARA MOSTRAR LAS OPCIONES DE COMPARTIR
  function showShareModal(link) {
      const defaultMessage = `‚öΩ ¬°A VOTAR! El M√≠ster ha publicado las opciones de equipo. Usa este enlace para votar:`;
      const whatsappLink = `whatsapp://send?text=${encodeURIComponent(defaultMessage)}\n${encodeURIComponent(link)}`;
      
      if (navigator.share) {
          navigator.share({
              title: 'Votaci√≥n F√∫tbol 7',
              text: defaultMessage,
              url: link,
          }).catch((error) => {
               showAdvancedAlert(link, whatsappLink);
          });
      } else {
          showAdvancedAlert(link, whatsappLink);
      }
  }

  // Funci√≥n auxiliar para mostrar el enlace cuando el nativo falla o en desktop
  function showAdvancedAlert(link, whatsappLink) {
      const linkDisplay = "---------------------------\n" + link + "\n---------------------------";
      
      alert(
          "¬°Opciones Publicadas! Ahora comparte el enlace:\n\n" + 
          linkDisplay +
          "\n\nüëâ Para copiar: presiona OK y el enlace se copiar√° autom√°ticamente.\nüëâ Para enviar por WhatsApp: copia el enlace y p√©galo en tu chat."
      );
      
      // Intentar copiar al portapapeles (se ejecuta despu√©s del primer alert)
      navigator.clipboard.writeText(link).then(() => {
          // √âxito al copiar (la notificaci√≥n se realiza en el alert anterior)
      }).catch(err => {
          console.error("Error al copiar link:", err);
      });
  }

  // --- FUNCI√ìN: RENDERIZAR OPCIONES EN LA SALA DE CONTROL (NUEVA) ---
  function displayControlRoomOptions(options) {
      const container = document.getElementById('teamsResult');
      
      // Contenido de la Sala de Control
      container.innerHTML = `
          <div class="box" style="border: 1px solid var(--primary); margin-top:20px;">
              <h2 style="color: var(--primary);">üìä Sala de Control (Votaci√≥n)</h2>
              <p style="color:var(--text-muted); font-size:0.85rem; margin-bottom:20px;">
                  Enlace de votaci√≥n: <strong style="color:var(--accent);"><span id="matchLinkSpan">${window.location.href}</span></strong>
              </p>
              <div id="controlOptionsContainer"></div>
              <button id="btnFinalizeTeam" class="primary" style="margin-top:30px; font-size: 1.1rem; background: var(--accent); color:#000; box-shadow: 0 0 20px rgba(163, 230, 53, 0.4);">
                  ‚≠ê Finalizar Votaci√≥n y Elegir Equipo
              </button>
          </div>
      `;
      
      const controlContainer = document.getElementById('controlOptionsContainer');
      options.forEach((opt, index) => {
          const div = document.createElement('div');
          div.className = 'option-card';
          div.id = `option-card-${index}`; 
          div.style.border = '1px solid var(--accent)';
          div.innerHTML = `
              <div style="display:flex; justify-content:space-between; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px; margin-bottom:10px;">
                  <h4 style="margin:0; color:var(--primary);">Opci√≥n ${index + 1}</h4>
                  <span class="tag" style="background:#334155; color:#fff;">Dif: ${opt.diff.toFixed(2)}</span>
              </div>
              
              <p class="vote-status" style="margin:10px 0 0 0; font-weight:bold; color:var(--accent); font-size:1.1rem;">Cargando votos...</p>

              <div class="team-columns">
                  <div class="team-col"><strong style="color:#94a3b8">Negro (${opt.avgA})</strong><ul>${renderListSimple(opt.teamA)}</ul></div>
                  <div class="team-col"><strong style="color:#f1f5f9">Blanco (${opt.avgB})</strong><ul>${renderListSimple(opt.teamB)}</ul></div>
              </div>
          `;
          controlContainer.appendChild(div);
      });

      document.getElementById('btnFinalizeTeam').addEventListener('click', () => {
          const voteCounts = {};
          // Solo contamos las opciones que se est√°n mostrando (las 3 publicadas)
          options.forEach((_, index) => voteCounts[index] = 0);
          allVotes.forEach(vote => {
              const votedIndex = parseInt(vote.option_index);
              if (votedIndex >= 0 && votedIndex < options.length) {
                voteCounts[votedIndex]++;
              }
          });
          showFinalizeModal(voteCounts);
      });
  }

  // --- VOTOS EN TIEMPO REAL (COACH) ---
  let allVotes = [];
  function listenToVotes() {
      // Remover subscripci√≥n anterior si existe
      supabase.removeChannel(supabase.channel('vote-room'));
      
      // Escucha solo votos para el partido actual
      supabase
      .channel('vote-room')
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'match_votes', filter: `match_id=eq.${currentMatchId}` }, payload => {
          allVotes.push(payload.new);
          updateVoteDisplay();
      })
      .subscribe();
      
      // Cargar votos existentes al iniciar la escucha
      supabase.from('match_votes').select('option_index').eq('match_id', currentMatchId)
          .then(({ data }) => {
              allVotes = data || [];
              updateVoteDisplay();
          });
  }
  
  function updateVoteDisplay() {
      // El array selectedVotingOptions contiene los √≠ndices de las 3 opciones publicadas
      const optionsToMonitor = selectedVotingOptions; 
      
      const voteCounts = {};
      optionsToMonitor.forEach(index => voteCounts[index] = 0);
      allVotes.forEach(vote => {
          if (vote.option_index !== undefined) {
              const votedIndex = parseInt(vote.option_index);
              if (optionsToMonitor.includes(votedIndex)) {
                voteCounts[votedIndex]++;
              }
          }
      });
      
      const totalVotes = allVotes.length;
      
      optionsToMonitor.forEach(index => {
          const votes = voteCounts[index] || 0;
          const percentage = totalVotes > 0 ? ((votes / totalVotes) * 100).toFixed(1) : 0;
          
          // El ID de la tarjeta en la Sala de Control es el √≠ndice de la opci√≥n generada
          const card = document.getElementById(`option-card-${index}`);
          if (card) {
              let voteStatusEl = card.querySelector('.vote-status');
              if (voteStatusEl) {
                  voteStatusEl.innerHTML = `Votos: ${votes} (${percentage}%)`;
              }
          }
      });
  }

  function showFinalizeModal(voteCounts) {
      const totalVotes = allVotes.length;
      
      const optionsInfo = selectedVotingOptions.map(index => {
          const opt = generatedOptions[index];
          const votes = voteCounts[index] || 0;
          const percentage = totalVotes > 0 ? ((votes / totalVotes) * 100).toFixed(1) : 0;
          return { index, opt, votes, percentage };
      });
      
      let alertMessage = "Resultados de Votaci√≥n:\n\n";
      optionsInfo.forEach((info, idx) => {
          alertMessage += `Opci√≥n ${idx + 1} (Dif. ${info.opt.diff.toFixed(2)}): ${info.votes} Votos (${info.percentage}%) \n`;
      });
      alertMessage += "\nIntroduce el n√∫mero de la opci√≥n que eliges como final (1, 2 o 3).";
      
      let choice = prompt(alertMessage);
      const chosenOptionIndex = parseInt(choice); // Mapear 1, 2, 3

      if(choice !== null && chosenOptionIndex >= 1 && chosenOptionIndex <= optionsInfo.length) {
          // El √≠ndice de la opci√≥n ganadora en el array de generatedOptions (0, 1, 2)
          const winningOptionIndex = optionsInfo[chosenOptionIndex - 1].index;
          finalizeTeam(winningOptionIndex); 
      } else if (choice !== null) {
          alert("Opci√≥n no v√°lida. Int√©ntalo de nuevo.");
      }
  }
  
  // PUBLICAR RESULTADO FINAL (COACH)
  window.finalizeTeam = async function (winningGeneratedIndex) { 
      if (!currentMatchId || generatedOptions.length === 0) return alert("Error: No hay opciones generadas o ID de partido.");
      
      // La opci√≥n ganadora se obtiene del array principal `generatedOptions` usando el √≠ndice
      const winningOption = generatedOptions[winningGeneratedIndex];
      
      const { error } = await supabase
          .from('matches')
          .update({ 
              status: 'final', 
              final_teams_result: winningOption 
          })
          .eq('id', currentMatchId);
          
      if (error) return console.error("Error al finalizar el equipo:", error);

      alert(`¬°Opci√≥n ${winningGeneratedIndex + 1} publicada como equipo final!`);
      // Ocultamos la vista de opciones y forzamos la vista de la pizarra
      document.getElementById('teamsResult').innerHTML = ''; 
      showPlayerResult(winningOption, true); 
  }


  function renderListSimple(t) {
    const order={portero:0,defensa:1,delantero:2};
    // No mostramos rating ni posici√≥n en esta lista, solo nombre
    return [...t].sort((a,b)=>order[a.position]-order[b.position]).map(p=>`<li><span>${p.name}</span></li>`).join('');
  }

  // --- MODO JUGADOR: AUTENTICACI√ìN Y VOTACI√ìN ---
  async function searchPlayerByCode() {
      const code = playerCodeInput.value.trim().toUpperCase();
      if (!code) return alert("Introduce tu c√≥digo de jugador.");

      const { data, error } = await supabase
          .from('players')
          .select('*')
          .eq('player_code', code)
          .single();

      if (error || !data) {
          document.getElementById('playerFound').classList.add('hidden');
          return alert("C√≥digo no encontrado. Revisa tu c√≥digo.");
      }

      activePlayerData = data;
      activePlayerId = data.id;

      document.getElementById('foundPlayerName').textContent = data.name;
      
      document.getElementById('playerFound').classList.remove('hidden');
      playerCodeInput.disabled = true;
      btnAuthPlayer.disabled = true;
  }

  async function enterVoting() {
      document.getElementById('playerAuthForm').classList.add('hidden');
      document.getElementById('votingView').classList.remove('hidden');
      document.getElementById('lobbyStatus').textContent = "Selecciona tu opci√≥n favorita.";

      await fetchVotingOptions();
      listenToMatchStatus();
  }

  async function fetchVotingOptions() {
      const { data, error } = await supabase
          .from('matches')
          .select('teams_options, status, final_teams_result')
          .eq('id', currentMatchId)
          .single();
      
      const container = document.getElementById('votingOptionsContainer');
      container.innerHTML = '';
      
      if (data && data.status === 'final' && data.final_teams_result) {
          // Si ya hay resultado final publicado, vamos directo a la pizarra
          showPlayerResult(data.final_teams_result);
          return;
      }

      if (error || !data || !data.teams_options || data.teams_options.length === 0) {
          container.innerHTML = '<p style="color:#f87171;">El M√≠ster a√∫n no ha publicado las opciones de voto. Esperando...</p>';
          listenToMatchStatus(true); 
          return;
      }
      
      // Comprobar si ya vot√≥
      const { data: voteData } = await supabase
          .from('match_votes')
          .select('id')
          .eq('match_id', currentMatchId)
          .eq('player_id', activePlayerId)
          .single();
          
      if (voteData) {
          document.getElementById('votingView').classList.add('hidden');
          document.getElementById('waitingScreen').classList.remove('hidden');
          document.getElementById('waitingScreen p').textContent = "Ya hab√≠as votado. Esperando que el M√≠ster publique la alineaci√≥n final...";
          return;
      }

      renderVotingOptions(data.teams_options);
  }

  function renderVotingOptions(options) {
      const container = document.getElementById('votingOptionsContainer');
      container.innerHTML = '';
      
      options.forEach((opt, index) => {
          const div = document.createElement('div');
          div.className = 'option-card';
          div.innerHTML = `
              <h4 style="margin:0; color:var(--primary);">Opci√≥n ${index + 1}</h4>
              <p style="font-size:0.8rem; color:var(--text-muted);">Diferencia de media: <span class="tag" style="background:#334155; color:#fff;">${opt.diff.toFixed(2)}</span></p>
              
              <div class="team-columns">
                  <div class="team-col"><strong style="color:#94a3b8">Negro (${opt.avgA})</strong><ul>${renderListSimple(opt.teamA)}</ul></div>
                  <div class="team-col"><strong style="color:#f1f5f9">Blanco (${opt.avgB})</strong><ul>${renderListSimple(opt.teamB)}</ul></div>
              </div>

              <button class="primary vote-btn" data-option="${index}" style="margin-top:15px; width:100%; font-size: 1.1rem;">üó≥Ô∏è Votar por esta</button>
          `;
          container.appendChild(div);
      });

      document.querySelectorAll('.vote-btn').forEach(btn => {
          btn.addEventListener('click', handleVote);
      });
  }

  async function handleVote(e) {
      const optionIndex = parseInt(e.currentTarget.dataset.option);
      
      if (!activePlayerId || !currentMatchId) return alert("Error de sesi√≥n. Vuelve a introducir tu c√≥digo.");

      const { error } = await supabase
          .from('match_votes')
          .insert([{ 
              match_id: currentMatchId, 
              player_id: activePlayerId,
              option_index: optionIndex
          }]);

      if(error && error.code === '23505') { 
          // Ya vot√≥
      } else if (error) {
          console.error(error);
          alert("Error al registrar el voto.");
          return;
      } 
      
      // Voto exitoso o ya votado: pasar a la pantalla de espera
      document.getElementById('votingView').classList.add('hidden');
      document.getElementById('waitingScreen').classList.remove('hidden');
  }

  function listenToMatchStatus(isInitialFetch = false) {
      supabase.removeChannel(supabase.channel('match-updates'));
      
      supabase
      .channel('match-updates')
      .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'matches', filter: `id=eq.${currentMatchId}` }, payload => {
          const matchData = payload.new;
          
          if (matchData.status === 'final' && matchData.final_teams_result) {
              // El m√≠ster ha publicado el resultado final
              showPlayerResult(matchData.final_teams_result);
          } else if (isInitialFetch && matchData.status === 'voting' && matchData.teams_options) {
               // El m√≠ster acaba de publicar las opciones de voto
              fetchVotingOptions();
          }
      })
      .subscribe();
  }

  function showPlayerResult(resultData, isCoachView = false) {
      if (!isCoachView) {
          playerLobby.style.display = 'none';
      }
      appContent.classList.remove('hidden');
      
      document.querySelectorAll('.box').forEach(b => {
         // Oculta todas las cajas del Coach excepto la Pizarra
         if(b.id !== 'fieldSection' && b.id !== 'authBox') b.style.display = 'none';
      });
      
      const fieldSection = document.getElementById('fieldSection');
      fieldSection.classList.remove('hidden');
      fieldSection.style.display = 'block';
      
      const fieldPlaceholder = document.getElementById('fullField');
      
      // Limpiar pizarra
      fieldPlaceholder.querySelectorAll('.player-token').forEach(e => e.remove());
      
      // Dibujar equipos
      drawTeamOnUnifiedField(resultData.teamA, 'token-black', 'bottom', fieldPlaceholder);
      drawTeamOnUnifiedField(resultData.teamB, 'token-white', 'top', fieldPlaceholder);
      
      // Mostrar mensaje al jugador
      if (!isCoachView) {
          const isInTeamA = resultData.teamA.some(p => String(p.id) === String(activePlayerId));
          const isInTeamB = resultData.teamB.some(p => String(p.id) === String(activePlayerId));

          let teamColor = 'SUPLENTE (no convocado)';
          if (isInTeamA) { teamColor = 'NEGRO'; }
          else if (isInTeamB) { teamColor = 'BLANCO'; }
          
          let resultMessage = document.querySelector('#fieldSection h3.result-msg');
          if (!resultMessage) {
              resultMessage = document.createElement('h3');
              resultMessage.className = 'result-msg';
              resultMessage.style.textAlign = 'center';
              fieldPlaceholder.before(resultMessage);
          }
          resultMessage.style.color = teamColor === 'NEGRO' ? '#334155' : (teamColor === 'BLANCO' ? '#f1f5f9' : '#94a3b8');
          resultMessage.textContent = `¬°Est√°s en el EQUIPO ${teamColor}!`;
      } else {
          // Ocultar mensaje del jugador si es el m√≠ster
          let resultMessage = document.querySelector('#fieldSection h3.result-msg');
          if(resultMessage) resultMessage.remove();
      }
      
      fieldSection.scrollIntoView({behavior: "smooth"});
  }


  // --- PIZARRA T√ÅCTICA (DRAG & DROP Y RENDERIZADO) ---
  function drawTeamOnUnifiedField(team, colorClass, half, targetField) { 
    const isBottomHalf = half === 'bottom';
    
    // Coordenadas fijas OBLIGATORIAS (Esqueleto 1-3-1)
    const coordsFixed = {
        portero:    [{x:140, y: isBottomHalf ? 520 : 40}], 
        defensa:    [
            {x:50, y: isBottomHalf ? 450 : 100}, 
            {x:140, y: isBottomHalf ? 450 : 100}, 
            {x:230, y: isBottomHalf ? 450 : 100}
        ], 
        delantero: [{x:140, y: isBottomHalf ? 350 : 200}] 
    };
    const slots = JSON.parse(JSON.stringify(coordsFixed));
    
    const fillerPositions = {
        delantero: [ 
            {x: 80, y: isBottomHalf ? 380 : 220},
            {x: 200, y: isBottomHalf ? 380 : 220},
            {x: 140, y: isBottomHalf ? 400 : 200},
        ],
        defensa: [ 
            {x: 50, y: isBottomHalf ? 490 : 60}, 
            {x: 230, y: isBottomHalf ? 490 : 60}, 
        ]
    };
    
    const usedFillerSpots = { delantero: 0, defensa: 0 };
    
    team.forEach(p => {
        let pos = null;
        
        if (slots[p.position] && slots[p.position].length > 0) {
            pos = slots[p.position].shift();
        } else if (p.position === 'delantero' && usedFillerSpots.delantero < fillerPositions.delantero.length) {
            pos = fillerPositions.delantero[usedFillerSpots.delantero];
            usedFillerSpots.delantero++;
        } else if (p.position === 'defensa' && usedFillerSpots.defensa < fillerPositions.defensa.length) {
            pos = fillerPositions.defensa[usedFillerSpots.defensa];
            usedFillerSpots.defensa++;
        } else {
            const yCenter = isBottomHalf ? 300 + Math.random() * 50 : 250 + Math.random() * 50;
            pos = {x: 60 + Math.random() * 200, y: yCenter};
        }
        
        createToken(p, targetField, colorClass, pos.x, pos.y); 
    });
  }

  function createToken(p, div, cls, x, y) {
    const el = document.createElement('div');
    el.className = `player-token ${cls}`;
    el.textContent = p.name.substring(0,2).toUpperCase();
    el.style.left = x+'px'; el.style.top = y+'px';
    
    if (matchLinkID && String(p.id) === String(activePlayerId)) {
        el.style.boxShadow = '0 0 10px 5px var(--accent)';
    }

    const l = document.createElement('div'); l.className='player-label'; l.textContent=p.name;
    el.appendChild(l);
    
    // Solo permitimos arrastrar en el modo entrenador 
    if (currentUser) {
        el.addEventListener('mousedown', startDrag);
        el.addEventListener('touchstart', startDrag, {passive: false});
    } else {
        el.style.cursor = 'default';
    }

    div.appendChild(el);
  }

  // L√≥gica Drag & Drop (Sin cambios)
  let activeItem = null; let activeContainer = null;
  let initialX, initialY, xOffset = 0, yOffset = 0;

  function startDrag(e) {
    const evt = e.type === 'touchstart' ? e.touches[0] : e;
    initialX = evt.clientX - xOffset; initialY = evt.clientY - yOffset;
    activeItem = e.currentTarget;
    activeContainer = activeItem.parentElement;
    
    const rect = activeItem.getBoundingClientRect();
    const parentRect = activeContainer.getBoundingClientRect();
    const offsetX = evt.clientX - rect.left;
    const offsetY = evt.clientY - rect.top;
    
    const moveHandler = (moveEvent) => {
        moveEvent.preventDefault(); 
        const mv = moveEvent.type === 'touchmove' ? moveEvent.touches[0] : moveEvent;
        
        let newLeft = mv.clientX - parentRect.left - offsetX;
        let newTop = mv.clientY - parentRect.top - offsetY;
        
        newLeft = Math.max(0, Math.min(newLeft, 320 - 42)); 
        newTop = Math.max(0, Math.min(newTop, 600 - 42));
        
        activeItem.style.left = newLeft + 'px'; activeItem.style.top = newTop + 'px';
    };
    
    const upHandler = () => {
        document.removeEventListener('mousemove', moveHandler); document.removeEventListener('mouseup', upHandler);
        document.removeEventListener('touchmove', moveHandler); document.removeEventListener('touchend', upHandler);
        activeItem = null;
    };
    document.addEventListener('mousemove', moveHandler); document.addEventListener('mouseup', upHandler);
    document.addEventListener('touchmove', moveHandler, {passive: false}); document.addEventListener('touchend', upHandler);
  }

  async function shareFieldsImage() {
    const element = document.getElementById('captureArea');
    const originalText = btnShare.innerHTML;
    btnShare.innerHTML = "‚ö° Generando..."; btnShare.disabled = true;
    
    try {
        const canvas = await html2canvas(element, { backgroundColor: '#e2e8f0', scale: 2, useCORS: true });
        canvas.toBlob(async (blob) => {
            const file = new File([blob], 'partido-f7.png', { type: 'image/png' });
            if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                try { await navigator.share({ files: [file], title: 'Alineaci√≥n', text: 'Aqu√≠ est√°n los equipos ‚öΩ' }); } catch (err) {}
            } else {
                const link = document.createElement('a'); link.download = 'alineacion.png'; link.href = canvas.toDataURL(); link.click();
            }
            btnShare.innerHTML = originalText; btnShare.disabled = false;
        });
    } catch (e) { alert("Error al crear imagen"); btnShare.innerHTML = originalText; btnShare.disabled = false; }
  }
});
</script>
</body>
</html>
