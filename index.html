<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="theme-color" content="#0f172a">
<title>FÃºtbol 7 Pro - Ultimate Edition | MÃ­ster</title>

<link rel="icon" href="icono.png" sizes="32x32">
<link rel="apple-touch-icon" href="icono.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" sizes="180x180" href="icono.png">
<link rel="icon" sizes="192x192" href="icono.png">
<link rel="manifest" href="/manifest.json">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;800&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* --- ESTILOS GENERALES (MANTENIDOS) --- */
Â  :root {Â 
Â  Â  --bg-dark: #0f172a;
Â  Â  --bg-card: rgba(30, 41, 59, 0.7);
Â  Â  --primary: #06b6d4;Â  Â  Â  /* Cian */
Â  Â  --accent: #a3e635;Â  Â  Â  Â /* Lima */
Â  Â  --text-main: #f8fafc;
Â  Â  --text-muted: #94a3b8;
Â  Â  --whatsapp: #25D366;
Â  Â  --glass-border: 1px solid rgba(255, 255, 255, 0.1);
Â  }

Â  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

Â  body {Â 
Â  Â  font-family: 'Inter', sans-serif;
Â  Â  background-color: var(--bg-dark);
Â  Â  background-image: radial-gradient(circle at top right, #1e293b 0%, #0f172a 100%);
Â  Â  color: var(--text-main);
Â  Â  margin: 0;Â 
Â  Â  padding: 20px 15px 120px 15px;
Â  Â  min-height: 10vh;
Â  }
Â Â 
Â  h1, h2, h3 { font-family: 'Kanit', sans-serif; margin-top: 0; letter-spacing: 0.5px; }
Â Â 
Â  h1 {Â 
Â  Â  font-weight: 800; font-size: 2rem; text-align: center; margin-bottom: 25px;Â 
Â  Â  text-transform: uppercase;
Â  Â  background: linear-gradient(to right, #22d3ee, #a3e635);
Â  Â  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
Â  Â  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
Â  }

Â  h2 { font-size: 1.4rem; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
Â Â 
Â  /* ESTILO CRISTAL (Glassmorphism) */
Â  .box {Â 
Â  Â  background: var(--bg-card);
Â  Â  backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
Â  Â  border: var(--glass-border);
Â  Â  padding: 20px; border-radius: 20px; margin-bottom: 24px;Â 
Â  Â  box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
Â  Â  animation: fadeIn 0.5s ease-out forwards;
Â  }
Â Â 
Â  /* INPUTS */
Â  input, select {Â 
Â  Â  padding: 14px; margin-bottom: 12px; border-radius: 12px;Â 
Â  Â  border: 1px solid #334155; width: 100%; font-size: 16px;Â 
Â  Â  background: #1e293b; color: #fff; transition: all 0.3s ease;
Â  Â  font-family: 'Inter', sans-serif;
Â  }
Â  input:focus, select:focus {Â 
Â  Â  border-color: var(--primary); box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.2);Â 
Â  Â  outline: none; background: #0f172a;
Â  }

Â  .row-inputs { display: flex; gap: 10px; }
Â Â 
Â  /* BOTONES */
Â  button {Â 
Â  Â  padding: 16px; border-radius: 12px; border: none; cursor: pointer;Â 
Â  Â  font-family: 'Kanit', sans-serif; font-weight: 600; font-size: 1rem;Â 
Â  Â  text-transform: uppercase; letter-spacing: 1px; width: 100%; margin-top: 10px;Â 
Â  Â  transition: transform 0.1s;
Â  }
Â  button:active { transform: scale(0.97); }
Â  button:disabled { opacity: 0.5; cursor: not-allowed; }

Â  button.primary {Â 
Â  Â  background: linear-gradient(135deg, var(--primary) 0%, #3b82f6 100%);Â 
Â  Â  color: #fff; box-shadow: 0 4px 15px rgba(6, 182, 212, 0.4);
Â  }
Â  button.secondary { background: #334155; color: var(--accent); border: 1px solid rgba(163, 230, 53, 0.2); }
Â  button.whatsapp {Â 
Â  Â  background: var(--whatsapp); color: #fff; display: flex; align-items: center; justify-content: center; gap: 10px;Â 
Â  Â  box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
Â  }
Â  button.outline {Â 
Â  Â  background: transparent; border: 1px solid var(--primary); color: var(--primary);Â 
Â  Â  font-size: 0.8rem; padding: 6px 12px; width: auto; margin: 0;
Â  }
Â  button.poll-action { background: #a3e635; color: #1e293b; font-size: 0.85rem; padding: 10px; width: auto; margin: 0; flex: 1; }

Â  /* LISTAS */
Â  .player-row {Â 
Â  Â  display: flex; justify-content: space-between; align-items: center;Â 
Â  Â  padding: 12px; margin-bottom: 8px; background: rgba(255,255,255,0.03);Â 
Â  Â  border-radius: 10px; border: 1px solid transparent;
Â  }
Â  .p-select { width: 22px; height: 22px; margin-right: 12px; accent-color: var(--accent); }
Â Â 
Â  .tag { padding: 4px 8px; border-radius: 4px; font-size: 10px; text-transform: uppercase; font-weight: 800; margin-left: 5px; }
Â  .tag.portero { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
Â  .tag.defensa { background: rgba(16, 185, 129, 0.2); color: #34d399; }
Â  .tag.delantero { background: rgba(239, 68, 68, 0.2); color: #f87171; }

Â  .rating-badge {
Â  Â  background: #0f172a; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
Â  Â  border-radius: 50%; font-weight: bold; color: var(--accent); border: 2px solid #334155; font-size: 0.9rem;
Â  }

Â  /* RESULTADOS */
Â  .option-card {Â 
Â  Â  background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.05);
Â  Â  border-radius: 16px; padding: 20px; margin-bottom: 20px;Â 
Â  Â  position: relative;
Â  }
Â  .option-card input[type="checkbox"] { 
Â  Â  position: absolute; top: 10px; right: 10px; width: 20px; height: 20px; accent-color: var(--primary);
Â  }
Â  .team-columns { display: flex; flex-direction: column; gap: 20px; margin-top: 15px; }Â 
Â  @media (min-width: 768px) { .team-columns { flex-direction: row; } }

Â  .team-col ul { padding: 0; list-style: none; }
Â  .team-col li {Â 
Â  Â  padding: 8px 0; border-bottom: 1px dashed #334155; display:flex; justify-content:space-between;Â 
Â  Â  font-size: 0.9rem; color: #cbd5e1;
Â  }

Â  /* CAMPO DE FÃšTBOL GRANDE (UNIFICADO) */
Â  .field-container {Â 
Â  Â  display: flex; flex-direction: column; align-items: center; gap: 25px;Â 
Â  Â  background: #e2e8f0; padding: 20px; border-radius: 12px; margin-top: 10px;
Â  }
Â Â 
Â  .full-field {
Â  Â  position: relative; width: 320px; height: 600px;Â 
Â  Â  background-color: #369a43;
Â  Â  /* PatrÃ³n de cÃ©sped */
Â  Â  background-image:Â 
Â  Â  Â  linear-gradient(0deg, transparent 24%, rgba(255,255,255,.1) 25%, rgba(255,255,255,.1) 26%, transparent 27%, transparent 74%, rgba(255,255,255,.1) 75%, rgba(255,255,255,.1) 76%, transparent 77%, transparent),
Â  Â  Â  repeating-linear-gradient(0deg, rgba(0,0,0,0.05) 0px, rgba(0,0,0,0.05) 50px, transparent 50px, transparent 100px);
Â  Â  border: 6px solid #fff; border-radius: 12px;
Â  Â  box-shadow: 0 10px 25px rgba(0,0,0,0.3); overflow: hidden; user-select: none;
Â  }

Â  /* LÃNEAS DEL CAMPO GRANDE */
Â  .field-line-center { position: absolute; top: 50%; left: 0; width: 100%; height: 3px; background: rgba(255,255,255,0.8); }
Â  .field-circle { position: absolute; top: 50%; left: 50%; width: 70px; height: 70px; border: 3px solid rgba(255,255,255,0.8); border-radius: 50%; transform: translate(-50%, -50%); }
Â Â 
Â  /* Ãreas de 7v7 */
Â  .area-A { position: absolute; bottom: 0; left: 50%; width: 140px; height: 60px; border: 3px solid rgba(255,255,255,0.8); border-bottom: none; transform: translateX(-50%); background: rgba(255,255,255,0.1); }
Â  .area-B { position: absolute; top: 0; left: 50%; width: 140px; height: 60px; border: 3px solid rgba(255,255,255,0.8); border-top: none; transform: translateX(-50%); background: rgba(255,255,255,0.1); }


Â  /* FICHAS JUGADORES */
Â  .player-token {
Â  Â  position: absolute; width: 42px; height: 42px; border-radius: 50%;Â 
Â  Â  display: flex; align-items: center; justify-content: center;
Â  Â  font-family: 'Kanit', sans-serif; font-size: 13px; font-weight: 800;Â 
Â  Â  cursor: grab; z-index: 10; touch-action: none;Â 
Â  Â  box-shadow: 0 4px 6px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255,255,255,0.3);
Â  Â  transition: transform 0.1s;
Â  }
Â  .player-token:active { cursor: grabbing; transform: scale(1.2); z-index: 100; }
Â Â 
Â  .token-black { background: radial-gradient(circle at 30% 30%, #374151, #111827); color: #fff; border: 2px solid #fff; }
Â  .token-white { background: radial-gradient(circle at 30% 30%, #fff, #e5e7eb); color: #111827; border: 2px solid #111827; }

Â  .player-label {
Â  Â  position: absolute; bottom: -22px; left: 50%; transform: translateX(-50%);
Â  Â  background: rgba(0,0,0,0.85); color: #fff; padding: 2px 8px; border-radius: 8px;
Â  Â  font-size: 10px; white-space: nowrap; font-weight: 600; pointer-events: none;
Â  }
Â  /* ESTILO ADICIONAL PARA EL PANEL DE VOTACIONES */
Â  .poll-card {
Â  Â  display: flex; justify-content: space-between; align-items: center;
Â  Â  padding: 15px; margin-bottom: 10px; background: rgba(255,255,255,0.05);
Â  Â  border-radius: 10px; border: 1px solid #334155;
Â  }
Â  .poll-info { flex-grow: 1; }
Â  .poll-status-tag { 
Â  Â  padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 600;
Â  Â  color: #fff; text-transform: uppercase; margin-left: 10px;
Â  }
Â  .poll-status-open { background: var(--primary); }
Â  .poll-status-closed { background: #ef4444; }
Â  .poll-actions { display: flex; gap: 8px; margin-left: 15px; }

Â  .hidden { display: none !important; }
Â  .error-msg { background: rgba(239,68,68,0.2); color: #fca5a5; padding: 12px; border-radius: 8px; border: 1px solid rgba(239,68,68,0.4); margin-top: 10px; display: none; text-align: center; }
Â  .sticky-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
Â  .btn-group { display: flex; gap: 8px; }
Â  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<h1>FÃºtbol 7 <span style="color:#fff; -webkit-text-fill-color: initial;">Pro</span></h1>

<div class="box" id="authBox" style="text-align: center;">
Â  <h2>Bienvenido MÃ­ster</h2>
Â  <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:20px;">Gestiona tu equipo como un profesional.</p>
Â Â 
Â  <input id="authEmail" type="email" placeholder="Correo electrÃ³nico">
Â  <input id="authPassword" type="password" placeholder="ContraseÃ±a">
Â Â 
Â  <button id="btnLogin" class="primary">Iniciar SesiÃ³n</button>
Â  <button id="btnRegister" class="secondary" style="margin-top:15px; background:transparent;">Registrarse</button>
Â  <div id="authMsg" style="margin-top:15px; font-size:0.8rem; min-height:20px;"></div>
</div>

<div id="appContent" class="hidden">
Â Â 
Â  Â  <div class="box">
Â  Â  <h2>ğŸ“Š Panel de Votaciones</h2>
Â  Â  <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:15px;">Gestiona los partidos activos y cerrados.</p>
Â  Â  <div id="pollDashboard">
Â  Â  Â  <p style="color:var(--text-muted); font-size:0.8rem;">Cargando votaciones...</p>
Â  Â  </div>
Â  Â  <button id="btnRefreshPolls" class="secondary" style="margin-top:10px; padding:10px;">ğŸ”„ Recargar Votaciones</button>
Â  </div>
Â  Â  <div class="box">
Â  Â  <h2>ğŸ‘¤ Nuevo Fichaje</h2>
Â  Â  <div class="row-inputs">
Â  Â  Â  <input id="playerName" placeholder="Nombre (ej. Lamine)" style="flex: 2;">
Â  Â  Â  <input id="playerSkill" type="number" placeholder="Nota" inputmode="decimal" step="0.1" style="flex: 1; text-align:center;">
Â  Â  </div>
Â  Â  <select id="playerPosition">
Â  Â  Â  Â  <option value="portero">ğŸ§¤ Portero</option>
Â  Â  Â  Â  <option value="defensa">ğŸ›¡ï¸ Defensa</option>
Â  Â  Â  Â  <option value="delantero">âš¡ Delantero</option>
Â  Â  </select>
Â  Â  <button id="btnAddPlayer" class="secondary">â• AÃ±adir a plantilla</button>
Â  </div>

Â  <div class="box">
Â  Â  <div class="sticky-header">
Â  Â  Â  Â  <h3 style="margin:0; color:var(--primary);">Convocatoria <span id="playerCount" style="color:var(--text-muted); font-size:0.9rem;"></span></h3>
Â  Â  Â  Â  <div class="btn-group">
Â  Â  Â  Â  Â  Â  <button id="btnSelectAll" class="outline" style="border-color:var(--accent); color:var(--accent);">Marcar Todos</button>
Â  Â  Â  Â  Â  Â  <button id="btnDeselectAll" class="outline" style="border-color:#f1f5f9; color:#f1f5f9;">Desmarcar Todos</button>Â 
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div id="playersList"></div>
Â  </div>

Â  <div class="box" style="border: 1px solid var(--primary);">
Â  Â  <h2 style="color: var(--primary);">âš¡ Generar Partido (5 Opciones)</h2>
Â  Â  <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:15px;">
Â  Â  Â  Â  Genera 5 opciones para que puedas elegir las 3 mejores para la votaciÃ³n.
Â  Â  </p>
Â  Â Â 
Â  Â  <button id="btnGenerateTeams" class="primary" style="font-size: 1.1rem; box-shadow: 0 0 20px rgba(6,182,212,0.3);">ğŸ² Generar Opciones</button>
Â  Â  <div id="generateError" class="error-msg"></div>

Â  Â  <div id="teamsResult" style="margin-top:20px;"></div>
Â  </div>

Â  <div id="fieldSection" class="box hidden" style="background: #f1f5f9; color: #1e293b;">
Â  Â  <h2 style="text-align:center; color:#1e293b;">Pizarra TÃ¡ctica (<span id="fieldPollName">VotaciÃ³n XXX</span>)</h2>
Â  Â  <p style="text-align:center; font-size:0.8rem; color:#64748b; margin-bottom:15px;">Arrastra las fichas para guardar la alineaciÃ³n ganadora.</p>
Â  Â Â 
Â  Â  <div class="field-container" id="captureArea">
Â  Â  Â  <div id="fullField" class="full-field">
Â  Â  Â  Â  Â  <div class="field-line-center"></div>
Â  Â  Â  Â  Â  <div class="field-circle"></div>
Â  Â  Â  Â  Â  <div class="area-A"></div> <div class="area-B"></div> </div>
Â  Â  Â  <div style="width: 100%; display: flex; justify-content: space-between; padding: 0 10px;">
Â  Â  Â  Â  Â  <div style="background:#111827; color:white; padding:6px 15px; border-radius:20px; font-weight:bold; font-family:'Kanit'; font-size:0.8rem;">EQUIPO NEGRO</div>
Â  Â  Â  Â  Â  <div style="background:#fff; color:#111827; border:2px solid #111827; padding:6px 15px; border-radius:20px; font-weight:bold; font-family:'Kanit'; font-size:0.8rem;">EQUIPO BLANCO</div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div style="position:sticky; bottom:0; background:transparent; padding:15px 0; z-index:100;">
Â  Â  Â  Â  <button id="btnShareWhatsapp" class="whatsapp">ğŸ“² Enviar Imagen de AlineaciÃ³n</button>
Â  Â  </div>
Â  </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
Â  // --- CONFIG ---
Â  const SUPABASE_URL = 'https://vayholflhqoyflbvuusa.supabase.co';
Â  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZheWhvbGZsaHFveWZsYnZ1dXNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNzc5NjcsImV4cCI6MjA3ODY1Mzk2N30.QxD4_XbYlQarPRUcmoQQclw8cCnnzRiHZcYzSsUXGDA' ;
Â  let supabase;
Â  try { supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch (e) { console.error("Error Supabase", e); }

Â  let allPlayers = [];
Â  let currentUser = null;
Â  let activePollId = null; // ID de la votaciÃ³n que se estÃ¡ visualizando/editando en la pizarra

Â  // --- ELEMENTOS ---
Â  const authBox = document.getElementById('authBox');
Â  const appContent = document.getElementById('appContent');
Â  const authMsg = document.getElementById('authMsg');
Â  const playersListEl = document.getElementById('playersList');
Â  const generateError = document.getElementById('generateError');
Â  const btnShare = document.getElementById('btnShareWhatsapp');
Â  const fullField = document.getElementById('fullField');Â 
Â  const teamsResultEl = document.getElementById('teamsResult');
Â  const pollDashboardEl = document.getElementById('pollDashboard');

Â  // --- EVENTOS ---
Â  document.getElementById('btnRegister').addEventListener('click', () => handleAuth('signup'));
Â  document.getElementById('btnLogin').addEventListener('click', () => handleAuth('signin'));
Â  document.getElementById('btnAddPlayer').addEventListener('click', addPlayer);
Â  document.getElementById('btnGenerateTeams').addEventListener('click', generateTeamOptions);
Â  document.getElementById('btnSelectAll').addEventListener('click', selectAllPlayers);
Â  document.getElementById('btnDeselectAll').addEventListener('click', deselectAllPlayers);
Â  document.getElementById('btnRefreshPolls').addEventListener('click', loadPolls);
Â  btnShare.addEventListener('click', shareFieldsImage);

Â  // --- FUNCIONES UTILIDAD ---
Â  function selectAllPlayers() { document.querySelectorAll('.p-select').forEach(c => c.checked = true); }
Â  function deselectAllPlayers() { document.querySelectorAll('.p-select').forEach(c => c.checked = false); }Â 
Â  function showError(msg) { generateError.textContent = msg; generateError.style.display = 'block'; }
Â  function shuffle(arr) { return [...arr].sort(() => Math.random() - 0.5); }
Â Â 
Â  // --- AUTH ---
Â  async function handleAuth(type) {Â 
Â  Â  const email = document.getElementById('authEmail').value.trim();
Â  Â  const password = document.getElementById('authPassword').value;
Â  Â Â 
Â  Â  authMsg.style.color = '#94a3b8';
Â  Â  if (!email || !password) return showMsg('âš ï¸ Rellena los datos');
Â  Â Â 
Â  Â  showMsg('â³ Conectando...');
Â  Â  let res = type === 'signup' ? await supabase.auth.signUp({ email, password }) : await supabase.auth.signInWithPassword({ email, password });

Â  Â  if (res.error) {
Â  Â  Â  Â  authMsg.style.color = '#ef4444';
Â  Â  Â  Â  showMsg(res.error.message);
Â  Â  } else {Â 
Â  Â  Â  Â  currentUser = res.data.user;Â 
Â  Â  Â  Â  showMsg('âœ… Â¡Vamos!');Â 
Â  Â  Â  Â  setTimeout(initApp, 500);
Â  Â  }
Â  }
Â  function showMsg(txt) { authMsg.textContent = txt; }
Â  async function initApp() { authBox.style.display = 'none'; appContent.classList.remove('hidden'); await loadPlayers(); await loadPolls(); }

Â  // --- JUGADORES Y LISTA ---
Â  async function loadPlayers() {Â 
Â  Â  if (!currentUser) return;
Â  Â  const { data } = await supabase.from('players').select('*').eq('user_id', currentUser.id);
Â  Â  allPlayers = data || [];
Â  Â  renderList();
Â  }

Â  // AÃ‘ADIR JUGADOR (AÃ‘ADIDO GENERACIÃ“N DE player_code)
Â  async function addPlayer() {Â 
Â  Â  const nameIn = document.getElementById('playerName');
Â  Â  const skillIn = document.getElementById('playerSkill');
Â  Â  const posIn = document.getElementById('playerPosition');
Â  Â Â 
Â  Â  const name = nameIn.value.trim();
Â  Â  const rating = parseFloat(skillIn.value);
Â  Â  const position = posIn.value;

Â  Â  if (!name || !rating) return alert('Datos incompletos');
Â  Â  
Â  Â  // --- LÃ“GICA DE GENERACIÃ“N DE player_code ---
Â  Â  const namePrefix = name.substring(0, 4).toUpperCase();
Â  Â  const randomNumber = Math.floor(Math.random() * 99) + 1;
Â  Â  const generatedCode = `${namePrefix}${randomNumber}`;
Â  Â Â 
Â  Â  const newPlayer = { user_id: currentUser.id, name, position, rating, player_code: generatedCode };

Â  Â  // 1. Insertar en Supabase
Â  Â  const { data, error } = await supabase.from('players').insert([newPlayer]).select();
Â  Â Â 
Â  Â  if (error) {
Â  Â  Â  Â  // Esto podrÃ­a ser un error de cÃ³digo duplicado, pero lo gestionamos con un mensaje simple
Â  Â  Â  Â  console.error('Error insertando en Supabase:', error);
Â  Â  Â  Â  alert(`Error al guardar el jugador. ${error.message}. Si es un cÃ³digo duplicado, intenta con un nombre diferente.`);
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  // 2. AÃ±adir a lista local y mostrar el cÃ³digo generado
Â  Â  if(data && data.length) {
Â  Â  Â  Â  allPlayers.push(data[0]);Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  alert(`Â¡Fichaje completado! Comparte este cÃ³digo con el jugador: ${generatedCode}`);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 3. Limpiar y renderizar
Â  Â  Â  Â  nameIn.value = '';Â 
Â  Â  Â  Â  skillIn.value = '';
Â  Â  Â  Â  renderList();
Â  Â  }
Â  }

Â  // ELIMINAR JUGADOR
Â  async function deletePlayer(playerId) {
Â  Â  Â  if (!playerId) return;
Â  Â  Â  if (!confirm("Â¿Eliminar jugador de la plantilla?")) return;
Â  Â  Â  const { error } = await supabase.from('players').delete().eq('id', String(playerId));
Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  console.error("Error al eliminar:", error);
Â  Â  Â  Â  Â  alert('Error al eliminar. ' + error.message);
Â  Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  allPlayers = allPlayers.filter(p => String(p.id) !== String(playerId));
Â  Â  Â  renderList();
Â  }

Â  function renderList() {Â 
Â  Â  playersListEl.innerHTML = '';
Â  Â  document.getElementById('playerCount').textContent = `(${allPlayers.length})`;
Â  Â  const order = { portero: 1, defensa: 2, delantero: 3 };
Â  Â Â 
Â  Â  [...allPlayers].sort((a,b) => order[a.position] - order[b.position] || b.rating - a.rating).forEach(p => {
Â  Â  Â  const playerId = p.id;Â 
Â  Â  Â  const isDisabled = !playerId;
Â  Â  Â Â 
Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  div.className = 'player-row';
Â  Â  Â  div.innerHTML = `
Â  Â  Â  Â  <div style="display:flex; align-items:center;">
Â  Â  Â  Â  Â  <input type="checkbox" class="p-select" checked value="${p.id}" ${isDisabled ? 'disabled' : ''}>
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â <span style="font-weight:600; font-size:1rem; color:#f1f5f9;">${p.name}</span>
Â  Â  Â  Â  Â  Â  Â <span class="tag ${p.position}">${p.position}</span>
              ${p.player_code ? `<span class="tag" style="background:#555; color:white; font-size:9px;">#${p.player_code}</span>` : ''}
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="display:flex; align-items:center; gap: 10px;">
Â  Â  Â  Â  Â  Â  <div class="rating-badge">${p.rating}</div>
Â  Â  Â  Â  Â  Â  <button class="outline delete-btn" data-id="${playerId}" style="border-color:#ef4444; color:#ef4444; padding: 4px 8px; font-size:0.7rem; width: auto; margin:0;" ${isDisabled ? 'disabled' : ''}>
Â  Â  Â  Â  Â  Â  Â  Â  ğŸ—‘ï¸
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  Â  `;
Â  Â  Â  playersListEl.appendChild(div);
Â  Â  });

Â  Â  document.querySelectorAll('.delete-btn').forEach(button => {
Â  Â  Â  Â  if (!button.disabled) {
Â  Â  Â  Â  Â  Â  button.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  const idToDelete = e.currentTarget.dataset.id;
Â  Â  Â  Â  Â  Â  Â  Â  if (idToDelete) deletePlayer(idToDelete);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  });
Â  }

Â  // --- GENERACIÃ“N DE EQUIPOS (Ahora genera 5) ---
Â  function generateTeamOptions() {Â 
Â  Â  generateError.style.display = 'none';
Â  Â  const checks = document.querySelectorAll('.p-select:checked');
Â  Â  const selectedIds = Array.from(checks).map(c => c.value);
Â  Â  const pool = allPlayers.filter(p => selectedIds.includes(String(p.id)));

Â  Â  if (pool.length < 14) { showError('Selecciona al menos 14 jugadores para 7vs7.'); return; }
Â  Â Â 
Â  Â  const count = (pos) => pool.filter(p => p.position === pos).length;
Â  Â  if (count('portero') < 2) { showError('Faltan Porteros. MÃ­nimo 2.'); return; }
Â  Â  if (count('defensa') < 6) { showError('Faltan Defensas. MÃ­nimo 6 (3 por equipo).'); return; }
Â  Â  if (count('delantero') < 2) { showError('Faltan Delanteros. MÃ­nimo 2 (1 por equipo).'); return; }

Â  Â  let variations = [];
Â  Â  const seenHashes = new Set();Â 

Â  Â  for(let i=0; i<1000; i++) { // Intentamos 1000 veces para tener mÃ¡s variaciones
Â  Â  Â  Â  const attempt = createStrictMatch(pool);
Â  Â  Â  Â  if(!attempt) continue;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const idsA = attempt.teamA.map(p => String(p.id)).sort().join('-');
Â  Â  Â  Â  const idsB = attempt.teamB.map(p => String(p.id)).sort().join('-');
Â  Â  Â  Â  const hash = [idsA, idsB].sort().join('::');

Â  Â  Â  Â  if(seenHashes.has(hash)) continue;Â 
Â  Â  Â  Â  seenHashes.add(hash);
Â  Â  Â  Â  variations.push(attempt);
Â  Â  }

Â  Â  variations.sort((a, b) => a.diff - b.diff);Â 
Â  Â  const top5 = variations.slice(0, 5); // Tomamos las 5 mejores
Â  Â Â 
Â  Â  if (top5.length === 0) { showError("Error generando combinaciones."); return; }
Â  Â  displayOptions(top5);
Â  }

Â  function createStrictMatch(originalPool) { /* ... lÃ³gica sin cambios ... */
Â  Â  const gks = shuffle(originalPool.filter(p => p.position === 'portero'));
Â  Â  const defs = shuffle(originalPool.filter(p => p.position === 'defensa'));
Â  Â  const fwds = shuffle(originalPool.filter(p => p.position === 'delantero'));

Â  Â  const teamA = []; const teamB = [];

Â  Â  teamA.push(gks.pop()); teamB.push(gks.pop());Â  Â  Â  Â  Â  Â 
Â  Â  for(let k=0;k<3;k++) { teamA.push(defs.pop()); teamB.push(defs.pop()); }Â 
Â  Â  teamA.push(fwds.pop()); teamB.push(fwds.pop());Â  Â  Â  Â Â 

Â  Â  let leftovers = [...gks, ...defs, ...fwds];Â 
Â  Â  leftovers = shuffle(leftovers);

Â  Â  while(leftovers.length > 0) {
Â  Â  Â  Â  // Aseguramos que ambos equipos tengan 7, si el pool es 14, se reparte hasta 7.
Â  Â  Â  Â  if(teamA.length < 7 && teamA.length <= teamB.length) teamA.push(leftovers.pop());
Â  Â  Â  Â  else if(teamB.length < 7 && teamA.length > teamB.length) teamB.push(leftovers.pop());
Â  Â  Â  Â  else if(teamA.length < 7) teamA.push(leftovers.pop()); // Si A < 7 y B = 7 (solo si hay mÃ¡s de 14)
Â  Â  Â  Â  else if(teamB.length < 7) teamB.push(leftovers.pop()); // Si B < 7 y A = 7 (solo si hay mÃ¡s de 14)
Â  Â  Â  Â  else break; // Si ambos tienen 7 y aÃºn hay left-overs, paramos aquÃ­
Â  Â  }
Â  Â  
Â  Â  // Filtramos los que no entraron
Â  Â  const finalA = teamA.filter(p => p);
Â  Â  const finalB = teamB.filter(p => p);
Â  Â  
Â  Â  if(finalA.length === 0 || finalB.length === 0) return null; // Prevenir equipos vacÃ­os

Â  Â  const getAvg = t => t.reduce((a,c)=>a+c.rating,0) / t.length;
Â  Â  const avgA = getAvg(finalA); const avgB = getAvg(finalB);

Â  Â  return { 
Â  Â  Â  Â  teamA: finalA, 
Â  Â  Â  Â  teamB: finalB, 
Â  Â  Â  Â  avgA: avgA.toFixed(2), 
Â  Â  Â  Â  avgB: avgB.toFixed(2), 
Â  Â  Â  Â  diff: Math.abs(avgA - avgB) 
Â  Â  };
Â  }
Â Â 
Â  // MOSTRAR OPCIONES (AÃ±adido checkbox y botÃ³n de votaciÃ³n)
Â  function displayOptions(options) {
Â  Â  teamsResultEl.innerHTML = '';
Â  Â  
Â  Â  options.forEach((opt, index) => {
Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  div.className = 'option-card';
Â  Â  Â  Â  div.dataset.optionIndex = index + 1;
Â  Â  Â  Â  
Â  Â  Â  Â  // Checkbox para seleccionar la opciÃ³n
Â  Â  Â  Â  div.innerHTML = `
Â  Â  Â  Â  Â  Â  <input type="checkbox" class="poll-select-check" data-team-data='${JSON.stringify(opt)}' />
Â  Â  Â  Â  Â  Â  <div style="display:flex; justify-content:space-between; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px; margin-bottom:10px;">
Â  Â  Â  Â  Â  Â  Â  Â  <h4 style="margin:0; color:var(--primary);">OpciÃ³n ${index + 1}</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <span class="tag" style="background:#334155; color:#fff;">Dif: ${opt.diff.toFixed(2)}</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="team-columns">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="team-col"><strong style="color:#94a3b8">Negro (${opt.avgA})</strong><ul>${renderListSimple(opt.teamA)}</ul></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="team-col"><strong style="color:#f1f5f9">Blanco (${opt.avgB})</strong><ul>${renderListSimple(opt.teamB)}</ul></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button class="outline select-opt-btn" style="margin-top:15px; width:100%; border-color:var(--accent); color:var(--accent);" data-index="${index+1}">Ver en Pizarra</button>
Â  Â  Â  Â  `;
Â  Â  Â  Â  teamsResultEl.appendChild(div);
Â  Â  });
Â  Â  
Â  Â  // BotÃ³n para crear votaciÃ³n
Â  Â  const createPollBtn = document.createElement('button');
Â  Â  createPollBtn.className = 'primary';
Â  Â  createPollBtn.textContent = 'ğŸš€ Crear VotaciÃ³n con 3 Seleccionadas';
Â  Â  createPollBtn.id = 'btnCreatePoll';
Â  Â  createPollBtn.addEventListener('click', createPoll);
Â  Â  teamsResultEl.appendChild(createPollBtn);

Â  Â  // Evento para ver en pizarra (solo visualizaciÃ³n)
Â  Â  document.querySelectorAll('.select-opt-btn').forEach(button => {
Â  Â  Â  Â  button.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  const teamData = JSON.parse(e.currentTarget.closest('.option-card').querySelector('.poll-select-check').dataset.teamData);
Â  Â  Â  Â  Â  Â  activePollId = null; // No hay poll activo para editar
Â  Â  Â  Â  Â  Â  document.getElementById('fieldPollName').textContent = `OpciÃ³n ${e.currentTarget.dataset.index} (Vista Previa)`;
Â  Â  Â  Â  Â  Â  displayField(teamData.teamA, teamData.teamB);
Â  Â  Â  Â  });
Â  Â  });
Â  }

Â  function renderListSimple(t) {
Â  Â  const order={portero:0,defensa:1,delantero:2};
Â  Â  return [...t].sort((a,b)=>order[a.position]-order[b.position]).map(p=>`<li><span>${p.name}</span><span style="font-size:0.7rem;opacity:0.7;">${p.position.substring(0,3).toUpperCase()}</span></li>`).join('');
Â  }

Â  // --- GESTIÃ“N DE VOTACIONES ---
Â  async function createPoll() {
Â  Â  const selectedOptions = Array.from(document.querySelectorAll('.poll-select-check:checked'));
Â  Â  if (selectedOptions.length !== 3) {
Â  Â  Â  Â  return alert('Debes seleccionar exactamente 3 opciones para crear la votaciÃ³n.');
Â  Â  }

Â  Â  const pollName = prompt('Introduce un nombre para la votaciÃ³n (Ej: Partido 26 Nov):');
Â  Â  if (!pollName) return;

Â  Â  const optionsData = selectedOptions.map(c => JSON.parse(c.dataset.teamData));
Â  Â Â 
Â  Â  // Creamos el objeto para insertar
Â  Â  const newPoll = {
Â  Â  Â  Â  mister_id: currentUser.id,
Â  Â  Â  Â  status: 'open',
Â  Â  Â  Â  poll_name: pollName, // AÃ±adiremos esta columna a Supabase para mejorar el dashboard
Â  Â  Â  Â  option_1: optionsData[0],
Â  Â  Â  Â  option_2: optionsData[1],
Â  Â  Â  Â  option_3: optionsData[2],
Â  Â  };

Â  Â  const { data, error } = await supabase.from('polls').insert([newPoll]).select();

Â  Â  if (error) {
Â  Â  Â  Â  console.error('Error al crear votaciÃ³n:', error);
Â  Â  Â  Â  return alert('Error al guardar la votaciÃ³n. ' + error.message);
Â  Â  }

Â  Â  const pollId = data[0].id;
Â  Â  const shareLink = `${window.location.origin}/votar.html?id=${pollId}`;
Â  Â  alert(`âœ… Â¡VotaciÃ³n Creada! Copia el enlace para compartir con los jugadores:\n\n${shareLink}`);
Â  Â  
Â  Â  // Limpiamos la secciÃ³n de resultados y recargamos el dashboard
Â  Â  teamsResultEl.innerHTML = '';
Â  Â  loadPolls();
Â  }

Â  async function loadPolls() {
Â  Â  pollDashboardEl.innerHTML = '<p style="color:var(--text-muted); font-size:0.8rem;">Cargando...</p>';
Â  Â  const { data: polls, error } = await supabase.from('polls')
Â  Â  Â  .select('*, votes(count)')
Â  Â  Â  .eq('mister_id', currentUser.id)
Â  Â  Â  .order('created_at', { ascending: false });

Â  Â  if (error) {
Â  Â  Â  Â  pollDashboardEl.innerHTML = `<p style="color:#fca5a5;">Error al cargar: ${error.message}</p>`;
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  if (polls.length === 0) {
Â  Â  Â  Â  pollDashboardEl.innerHTML = `<p style="color:var(--text-muted);">AÃºn no has creado ninguna votaciÃ³n.</p>`;
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  pollDashboardEl.innerHTML = '';
Â  Â  polls.forEach(p => {
Â  Â  Â  Â  const totalVotes = p.votes[0].count;
Â  Â  Â  Â  const statusTag = p.status === 'open' ? `<span class="poll-status-tag poll-status-open">Abierta (${totalVotes} votos)</span>` : `<span class="poll-status-tag poll-status-closed">CERRADA</span>`;
Â  Â  Â  Â  const pollName = p.poll_name || `VotaciÃ³n sin nombre (${new Date(p.created_at).toLocaleDateString()})`;
Â  Â  Â  Â  
Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  div.className = 'poll-card';
Â  Â  Â  Â  div.innerHTML = `
Â  Â  Â  Â  Â  Â  <div class="poll-info">
Â  Â  Â  Â  Â  Â  Â  Â  <strong style="color:var(--primary);">${pollName}</strong>
Â  Â  Â  Â  Â  Â  Â  Â  ${statusTag}
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="poll-actions">
Â  Â  Â  Â  Â  Â  Â  Â  ${p.status === 'open' ? `<button class="poll-action close-poll-btn" data-id="${p.id}" data-votes="${totalVotes}">Cerrar & Ganador</button>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  <button class="poll-action view-poll-btn" style="background:#475569;" data-id="${p.id}" data-name="${pollName}" data-winning-option="${p.winning_option || 1}">Ver Pizarra</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  Â  Â  pollDashboardEl.appendChild(div);
Â  Â  });
Â  Â  
Â  Â  document.querySelectorAll('.close-poll-btn').forEach(b => b.addEventListener('click', (e) => closePoll(e.currentTarget.dataset.id, e.currentTarget.dataset.votes)));
Â  Â  document.querySelectorAll('.view-poll-btn').forEach(b => b.addEventListener('click', (e) => viewPollInField(e.currentTarget.dataset.id, e.currentTarget.dataset.name, e.currentTarget.dataset.winningOption)));

Â  }

Â  async function closePoll(pollId, totalVotes) {
Â  Â  if (!confirm(`EstÃ¡s a punto de cerrar la votaciÃ³n. Â¿Deseas continuar? (${totalVotes} votos registrados)`)) return;

Â  Â  // 1. Contar votos
Â  Â  const { data: voteCounts, error: voteError } = await supabase.from('votes')
Â  Â  Â  .select('voted_for_option, count')
Â  Â  Â  .eq('poll_id', pollId)
Â  Â  Â  .rollup();

Â  Â  if (voteError) return alert('Error al contar votos: ' + voteError.message);
Â  Â  
Â  Â  // Determinar el ganador
Â  Â  let winner = 1;
Â  Â  let maxVotes = 0;
Â  Â  voteCounts.forEach(c => {
Â  Â  Â  Â  if (c.count > maxVotes) {
Â  Â  Â  Â  Â  Â  maxVotes = c.count;
Â  Â  Â  Â  Â  Â  winner = c.voted_for_option;
Â  Â  Â  Â  }
Â  Â  });
Â  Â  if (maxVotes === 0) winner = 1; // Si no hay votos, por defecto la OpciÃ³n 1

Â  Â  // 2. Cerrar el poll en la DB
Â  Â  const { error: closeError } = await supabase.from('polls')
Â  Â  Â  .update({ status: 'closed', winning_option: winner })
Â  Â  Â  .eq('id', pollId);

Â  Â  if (closeError) return alert('Error al cerrar la votaciÃ³n: ' + closeError.message);
Â  Â  
Â  Â  alert(`âœ… VotaciÃ³n Cerrada. La OpciÃ³n ganadora es la nÃºmero ${winner} con ${maxVotes} votos.`);
Â  Â  loadPolls(); // Recargar el dashboard
Â  }

Â  async function viewPollInField(pollId, pollName, winningOption) {
Â  Â  activePollId = pollId;
Â  Â  document.getElementById('fieldPollName').textContent = pollName;

Â  Â  // 1. Obtener la votaciÃ³n
Â  Â  const { data: poll, error } = await supabase.from('polls').select('*').eq('id', pollId).single();
Â  Â  if (error || !poll) return alert('Error al cargar la votaciÃ³n.');

Â  Â  const winnerKey = `option_${winningOption}`;
Â  Â  const winningTeams = poll[winnerKey];

Â  Â  if (!winningTeams) return alert(`No se encontrÃ³ la OpciÃ³n ${winningOption} para esta votaciÃ³n.`);

Â  Â  // 2. Cargar las posiciones guardadas, si existen
Â  Â  let positions = null;
Â  Â  if (poll.tactics_board_state && poll.tactics_board_state.length > 0) {
Â  Â  Â  Â  positions = poll.tactics_board_state;
Â  Â  }
Â  Â  
Â  Â  // 3. Mostrar la pizarra
Â  Â  displayField(winningTeams.teamA, winningTeams.teamB, positions);

Â  Â  setTimeout(() => { document.getElementById('fieldSection').scrollIntoView({behavior: "smooth"}); }, 100);
Â  }
Â  
Â  // --- PIZARRA TÃCTICA Y DRAG & DROP (MODIFICADO PARA GUARDAR) ---

Â  function displayField(teamA, teamB, initialPositions = null) {
Â  Â  document.getElementById('fieldSection').classList.remove('hidden');
Â  Â  fullField.querySelectorAll('.player-token').forEach(e => e.remove());
Â  Â  
Â  Â  drawTeamOnUnifiedField(teamA, 'token-black', 'bottom', initialPositions);Â 
Â  Â  drawTeamOnUnifiedField(teamB, 'token-white', 'top', initialPositions);Â  Â Â 
Â  }

Â  function drawTeamOnUnifiedField(team, colorClass, half, initialPositions) {
Â  Â  const isBottomHalf = half === 'bottom';
Â  Â  // Coordenadas fijas OBLIGATORIAS (Esqueleto 1-3-1)
Â  Â  const coordsFixed = {
Â  Â  Â  Â  portero:Â  Â [{x:140, y: isBottomHalf ? 520 : 40}],Â 
Â  Â  Â  Â  defensa:Â  Â [
Â  Â  Â  Â  Â  Â  {x:50, y: isBottomHalf ? 450 : 100},Â 
Â  Â  Â  Â  Â  Â  {x:140, y: isBottomHalf ? 450 : 100},Â 
Â  Â  Â  Â  Â  Â  {x:230, y: isBottomHalf ? 450 : 100}
Â  Â  Â  Â  ],Â 
Â  Â  Â  Â  delantero: [{x:140, y: isBottomHalf ? 350 : 200}]Â 
Â  Â  };
Â  Â  const slots = JSON.parse(JSON.stringify(coordsFixed));
Â  Â Â 
Â  Â  const fillerPositions = { /* ... (mismo cÃ³digo de relleno) ... */
Â  Â  Â  Â  delantero: [Â 
Â  Â  Â  Â  Â  Â  {x: 80, y: isBottomHalf ? 380 : 220},
Â  Â  Â  Â  Â  Â  {x: 200, y: isBottomHalf ? 380 : 220},
Â  Â  Â  Â  Â  Â  {x: 140, y: isBottomHalf ? 400 : 200},
Â  Â  Â  Â  ],
Â  Â  Â  Â  defensa: [Â 
Â  Â  Â  Â  Â  Â  {x: 50, y: isBottomHalf ? 490 : 60},Â 
Â  Â  Â  Â  Â  Â  {x: 230, y: isBottomHalf ? 490 : 60},Â 
Â  Â  Â  Â  ]
Â  Â  };
Â  Â  const usedFillerSpots = { delantero: 0, defensa: 0 };
Â  Â Â 
Â  Â  team.forEach(p => {
Â  Â  Â  Â  let pos = {x: 0, y: 0};
        
        // 1. Verificar si hay posiciÃ³n guardada (solo si se estÃ¡ editando una votaciÃ³n)
        const savedPos = initialPositions ? initialPositions.find(ip => ip.id === String(p.id)) : null;

        if (savedPos) {
            pos = {x: savedPos.x, y: savedPos.y};
        } else {
            // 2. Usar lÃ³gica de posiciÃ³n inicial si no hay posiciÃ³n guardada
            if (slots[p.position] && slots[p.position].length > 0) {
                pos = slots[p.position].shift();
            } else if (p.position === 'delantero' && usedFillerSpots.delantero < fillerPositions.delantero.length) {
                pos = fillerPositions.delantero[usedFillerSpots.delantero];
                usedFillerSpots.delantero++;
            } else if (p.position === 'defensa' && usedFillerSpots.defensa < fillerPositions.defensa.length) {
                pos = fillerPositions.defensa[usedFillerSpots.defensa];
                usedFillerSpots.defensa++;
            } else {
                const yCenter = isBottomHalf ? 300 + Math.random() * 50 : 250 + Math.random() * 50;
                pos = {x: 60 + Math.random() * 200, y: yCenter};
            }
        }
Â  Â  Â  Â Â 
Â  Â  Â  Â  createToken(p, fullField, colorClass, pos.x, pos.y);
Â  Â  });
Â  }

Â  // FunciÃ³n para actualizar la DB (llamada al finalizar un drag)
Â  async function updateTacticsBoardState() {
Â  Â  if (!activePollId) {
Â  Â  Â  Â  console.log("ModificaciÃ³n de pizarra no guardada: No hay votaciÃ³n activa seleccionada.");
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const newPositions = [];
Â  Â  fullField.querySelectorAll('.player-token').forEach(token => {
Â  Â  Â  Â  newPositions.push({
Â  Â  Â  Â  Â  Â  id: token.dataset.playerId,
Â  Â  Â  Â  Â  Â  x: parseFloat(token.style.left),
Â  Â  Â  Â  Â  Â  y: parseFloat(token.style.top),
Â  Â  Â  Â  });
Â  Â  });
Â  Â  
Â  Â  // Guardar en Supabase (esto es lo que los jugadores verÃ¡n en tiempo real)
Â  Â  const { error } = await supabase.from('polls')
Â  Â  Â  .update({ tactics_board_state: newPositions })
Â  Â  Â  .eq('id', activePollId);

Â  Â  if (error) console.error("Error al guardar la pizarra:", error);
Â  Â  else console.log("Pizarra guardada y actualizada en tiempo real.");
Â  }

Â  function createToken(p, div, cls, x, y) {
Â  Â  const el = document.createElement('div');
Â  Â  el.className = `player-token ${cls}`;
    el.dataset.playerId = p.id; // Clave para guardar la posiciÃ³n
Â  Â  el.textContent = p.name.substring(0,2).toUpperCase();
Â  Â  el.style.left = x+'px'; el.style.top = y+'px';
Â  Â  const l = document.createElement('div'); l.className='player-label'; l.textContent=p.name;
Â  Â  el.appendChild(l);
Â  Â Â 
Â  Â  el.addEventListener('mousedown', startDrag);
Â  Â  el.addEventListener('touchstart', startDrag, {passive: false});
Â  Â  div.appendChild(el);
Â  }

Â  // LÃ³gica Drag & Drop
Â  let activeItem = null; let activeContainer = null;
Â  let initialX, initialY, xOffset = 0, yOffset = 0;

Â  function startDrag(e) {
Â  Â  const evt = e.type === 'touchstart' ? e.touches[0] : e;
Â  Â  initialX = evt.clientX - xOffset; initialY = evt.clientY - yOffset;
Â  Â  activeItem = e.currentTarget;
Â  Â  activeContainer = activeItem.parentElement;
Â  Â Â 
Â  Â  const rect = activeItem.getBoundingClientRect();
Â  Â  const parentRect = activeContainer.getBoundingClientRect();
Â  Â  const offsetX = evt.clientX - rect.left;
Â  Â  const offsetY = evt.clientY - rect.top;
Â  Â Â 
Â  Â  const moveHandler = (moveEvent) => {
Â  Â  Â  Â  moveEvent.preventDefault();Â 
Â  Â  Â  Â  const mv = moveEvent.type === 'touchmove' ? moveEvent.touches[0] : moveEvent;
Â  Â  Â  Â Â 
Â  Â  Â  Â  let newLeft = mv.clientX - parentRect.left - offsetX;
Â  Â  Â  Â  let newTop = mv.clientY - parentRect.top - offsetY;
Â  Â  Â  Â Â 
Â  Â  Â  Â  newLeft = Math.max(0, Math.min(newLeft, 320 - 42));Â 
Â  Â  Â  Â  newTop = Math.max(0, Math.min(newTop, 600 - 42));
Â  Â  Â  Â Â 
Â  Â  Â  Â  activeItem.style.left = newLeft + 'px'; activeItem.style.top = newTop + 'px';
Â  Â  };
Â  Â Â 
Â  Â  const upHandler = () => {
Â  Â  Â  Â  document.removeEventListener('mousemove', moveHandler); document.removeEventListener('mouseup', upHandler);
Â  Â  Â  Â  document.removeEventListener('touchmove', moveHandler); document.removeEventListener('touchend', upHandler);
Â  Â  Â  Â  if (activeItem) {
            // Llama a la funciÃ³n de guardado despuÃ©s de que el drag ha terminado
            updateTacticsBoardState();
        }
Â  Â  Â  Â  activeItem = null;
Â  Â  };
Â  Â  document.addEventListener('mousemove', moveHandler); document.addEventListener('mouseup', upHandler);
Â  Â  document.addEventListener('touchmove', moveHandler, {passive: false}); document.addEventListener('touchend', upHandler);
Â  }

Â  async function shareFieldsImage() {
Â  Â  const element = document.getElementById('captureArea');
Â  Â  const originalText = btnShare.innerHTML;
Â  Â  btnShare.innerHTML = "âš¡ Generando..."; btnShare.disabled = true;
Â  Â Â 
Â  Â  try {
Â  Â  Â  Â  const canvas = await html2canvas(element, { backgroundColor: '#e2e8f0', scale: 2, useCORS: true });
Â  Â  Â  Â  canvas.toBlob(async (blob) => {
Â  Â  Â  Â  Â  Â  const file = new File([blob], 'partido-f7.png', { type: 'image/png' });
Â  Â  Â  Â  Â  Â  if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
Â  Â  Â  Â  Â  Â  Â  Â  try { await navigator.share({ files: [file], title: 'AlineaciÃ³n', text: 'AquÃ­ estÃ¡n los equipos âš½' }); } catch (err) {}
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  const link = document.createElement('a'); link.download = 'alineacion.png'; link.href = canvas.toDataURL(); link.click();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  btnShare.innerHTML = originalText; btnShare.disabled = false;
Â  Â  Â  Â  });
Â  Â  } catch (e) { alert("Error al crear imagen"); btnShare.innerHTML = originalText; btnShare.disabled = false; }
Â  }
});
</script>
</body>
</html>
